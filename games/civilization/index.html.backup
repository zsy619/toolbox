<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ–‡æ˜å»ºè®¾ - å›åˆç­–ç•¥æ¸¸æˆ</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Microsoft YaHei', Arial, sans-serif;
            background: linear-gradient(135deg, #8B4513 0%, #CD853F 50%, #DAA520 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }

        .game-container {
            background: white;
            border-radius: 20px;
            padding: 20px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.2);
            max-width: 1400px;
            width: 100%;
        }

        h1 {
            text-align: center;
            color: #8B4513;
            margin-bottom: 20px;
            font-size: 2.5rem;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.1);
        }

        .game-info {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .info-card {
            background: #FFF8DC;
            padding: 12px;
            border-radius: 12px;
            text-align: center;
            border: 2px solid #DAA520;
        }

        .info-label {
            color: #8B4513;
            font-size: 0.8rem;
            margin-bottom: 5px;
            font-weight: bold;
        }

        .info-value {
            color: #4A4A4A;
            font-size: 1.1rem;
            font-weight: bold;
        }

        .controls {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        button {
            background: #8B4513;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 20px;
            cursor: pointer;
            font-size: 0.9rem;
            font-weight: bold;
            transition: all 0.3s ease;
        }

        button:hover {
            background: #A0522D;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }

        button:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
        }

        .game-board {
            display: grid;
            grid-template-columns: 2fr 1fr 1fr;
            gap: 20px;
            margin: 20px 0;
            min-height: 600px;
        }

        .map-section {
            background: #F0E68C;
            border-radius: 15px;
            padding: 15px;
            border: 2px solid #DAA520;
        }

        .section-title {
            text-align: center;
            color: #8B4513;
            font-weight: bold;
            margin-bottom: 15px;
            font-size: 1.2rem;
        }

        .city-grid {
            display: grid;
            grid-template-columns: repeat(8, 1fr);
            grid-template-rows: repeat(6, 1fr);
            gap: 2px;
            height: 360px;
            background: #DAA520;
            border-radius: 10px;
            padding: 8px;
        }

        .tile {
            background: #90EE90;
            border-radius: 6px;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 0.8rem;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            border: 2px solid transparent;
        }

        .tile:hover {
            transform: scale(1.1);
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }

        .tile.selected {
            border-color: #FF6B35;
            background: #FFE4B5;
        }

        .tile.forest { background: #228B22; }
        .tile.mountain { background: #696969; color: white; }
        .tile.water { background: #4682B4; color: white; }
        .tile.desert { background: #F4A460; }
        .tile.plains { background: #9ACD32; }

        .building {
            position: absolute;
            width: 80%;
            height: 80%;
            border-radius: 4px;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 0.7rem;
            font-weight: bold;
            color: white;
        }

        .building.city { background: #8B4513; }
        .building.farm { background: #32CD32; }
        .building.mine { background: #708090; }
        .building.lumber { background: #8B4513; }
        .building.barracks { background: #B22222; }
        .building.library { background: #4169E1; }

        .resources-section {
            background: #FFF8DC;
            border-radius: 15px;
            padding: 15px;
            border: 2px solid #DAA520;
        }

        .resource-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px;
            margin: 5px 0;
            background: white;
            border-radius: 8px;
            border: 1px solid #DAA520;
        }

        .resource-name {
            font-weight: bold;
            color: #8B4513;
        }

        .resource-value {
            color: #4A4A4A;
            font-weight: bold;
        }

        .resource-change {
            font-size: 0.8rem;
            color: #27ae60;
        }

        .resource-change.negative {
            color: #e74c3c;
        }

        .buildings-section {
            background: #FFF8DC;
            border-radius: 15px;
            padding: 15px;
            border: 2px solid #DAA520;
        }

        .building-item {
            background: white;
            border-radius: 8px;
            padding: 10px;
            margin: 8px 0;
            border: 2px solid #DAA520;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .building-item:hover {
            transform: scale(1.02);
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .building-item.affordable {
            border-color: #27ae60;
        }

        .building-item.expensive {
            border-color: #e74c3c;
            opacity: 0.7;
        }

        .building-name {
            font-weight: bold;
            color: #8B4513;
            margin-bottom: 5px;
        }

        .building-cost {
            font-size: 0.8rem;
            color: #666;
        }

        .building-effect {
            font-size: 0.8rem;
            color: #27ae60;
            margin-top: 5px;
        }

        .tech-tree {
            background: #E6E6FA;
            border-radius: 15px;
            padding: 15px;
            border: 2px solid #9370DB;
            margin-top: 15px;
        }

        .tech-item {
            background: white;
            border-radius: 8px;
            padding: 8px;
            margin: 5px 0;
            border: 2px solid #9370DB;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .tech-item:hover {
            transform: scale(1.02);
        }

        .tech-item.researched {
            background: #E6E6FA;
            border-color: #32CD32;
        }

        .tech-item.affordable {
            border-color: #27ae60;
        }

        .tech-item.expensive {
            border-color: #e74c3c;
            opacity: 0.7;
        }

        .turn-info {
            background: #F0E68C;
            border-radius: 15px;
            padding: 15px;
            margin-top: 15px;
            text-align: center;
            border: 2px solid #DAA520;
        }

        .turn-counter {
            font-size: 1.5rem;
            font-weight: bold;
            color: #8B4513;
            margin-bottom: 10px;
        }

        .turn-actions {
            display: flex;
            gap: 10px;
            justify-content: center;
            flex-wrap: wrap;
        }

        .action-btn {
            background: #CD853F;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 15px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: all 0.3s ease;
        }

        .action-btn:hover {
            background: #B8860B;
        }

        .action-btn:disabled {
            background: #ccc;
            cursor: not-allowed;
        }

        .popup-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.8);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .popup-content {
            background: white;
            padding: 30px;
            border-radius: 20px;
            text-align: center;
            animation: popupAppear 0.3s ease-out;
            border: 3px solid #8B4513;
            max-width: 500px;
            width: 90%;
        }

        @keyframes popupAppear {
            0% { transform: scale(0.5); opacity: 0; }
            100% { transform: scale(1); opacity: 1; }
        }

        .achievement {
            background: #fff3cd;
            border: 2px solid #ffeaa7;
            color: #856404;
            padding: 10px;
            border-radius: 10px;
            margin: 10px 0;
            text-align: center;
        }

        .progress-bar {
            background: #e0e0e0;
            height: 8px;
            border-radius: 4px;
            margin: 5px 0;
            overflow: hidden;
        }

        .progress-fill {
            background: #27ae60;
            height: 100%;
            transition: width 0.3s ease;
        }

        @media (max-width: 768px) {
            .game-container {
                padding: 15px;
            }
            
            h1 {
                font-size: 2rem;
            }
            
            .game-board {
                grid-template-columns: 1fr;
                gap: 15px;
            }
            
            .city-grid {
                grid-template-columns: repeat(6, 1fr);
                grid-template-rows: repeat(4, 1fr);
                height: 240px;
            }
            
            .game-info {
                grid-template-columns: repeat(3, 1fr);
            }
        }
    </style>
</head>
<body>
    <div class="game-container">
        <h1>ğŸ›ï¸ æ–‡æ˜å»ºè®¾ ğŸ›ï¸</h1>
        
        <div class="game-info">
            <div class="info-card">
                <div class="info-label">å›åˆ</div>
                <div class="info-value" id="currentTurn">1</div>
            </div>
            <div class="info-card">
                <div class="info-label">äººå£</div>
                <div class="info-value" id="population">100</div>
            </div>
            <div class="info-card">
                <div class="info-label">é£Ÿç‰©</div>
                <div class="info-value" id="food">50</div>
            </div>
            <div class="info-card">
                <div class="info-label">æœ¨æ</div>
                <div class="info-value" id="wood">30</div>
            </div>
            <div class="info-card">
                <div class="info-label">çŸ³æ–™</div>
                <div class="info-value" id="stone">20</div>
            </div>
            <div class="info-card">
                <div class="info-label">ç§‘æŠ€ç‚¹</div>
                <div class="info-value" id="science">10</div>
            </div>
        </div>

        <div class="controls">
            <button id="newGameBtn" onclick="civilization.newGame()">æ–°æ¸¸æˆ</button>
            <button id="nextTurnBtn" onclick="civilization.nextTurn()">ä¸‹ä¸€å›åˆ</button>
            <button id="saveBtn" onclick="civilization.saveGame()">ä¿å­˜æ¸¸æˆ</button>
            <button id="loadBtn" onclick="civilization.loadGame()">åŠ è½½æ¸¸æˆ</button>
            <button id="statsBtn" onclick="civilization.showStats()">ç»Ÿè®¡ä¿¡æ¯</button>
        </div>

        <div class="game-board">
            <div class="map-section">
                <div class="section-title">æ–‡æ˜åœ°å›¾</div>
                <div class="city-grid" id="cityGrid"></div>
                <div style="margin-top: 10px; font-size: 0.9rem; color: #8B4513;">
                    é€‰ä¸­åœ°å—: <span id="selectedTile">æ— </span>
                </div>
            </div>

            <div class="resources-section">
                <div class="section-title">èµ„æºçŠ¶å†µ</div>
                <div id="resourcesContainer">
                    <div class="resource-item">
                        <span class="resource-name">é£Ÿç‰©</span>
                        <span class="resource-value" id="foodDisplay">50</span>
                        <span class="resource-change" id="foodChange">+5/å›åˆ</span>
                    </div>
                    <div class="resource-item">
                        <span class="resource-name">æœ¨æ</span>
                        <span class="resource-value" id="woodDisplay">30</span>
                        <span class="resource-change" id="woodChange">+3/å›åˆ</span>
                    </div>
                    <div class="resource-item">
                        <span class="resource-name">çŸ³æ–™</span>
                        <span class="resource-value" id="stoneDisplay">20</span>
                        <span class="resource-change" id="stoneChange">+2/å›åˆ</span>
                    </div>
                    <div class="resource-item">
                        <span class="resource-name">ç§‘æŠ€ç‚¹</span>
                        <span class="resource-value" id="scienceDisplay">10</span>
                        <span class="resource-change" id="scienceChange">+1/å›åˆ</span>
                    </div>
                </div>

                <div class="tech-tree">
                    <div class="section-title">ç§‘æŠ€æ ‘</div>
                    <div id="techContainer"></div>
                </div>
            </div>

            <div class="buildings-section">
                <div class="section-title">å»ºç­‘</div>
                <div id="buildingsContainer"></div>
                
                <div class="turn-info">
                    <div class="turn-counter">ç¬¬ <span id="turnDisplay">1</span> å›åˆ</div>
                    <div class="turn-actions">
                        <button class="action-btn" onclick="civilization.autoPlay()">è‡ªåŠ¨å‘å±•</button>
                        <button class="action-btn" onclick="civilization.showProgress()">å‘å±•è¿›åº¦</button>
                    </div>
                </div>
            </div>
        </div>

        <div id="achievement" class="achievement" style="display: none;"></div>
    </div>

    <div class="popup-modal" id="buildingModal">
        <div class="popup-content">
            <h3>å»ºé€ å»ºç­‘</h3>
            <div id="buildingDetails"></div>
            <div style="margin-top: 20px;">
                <button onclick="civilization.confirmBuilding()">ç¡®è®¤å»ºé€ </button>
                <button onclick="civilization.closeBuildingModal()">å–æ¶ˆ</button>
            </div>
        </div>
    </div>

    <div class="popup-modal" id="techModal">
        <div class="popup-content">
            <h3>ç ”ç©¶ç§‘æŠ€</h3>
            <div id="techDetails"></div>
            <div style="margin-top: 20px;">
                <button onclick="civilization.confirmTech()">ç¡®è®¤ç ”ç©¶</button>
                <button onclick="civilization.closeTechModal()">å–æ¶ˆ</button>
            </div>
        </div>
    </div>

    <div class="popup-modal" id="infoModal">
        <div class="popup-content">
            <h3 id="infoTitle">ä¿¡æ¯</h3>
            <div id="infoContent"></div>
            <div style="margin-top: 20px;">
                <button onclick="civilization.closeInfoModal()">ç¡®å®š</button>
            </div>
        </div>
    </div>

    <script>
        class CivilizationGame {
            constructor() {
                this.turn = 1;
                this.resources = {
                    food: 50,
                    wood: 30,
                    stone: 20,
                    science: 10,
                    population: 100
                };
                
                this.resourcesPerTurn = {
                    food: 5,
                    wood: 3,
                    stone: 2,
                    science: 1
                };
                
                this.map = [];
                this.selectedTile = null;
                this.selectedBuilding = null;
                this.selectedTech = null;
                
                this.buildings = [
                    { 
                        id: 'farm', 
                        name: 'å†œåœº', 
                        cost: { food: 0, wood: 10, stone: 5 }, 
                        effect: { food: 3 },
                        description: 'å¢åŠ é£Ÿç‰©äº§é‡',
                        terrain: ['plains', 'forest']
                    },
                    { 
                        id: 'lumber', 
                        name: 'ä¼æœ¨åœº', 
                        cost: { food: 5, wood: 0, stone: 5 }, 
                        effect: { wood: 3 },
                        description: 'å¢åŠ æœ¨æäº§é‡',
                        terrain: ['forest']
                    },
                    { 
                        id: 'mine', 
                        name: 'é‡‡çŸ³åœº', 
                        cost: { food: 10, wood: 15, stone: 0 }, 
                        effect: { stone: 4 },
                        description: 'å¢åŠ çŸ³æ–™äº§é‡',
                        terrain: ['mountain', 'desert']
                    },
                    { 
                        id: 'barracks', 
                        name: 'å…µè¥', 
                        cost: { food: 20, wood: 25, stone: 30 }, 
                        effect: { population: 20 },
                        description: 'å¢åŠ äººå£ä¸Šé™',
                        terrain: ['plains', 'desert']
                    },
                    { 
                        id: 'library', 
                        name: 'å›¾ä¹¦é¦†', 
                        cost: { food: 30, wood: 40, stone: 25 }, 
                        effect: { science: 3 },
                        description: 'å¢åŠ ç§‘æŠ€ç‚¹äº§é‡',
                        terrain: ['plains']
                    },
                    { 
                        id: 'city', 
                        name: 'åŸå¸‚', 
                        cost: { food: 50, wood: 60, stone: 80 }, 
                        effect: { food: 5, wood: 3, stone: 2, science: 2, population: 50 },
                        description: 'ç»¼åˆå‘å±•åŸå¸‚',
                        terrain: ['plains', 'forest']
                    }
                ];
                
                this.technologies = [
                    { 
                        id: 'agriculture', 
                        name: 'å†œä¸š', 
                        cost: { science: 20 }, 
                        effect: { food: 2 },
                        description: 'æé«˜å†œä¸šäº§é‡',
                        researched: false
                    },
                    { 
                        id: 'woodworking', 
                        name: 'æœ¨å·¥æŠ€æœ¯', 
                        cost: { science: 25 }, 
                        effect: { wood: 2 },
                        description: 'æé«˜æœ¨æåˆ©ç”¨æ•ˆç‡',
                        researched: false
                    },
                    { 
                        id: 'mining', 
                        name: 'é‡‡çŸ¿æŠ€æœ¯', 
                        cost: { science: 30 }, 
                        effect: { stone: 3 },
                        description: 'æé«˜çŸ³æ–™å¼€é‡‡æ•ˆç‡',
                        researched: false
                    },
                    { 
                        id: 'writing', 
                        name: 'æ–‡å­—', 
                        cost: { science: 40 }, 
                        effect: { science: 2 },
                        description: 'ä¿ƒè¿›çŸ¥è¯†ä¼ æ’­',
                        researched: false
                    },
                    { 
                        id: 'mathematics', 
                        name: 'æ•°å­¦', 
                        cost: { science: 60 }, 
                        effect: { science: 3 },
                        description: 'æ¨åŠ¨ç§‘å­¦å‘å±•',
                        researched: false,
                        prerequisite: 'writing'
                    },
                    { 
                        id: 'engineering', 
                        name: 'å·¥ç¨‹å­¦', 
                        cost: { science: 80 }, 
                        effect: { wood: 3, stone: 3 },
                        description: 'æé«˜å»ºè®¾æ•ˆç‡',
                        researched: false,
                        prerequisite: 'mathematics'
                    }
                ];
                
                this.gameStats = JSON.parse(localStorage.getItem('civilizationStats') || '{}');
                
                this.init();
            }

            init() {
                this.generateMap();
                this.updateDisplay();
                this.updateBuildingsDisplay();
                this.updateTechDisplay();
                this.showAchievement('æ–‡æ˜å»ºè®¾æ¸¸æˆå¼€å§‹ï¼å»ºé€ ä½ çš„ä¼Ÿå¤§æ–‡æ˜ï¼');
            }

            generateMap() {
                this.map = [];
                const terrainTypes = ['plains', 'forest', 'mountain', 'water', 'desert'];
                const terrainWeights = [0.3, 0.25, 0.2, 0.15, 0.1];
                
                for (let row = 0; row < 6; row++) {
                    this.map[row] = [];
                    for (let col = 0; col < 8; col++) {
                        const random = Math.random();
                        let cumulativeWeight = 0;
                        let terrain = 'plains';
                        
                        for (let i = 0; i < terrainTypes.length; i++) {
                            cumulativeWeight += terrainWeights[i];
                            if (random <= cumulativeWeight) {
                                terrain = terrainTypes[i];
                                break;
                            }
                        }
                        
                        this.map[row][col] = {
                            terrain: terrain,
                            building: null,
                            row: row,
                            col: col
                        };
                    }
                }
                
                // åœ¨ä¸­å¿ƒæ”¾ç½®åˆå§‹åŸå¸‚
                this.map[2][3].building = 'city';
                this.map[3][4].building = 'city';
                
                this.renderMap();
            }

            renderMap() {
                const grid = document.getElementById('cityGrid');
                grid.innerHTML = '';
                
                for (let row = 0; row < 6; row++) {
                    for (let col = 0; col < 8; col++) {
                        const tile = this.map[row][col];
                        const tileElement = document.createElement('div');
                        tileElement.className = `tile ${tile.terrain}`;
                        tileElement.dataset.row = row;
                        tileElement.dataset.col = col;
                        tileElement.onclick = () => this.selectTile(row, col);
                        
                        // æ˜¾ç¤ºåœ°å½¢ç±»å‹
                        const terrainNames = {
                            plains: 'å¹³åŸ',
                            forest: 'æ£®æ—',
                            mountain: 'å±±åœ°',
                            water: 'æ°´åŸŸ',
                            desert: 'æ²™æ¼ '
                        };
                        
                        tileElement.textContent = terrainNames[tile.terrain];
                        
                        // å¦‚æœæœ‰å»ºç­‘ï¼Œæ˜¾ç¤ºå»ºç­‘
                        if (tile.building) {
                            const buildingElement = document.createElement('div');
                            buildingElement.className = `building ${tile.building}`;
                            const buildingConfig = this.buildings.find(b => b.id === tile.building);
                            buildingElement.textContent = buildingConfig ? buildingConfig.name : tile.building;
                            tileElement.appendChild(buildingElement);
                        }
                        
                        grid.appendChild(tileElement);
                    }
                }
            }

            selectTile(row, col) {
                // æ¸…é™¤ä¹‹å‰çš„é€‰æ‹©
                document.querySelectorAll('.tile.selected').forEach(tile => {
                    tile.classList.remove('selected');
                });
                
                // é€‰æ‹©æ–°çš„åœ°å—
                const tileElement = document.querySelector(`[data-row="${row}"][data-col="${col}"]`);
                tileElement.classList.add('selected');
                
                this.selectedTile = { row, col };
                const tile = this.map[row][col];
                
                const terrainNames = {
                    plains: 'å¹³åŸ',
                    forest: 'æ£®æ—',
                    mountain: 'å±±åœ°',
                    water: 'æ°´åŸŸ',
                    desert: 'æ²™æ¼ '
                };
                
                let tileInfo = `${terrainNames[tile.terrain]}`;
                if (tile.building) {
                    const buildingConfig = this.buildings.find(b => b.id === tile.building);
                    tileInfo += ` (${buildingConfig ? buildingConfig.name : tile.building})`;
                }
                
                document.getElementById('selectedTile').textContent = tileInfo;
                
                this.updateBuildingsDisplay();
            }

            buildBuilding(buildingId) {
                if (!this.selectedTile) {
                    this.showInfo('è¯·å…ˆé€‰æ‹©ä¸€ä¸ªåœ°å—', 'å»ºé€ æç¤º');
                    return;
                }
                
                const building = this.buildings.find(b => b.id === buildingId);
                const tile = this.map[this.selectedTile.row][this.selectedTile.col];
                
                // æ£€æŸ¥åœ°å½¢é€‚åˆæ€§
                if (!building.terrain.includes(tile.terrain)) {
                    this.showInfo(`${building.name}ä¸èƒ½å»ºåœ¨${this.getTerrainName(tile.terrain)}ä¸Š`, 'å»ºé€ å¤±è´¥');
                    return;
                }
                
                // æ£€æŸ¥æ˜¯å¦å·²æœ‰å»ºç­‘
                if (tile.building) {
                    this.showInfo('è¯¥åœ°å—å·²æœ‰å»ºç­‘', 'å»ºé€ å¤±è´¥');
                    return;
                }
                
                // æ£€æŸ¥èµ„æºæ˜¯å¦è¶³å¤Ÿ
                if (!this.canAfford(building.cost)) {
                    this.showInfo('èµ„æºä¸è¶³', 'å»ºé€ å¤±è´¥');
                    return;
                }
                
                this.selectedBuilding = building;
                document.getElementById('buildingDetails').innerHTML = `
                    <h4>${building.name}</h4>
                    <p>${building.description}</p>
                    <p><strong>æ¶ˆè€—ï¼š</strong>${this.formatCost(building.cost)}</p>
                    <p><strong>æ•ˆæœï¼š</strong>${this.formatEffect(building.effect)}</p>
                `;
                document.getElementById('buildingModal').style.display = 'flex';
            }

            confirmBuilding() {
                if (!this.selectedBuilding || !this.selectedTile) return;
                
                const building = this.selectedBuilding;
                const tile = this.map[this.selectedTile.row][this.selectedTile.col];
                
                // æ‰£é™¤èµ„æº
                Object.entries(building.cost).forEach(([resource, cost]) => {
                    this.resources[resource] -= cost;
                });
                
                // å¢åŠ æ¯å›åˆäº§é‡
                Object.entries(building.effect).forEach(([resource, bonus]) => {
                    if (resource === 'population') {
                        // äººå£æ˜¯ä¸Šé™ï¼Œä¸æ˜¯æ¯å›åˆäº§é‡
                        return;
                    }
                    this.resourcesPerTurn[resource] += bonus;
                });
                
                // å»ºé€ å»ºç­‘
                tile.building = building.id;
                
                this.showAchievement(`æˆåŠŸå»ºé€ äº†${building.name}ï¼`);
                this.updateDisplay();
                this.renderMap();
                this.updateBuildingsDisplay();
                this.closeBuildingModal();
            }

            closeBuildingModal() {
                document.getElementById('buildingModal').style.display = 'none';
                this.selectedBuilding = null;
            }

            researchTech(techId) {
                const tech = this.technologies.find(t => t.id === techId);
                
                if (tech.researched) {
                    this.showInfo('è¯¥æŠ€æœ¯å·²ç»ç ”ç©¶è¿‡äº†', 'ç ”ç©¶å¤±è´¥');
                    return;
                }
                
                if (tech.prerequisite && !this.technologies.find(t => t.id === tech.prerequisite).researched) {
                    this.showInfo('éœ€è¦å…ˆç ”ç©¶å‰ç½®æŠ€æœ¯', 'ç ”ç©¶å¤±è´¥');
                    return;
                }
                
                if (!this.canAfford(tech.cost)) {
                    this.showInfo('ç§‘æŠ€ç‚¹ä¸è¶³', 'ç ”ç©¶å¤±è´¥');
                    return;
                }
                
                this.selectedTech = tech;
                document.getElementById('techDetails').innerHTML = `
                    <h4>${tech.name}</h4>
                    <p>${tech.description}</p>
                    <p><strong>æ¶ˆè€—ï¼š</strong>${this.formatCost(tech.cost)}</p>
                    <p><strong>æ•ˆæœï¼š</strong>${this.formatEffect(tech.effect)}</p>
                `;
                document.getElementById('techModal').style.display = 'flex';
            }

            confirmTech() {
                if (!this.selectedTech) return;
                
                const tech = this.selectedTech;
                
                // æ‰£é™¤ç§‘æŠ€ç‚¹
                Object.entries(tech.cost).forEach(([resource, cost]) => {
                    this.resources[resource] -= cost;
                });
                
                // åº”ç”¨ç§‘æŠ€æ•ˆæœ
                Object.entries(tech.effect).forEach(([resource, bonus]) => {
                    this.resourcesPerTurn[resource] += bonus;
                });
                
                tech.researched = true;
                
                this.showAchievement(`æˆåŠŸç ”ç©¶äº†${tech.name}ï¼`);
                this.updateDisplay();
                this.updateTechDisplay();
                this.closeTechModal();
            }

            closeTechModal() {
                document.getElementById('techModal').style.display = 'none';
                this.selectedTech = null;
            }

            nextTurn() {
                this.turn++;
                
                // å¢åŠ èµ„æº
                Object.entries(this.resourcesPerTurn).forEach(([resource, amount]) => {
                    this.resources[resource] += amount;
                });
                
                // æ£€æŸ¥æˆå°±
                this.checkAchievements();
                
                this.updateDisplay();
                this.updateBuildingsDisplay();
                this.updateTechDisplay();
            }

            autoPlay() {
                // è‡ªåŠ¨å‘å±•ç­–ç•¥
                const strategies = [
                    () => this.autoBuild(),
                    () => this.autoResearch(),
                    () => this.expandTerritory()
                ];
                
                strategies.forEach(strategy => strategy());
                this.nextTurn();
            }

            autoBuild() {
                // å¯»æ‰¾å¯å»ºé€ çš„æœ€ä½³å»ºç­‘
                const emptyTiles = [];
                for (let row = 0; row < 6; row++) {
                    for (let col = 0; col < 8; col++) {
                        if (!this.map[row][col].building && this.map[row][col].terrain !== 'water') {
                            emptyTiles.push({ row, col });
                        }
                    }
                }
                
                if (emptyTiles.length === 0) return;
                
                // æ ¹æ®å½“å‰èµ„æºçŠ¶å†µé€‰æ‹©å»ºç­‘
                let priorityBuilding = null;
                if (this.resources.food < 100) {
                    priorityBuilding = this.buildings.find(b => b.id === 'farm');
                } else if (this.resources.wood < 100) {
                    priorityBuilding = this.buildings.find(b => b.id === 'lumber');
                } else if (this.resources.stone < 100) {
                    priorityBuilding = this.buildings.find(b => b.id === 'mine');
                } else if (this.resources.science < 50) {
                    priorityBuilding = this.buildings.find(b => b.id === 'library');
                }
                
                if (!priorityBuilding || !this.canAfford(priorityBuilding.cost)) {
                    return;
                }
                
                // å¯»æ‰¾åˆé€‚çš„åœ°å—
                const suitableTiles = emptyTiles.filter(tile => {
                    const terrain = this.map[tile.row][tile.col].terrain;
                    return priorityBuilding.terrain.includes(terrain);
                });
                
                if (suitableTiles.length > 0) {
                    const randomTile = suitableTiles[Math.floor(Math.random() * suitableTiles.length)];
                    this.selectedTile = randomTile;
                    
                    // ç›´æ¥å»ºé€ 
                    Object.entries(priorityBuilding.cost).forEach(([resource, cost]) => {
                        this.resources[resource] -= cost;
                    });
                    
                    Object.entries(priorityBuilding.effect).forEach(([resource, bonus]) => {
                        if (resource !== 'population') {
                            this.resourcesPerTurn[resource] += bonus;
                        }
                    });
                    
                    this.map[randomTile.row][randomTile.col].building = priorityBuilding.id;
                    this.renderMap();
                }
            }

            autoResearch() {
                // è‡ªåŠ¨ç ”ç©¶å¯è´Ÿæ‹…çš„æŠ€æœ¯
                const availableTechs = this.technologies.filter(tech => 
                    !tech.researched && 
                    this.canAfford(tech.cost) &&
                    (!tech.prerequisite || this.technologies.find(t => t.id === tech.prerequisite).researched)
                );
                
                if (availableTechs.length > 0) {
                    const tech = availableTechs[0];
                    
                    Object.entries(tech.cost).forEach(([resource, cost]) => {
                        this.resources[resource] -= cost;
                    });
                    
                    Object.entries(tech.effect).forEach(([resource, bonus]) => {
                        this.resourcesPerTurn[resource] += bonus;
                    });
                    
                    tech.researched = true;
                    this.showAchievement(`è‡ªåŠ¨ç ”ç©¶äº†${tech.name}ï¼`);
                }
            }

            expandTerritory() {
                // æ‰©å¼ é¢†åœŸçš„é€»è¾‘ï¼ˆæš‚æ—¶ç®€åŒ–ï¼‰
                if (this.resources.food > 200 && this.resources.wood > 150 && this.resources.stone > 100) {
                    this.showAchievement('é¢†åœŸæ‰©å¼ æˆåŠŸï¼');
                }
            }

            checkAchievements() {
                const achievements = [
                    { condition: () => this.turn === 10, message: 'æ–‡æ˜å‘å±•10å›åˆï¼' },
                    { condition: () => this.resources.food >= 200, message: 'é£Ÿç‰©å‚¨å¤‡ä¸°å¯Œï¼' },
                    { condition: () => this.resources.population >= 500, message: 'äººå£ç¹è£ï¼' },
                    { condition: () => this.technologies.filter(t => t.researched).length >= 3, message: 'ç§‘æŠ€è¿›æ­¥ï¼' },
                    { condition: () => this.getBuildingCount() >= 10, message: 'å»ºç­‘å¤§å¸ˆï¼' },
                    { condition: () => this.turn >= 50, message: 'æ–‡æ˜æŒä¹…å‘å±•ï¼' }
                ];
                
                achievements.forEach(achievement => {
                    if (achievement.condition() && !achievement.triggered) {
                        this.showAchievement(achievement.message);
                        achievement.triggered = true;
                    }
                });
            }

            getBuildingCount() {
                let count = 0;
                for (let row = 0; row < 6; row++) {
                    for (let col = 0; col < 8; col++) {
                        if (this.map[row][col].building) {
                            count++;
                        }
                    }
                }
                return count;
            }

            canAfford(cost) {
                return Object.entries(cost).every(([resource, amount]) => {
                    return this.resources[resource] >= amount;
                });
            }

            formatCost(cost) {
                return Object.entries(cost).map(([resource, amount]) => {
                    const resourceNames = {
                        food: 'é£Ÿç‰©',
                        wood: 'æœ¨æ',
                        stone: 'çŸ³æ–™',
                        science: 'ç§‘æŠ€ç‚¹'
                    };
                    return `${resourceNames[resource]}${amount}`;
                }).join(', ');
            }

            formatEffect(effect) {
                return Object.entries(effect).map(([resource, amount]) => {
                    const resourceNames = {
                        food: 'é£Ÿç‰©',
                        wood: 'æœ¨æ',
                        stone: 'çŸ³æ–™',
                        science: 'ç§‘æŠ€ç‚¹',
                        population: 'äººå£'
                    };
                    return `+${amount}${resourceNames[resource]}/å›åˆ`;
                }).join(', ');
            }

            getTerrainName(terrain) {
                const terrainNames = {
                    plains: 'å¹³åŸ',
                    forest: 'æ£®æ—',
                    mountain: 'å±±åœ°',
                    water: 'æ°´åŸŸ',
                    desert: 'æ²™æ¼ '
                };
                return terrainNames[terrain] || terrain;
            }

            updateDisplay() {
                document.getElementById('currentTurn').textContent = this.turn;
                document.getElementById('turnDisplay').textContent = this.turn;
                
                Object.entries(this.resources).forEach(([resource, amount]) => {
                    const element = document.getElementById(resource);
                    if (element) {
                        element.textContent = Math.floor(amount);
                    }
                    
                    const displayElement = document.getElementById(`${resource}Display`);
                    if (displayElement) {
                        displayElement.textContent = Math.floor(amount);
                    }
                });
                
                Object.entries(this.resourcesPerTurn).forEach(([resource, amount]) => {
                    const changeElement = document.getElementById(`${resource}Change`);
                    if (changeElement) {
                        changeElement.textContent = `+${amount}/å›åˆ`;
                        changeElement.className = amount > 0 ? 'resource-change' : 'resource-change negative';
                    }
                });
            }

            updateBuildingsDisplay() {
                const container = document.getElementById('buildingsContainer');
                container.innerHTML = '';
                
                this.buildings.forEach(building => {
                    const buildingElement = document.createElement('div');
                    const canAfford = this.canAfford(building.cost);
                    buildingElement.className = `building-item ${canAfford ? 'affordable' : 'expensive'}`;
                    buildingElement.onclick = () => this.buildBuilding(building.id);
                    
                    buildingElement.innerHTML = `
                        <div class="building-name">${building.name}</div>
                        <div class="building-cost">æ¶ˆè€—: ${this.formatCost(building.cost)}</div>
                        <div class="building-effect">${this.formatEffect(building.effect)}</div>
                    `;
                    
                    container.appendChild(buildingElement);
                });
            }

            updateTechDisplay() {
                const container = document.getElementById('techContainer');
                container.innerHTML = '';
                
                this.technologies.forEach(tech => {
                    const techElement = document.createElement('div');
                    let className = 'tech-item';
                    
                    if (tech.researched) {
                        className += ' researched';
                    } else if (this.canAfford(tech.cost) && 
                              (!tech.prerequisite || this.technologies.find(t => t.id === tech.prerequisite).researched)) {
                        className += ' affordable';
                    } else {
                        className += ' expensive';
                    }
                    
                    techElement.className = className;
                    techElement.onclick = () => this.researchTech(tech.id);
                    
                    let statusText = tech.researched ? 'å·²ç ”ç©¶' : `æ¶ˆè€—: ${this.formatCost(tech.cost)}`;
                    
                    techElement.innerHTML = `
                        <div style="font-weight: bold; color: #8e44ad;">${tech.name}</div>
                        <div style="font-size: 0.8rem; color: #666;">${statusText}</div>
                    `;
                    
                    container.appendChild(techElement);
                });
            }

            showProgress() {
                let progressText = 'æ–‡æ˜å‘å±•è¿›åº¦ï¼š\n\n';
                progressText += `å›åˆæ•°: ${this.turn}\n`;
                progressText += `å»ºç­‘æ•°é‡: ${this.getBuildingCount()}\n`;
                progressText += `å·²ç ”ç©¶æŠ€æœ¯: ${this.technologies.filter(t => t.researched).length}/${this.technologies.length}\n`;
                progressText += `æ€»äººå£: ${Math.floor(this.resources.population)}\n`;
                
                this.showInfo(progressText, 'å‘å±•è¿›åº¦');
            }

            showStats() {
                let statsText = 'æ¸¸æˆç»Ÿè®¡ï¼š\n\n';
                if (Object.keys(this.gameStats).length === 0) {
                    statsText += 'æš‚æ— ç»Ÿè®¡æ•°æ®';
                } else {
                    Object.entries(this.gameStats).forEach(([key, value]) => {
                        statsText += `${key}: ${value}\n`;
                    });
                }
                
                this.showInfo(statsText, 'æ¸¸æˆç»Ÿè®¡');
            }

            saveGame() {
                const saveData = {
                    turn: this.turn,
                    resources: this.resources,
                    resourcesPerTurn: this.resourcesPerTurn,
                    map: this.map,
                    technologies: this.technologies,
                    timestamp: new Date().toLocaleString()
                };
                
                localStorage.setItem('civilizationSave', JSON.stringify(saveData));
                this.showAchievement('æ¸¸æˆå·²ä¿å­˜ï¼');
            }

            loadGame() {
                const saveData = localStorage.getItem('civilizationSave');
                if (!saveData) {
                    this.showInfo('æ²¡æœ‰æ‰¾åˆ°å­˜æ¡£', 'åŠ è½½å¤±è´¥');
                    return;
                }
                
                try {
                    const data = JSON.parse(saveData);
                    this.turn = data.turn;
                    this.resources = data.resources;
                    this.resourcesPerTurn = data.resourcesPerTurn;
                    this.map = data.map;
                    this.technologies = data.technologies;
                    
                    this.renderMap();
                    this.updateDisplay();
                    this.updateBuildingsDisplay();
                    this.updateTechDisplay();
                    
                    this.showAchievement(`æ¸¸æˆå·²åŠ è½½ï¼(${data.timestamp})`);
                } catch (error) {
                    this.showInfo('å­˜æ¡£æ–‡ä»¶æŸå', 'åŠ è½½å¤±è´¥');
                }
            }

            newGame() {
                if (confirm('ç¡®å®šè¦å¼€å§‹æ–°æ¸¸æˆå—ï¼Ÿå½“å‰è¿›åº¦å°†ä¸¢å¤±ã€‚')) {
                    location.reload();
                }
            }

            showInfo(content, title = 'ä¿¡æ¯') {
                document.getElementById('infoTitle').textContent = title;
                document.getElementById('infoContent').innerHTML = content.replace(/\n/g, '<br>');
                document.getElementById('infoModal').style.display = 'flex';
            }

            closeInfoModal() {
                document.getElementById('infoModal').style.display = 'none';
            }

            showAchievement(message) {
                const achievement = document.getElementById('achievement');
                achievement.textContent = message;
                achievement.style.display = 'block';
                
                setTimeout(() => {
                    achievement.style.display = 'none';
                }, 3000);
            }
        }

        // åˆå§‹åŒ–æ¸¸æˆ
        const civilization = new CivilizationGame();
    </script>
</body>
</html>