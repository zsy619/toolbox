<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ä¸­å›½è±¡æ£‹ - ç»å…¸ç­–ç•¥å¯¹å¼ˆæ¸¸æˆ | æ‰å¹³åŒ–è®¾è®¡</title>
    
    <!-- SEO Metaæ ‡ç­¾ -->
    <meta name="description" content="ç»å…¸ä¸­å›½è±¡æ£‹æ¸¸æˆï¼Œæ‰å¹³åŒ–è®¾è®¡ç•Œé¢ï¼Œæ”¯æŒäººæœºå¯¹æˆ˜å’ŒåŒäººå¯¹å¼ˆï¼Œå®Œæ•´çš„è±¡æ£‹è§„åˆ™å’ŒAIå¯¹æ‰‹ï¼">
    <meta name="keywords" content="ä¸­å›½è±¡æ£‹,è±¡æ£‹æ¸¸æˆ,ç­–ç•¥æ¸¸æˆ,æ£‹ç±»æ¸¸æˆ,åœ¨çº¿æ¸¸æˆ,å…è´¹æ¸¸æˆ,æ‰å¹³åŒ–è®¾è®¡">
    <meta name="author" content="æ¸¸æˆå·¥å…·ç®±">
    <meta name="theme-color" content="#C0392B">
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Microsoft YaHei', 'SF Pro Display', -apple-system, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #2c3e50;
            padding: 20px;
            overflow-x: hidden;
        }

        .game-container {
            max-width: 1000px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            border-radius: 24px;
            padding: 30px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.15);
        }

        h1 {
            text-align: center;
            font-size: 2.8rem;
            color: #2c3e50;
            margin-bottom: 30px;
            font-weight: 700;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .game-info {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .player-info {
            background: linear-gradient(135deg, #C0392B, #A93226);
            color: white;
            padding: 20px;
            border-radius: 16px;
            text-align: center;
            box-shadow: 0 8px 25px rgba(192, 57, 43, 0.3);
            transition: transform 0.3s ease;
        }

        .player-info.active {
            transform: translateY(-3px);
            box-shadow: 0 12px 35px rgba(192, 57, 43, 0.4);
        }

        .player-info.black {
            background: linear-gradient(135deg, #2c3e50, #34495e);
            box-shadow: 0 8px 25px rgba(44, 62, 80, 0.3);
        }

        .player-info.black.active {
            box-shadow: 0 12px 35px rgba(44, 62, 80, 0.4);
        }

        .player-name {
            font-size: 1.2rem;
            font-weight: 700;
            margin-bottom: 10px;
        }

        .player-status {
            font-size: 1rem;
            opacity: 0.9;
        }

        .game-controls {
            display: flex;
            gap: 15px;
            margin-bottom: 30px;
            justify-content: center;
            flex-wrap: wrap;
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 50px;
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 0.9rem;
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.3);
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.4);
        }

        .btn:active {
            transform: translateY(0);
        }

        .btn.secondary {
            background: linear-gradient(135deg, #4ECDC4, #44A08D);
            box-shadow: 0 6px 20px rgba(78, 205, 196, 0.3);
        }

        .btn.secondary:hover {
            box-shadow: 0 8px 25px rgba(78, 205, 196, 0.4);
        }

        .chess-board-container {
            display: flex;
            justify-content: center;
            margin-bottom: 30px;
        }

        .chess-board {
            background: #D4B08A;
            border: 8px solid #8B4513;
            border-radius: 12px;
            padding: 30px;
            box-shadow: 0 15px 40px rgba(0, 0, 0, 0.2);
            position: relative;
        }

        .board-container {
            position: relative;
            width: 450px;
            height: 500px;
            background: #D4B08A;
            border: 2px solid #8B4513;
            border-radius: 8px;
        }

        .board-lines {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
        }

        .board-intersection {
            position: absolute;
            width: 12px;
            height: 12px;
            margin: -6px 0 0 -6px;
            cursor: pointer;
            border-radius: 50%;
            transition: all 0.2s ease;
            z-index: 1;
        }

        .board-intersection:hover {
            background: rgba(255, 107, 107, 0.3);
        }

        .board-intersection.selected {
            background: rgba(255, 107, 107, 0.5);
            box-shadow: 0 0 0 3px #FF6B6B;
        }

        .board-intersection.possible-move {
            background: rgba(144, 238, 144, 0.7);
            box-shadow: 0 0 0 2px #90EE90;
        }

        .chess-piece {
            position: absolute;
            width: 44px;
            height: 44px;
            /* ç²¾ç¡®å±…ä¸­åœ¨äº¤å‰çº¿äº¤ç‚¹ä¸Šï¼šè´Ÿè¾¹è·ä¸ºå®½é«˜çš„ç²¾ç¡®ä¸€åŠ */
            margin-left: -22px;
            margin-top: -22px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            font-size: 1.2rem;
            cursor: pointer;
            transition: all 0.2s ease;
            border: 2px solid;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
            z-index: 10;
            /* ç¡®ä¿æ£‹å­æ–‡å­—åœ¨åœ†å½¢ä¸­å®Œç¾å±…ä¸­ */
            text-align: center;
            line-height: 1;
            /* ä¼ ç»Ÿè±¡æ£‹æ£‹å­è´¨æ„Ÿ */
            background: radial-gradient(circle at 30% 30%, rgba(255,255,255,0.3), transparent 50%);
        }

        /* è±¡æ£‹æ®‹å±€æ¨¡å¼ä¸‹çš„æ£‹å­å¢å¼ºæ˜¾ç¤º */
        .chess-piece.endgame-piece {
            border-width: 3px;
            box-shadow: 0 3px 12px rgba(0, 0, 0, 0.4);
            font-weight: 800;
            /* æ®‹å±€æ¨¡å¼ä¸‹æ›´åŠ çªå‡º */
        }

        .chess-piece.endgame-piece:hover {
            transform: scale(1.15);
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.5);
        }

        /* æ®‹å±€æ¨¡å¼ä¸‹çš„æ£‹ç›˜å¢å¼º */
        .endgame-mode .board-lines {
            filter: contrast(1.1) brightness(1.05);
        }

        .endgame-mode .chess-board {
            box-shadow: 0 20px 50px rgba(0, 0, 0, 0.25);
            border-width: 10px;
        }

        /* Chess-Puzzleè°œé¢˜æ¨¡å¼ä¸“ç”¨æ ·å¼ */
        .puzzle-btn {
            background: linear-gradient(135deg, #9b59b6, #8e44ad) !important;
            color: white !important;
            box-shadow: 0 6px 20px rgba(155, 89, 182, 0.3) !important;
        }

        .puzzle-btn:hover {
            box-shadow: 0 8px 25px rgba(155, 89, 182, 0.4) !important;
        }

        /* Chess-Puzzleæ¨¡å¼ä¸‹çš„æ£‹ç›˜ - å¢å¼ºæ ‡å‡†ä¸­å›½è±¡æ£‹è®¾è®¡ */
        .chess-puzzle-mode .board-lines {
            filter: contrast(1.2) brightness(1.15) saturate(1.1);
            /* å¢å¼ºçº¿æ¡æ¸…æ™°åº¦ */
        }

        .chess-puzzle-mode .chess-board {
            border: 15px solid #654321;
            box-shadow: 
                0 30px 80px rgba(0, 0, 0, 0.4),
                inset 0 0 20px rgba(139, 69, 19, 0.2);
            background: 
                linear-gradient(135deg, #D2B48C 0%, #DEB887 50%, #D2B48C 100%),
                radial-gradient(circle at 30% 30%, rgba(255,255,255,0.1), transparent 60%);
            /* æœ¨è´¨çº¹ç†å¢å¼ºæ•ˆæœ */
            position: relative;
        }

        .chess-puzzle-mode .chess-board::before {
            content: '';
            position: absolute;
            top: -15px;
            left: -15px;
            right: -15px;
            bottom: -15px;
            background: linear-gradient(45deg, #8B4513, #A0522D, #8B4513);
            border-radius: 8px;
            z-index: -1;
        }

        /* Chess-Puzzleæ¨¡å¼ä¸‹çš„æ£‹ç›˜å®¹å™¨å¢å¼º */
        .chess-puzzle-mode .board-container {
            background: rgba(212, 180, 138, 0.95);
            border-radius: 6px;
            border: 3px solid #8B4513;
        }

        /* Chess-Puzzleæ¨¡å¼ä¸‹çš„æ£‹å­å¢å¼º - ç²¾ç¡®å±…ä¸­åœ¨äº¤å‰çº¿ä¸Š */
        .chess-piece.puzzle-piece {
            border-width: 4px;
            box-shadow: 
                0 4px 15px rgba(0, 0, 0, 0.4),
                0 0 0 1px rgba(255, 255, 255, 0.3) inset;
            font-weight: 900;
            font-size: 1.25rem;
            /* è°œé¢˜æ¨¡å¼ä¸‹æ›´åŠ çªå‡ºå’Œç«‹ä½“ */
            filter: drop-shadow(0 3px 6px rgba(0,0,0,0.4));
            /* ç¡®ä¿ç²¾ç¡®å±…ä¸­åœ¨äº¤å‰çº¿äº¤ç‚¹ä¸Š */
            transform-origin: center center;
            /* å¢å¼ºæœ¨è´¨æ£‹å­è´¨æ„Ÿ */
            background: 
                radial-gradient(circle at 25% 25%, rgba(255,255,255,0.4), transparent 50%),
                radial-gradient(circle at 75% 75%, rgba(0,0,0,0.1), transparent 50%);
        }

        .chess-piece.puzzle-piece:hover {
            transform: scale(1.25);
            box-shadow: 
                0 8px 25px rgba(0, 0, 0, 0.6),
                0 0 0 2px rgba(255, 255, 255, 0.4) inset;
            filter: drop-shadow(0 4px 8px rgba(0,0,0,0.5));
        }

        /* Chess-Puzzleæ¨¡å¼ä¸‹çš„æ£‹å­é¢œè‰²å¢å¼º */
        .chess-piece.puzzle-piece.red {
            background: 
                linear-gradient(135deg, #E74C3C, #C0392B),
                radial-gradient(circle at 25% 25%, rgba(255,255,255,0.4), transparent 50%);
            border-color: #922B21;
            color: #FFFFFF;
            text-shadow: 0 1px 2px rgba(0,0,0,0.5);
        }

        .chess-piece.puzzle-piece.black {
            background: 
                linear-gradient(135deg, #2C3E50, #1B2631),
                radial-gradient(circle at 25% 25%, rgba(255,255,255,0.3), transparent 50%);
            border-color: #0B1426;
            color: #FFFFFF;
            text-shadow: 0 1px 2px rgba(0,0,0,0.7);
        }

        /* è°œé¢˜è§£å†³æˆåŠŸç‰¹æ•ˆ */
        .puzzle-solved .chess-piece {
            animation: puzzleSolved 2s infinite alternate;
        }

        @keyframes puzzleSolved {
            0% { filter: drop-shadow(0 0 5px #4CAF50); }
            100% { filter: drop-shadow(0 0 15px #4CAF50); }
        }

        /* Chess-Puzzleæ¨¡å¼ä¸‹çš„å£«çº¿å¢å¼ºæ•ˆæœ */
        .chess-puzzle-mode .palace-line {
            stroke: #A0522D;
            stroke-width: 2.8;
            opacity: 1;
            filter: drop-shadow(0 1px 2px rgba(0,0,0,0.3));
        }

        /* Chess-Puzzleæ¨¡å¼ä¸‹çš„ä¹å®«æ ¼å¢å¼ºæ ‡è®° */
        .chess-puzzle-mode #palaceLines {
            filter: drop-shadow(0 1px 3px rgba(0,0,0,0.2));
        }

        /* è°œé¢˜æ¨¡å¼ä¸‹çš„äº¤å‰ç‚¹å¢å¼ºæ˜¾ç¤º */
        .chess-puzzle-mode .board-intersection {
            background: rgba(139, 69, 19, 0.1);
            border: 1px solid rgba(139, 69, 19, 0.2);
        }

        .chess-puzzle-mode .board-intersection:hover {
            background: rgba(255, 107, 107, 0.4);
            border: 2px solid #FF6B6B;
        }

        /* å…³é”®æ£‹å­æç¤ºåŠ¨ç”» */
        @keyframes keyPieceHint {
            0% { 
                transform: scale(1);
                filter: drop-shadow(0 3px 6px rgba(0,0,0,0.4));
            }
            50% { 
                transform: scale(1.15);
                filter: drop-shadow(0 0 10px #FFD700);
            }
            100% { 
                transform: scale(1);
                filter: drop-shadow(0 3px 6px rgba(0,0,0,0.4));
            }
        }

        /* Chess-Puzzleæ¨¡å¼ä¸‹çš„é€‰ä¸­æ£‹å­å¢å¼ºæ•ˆæœ */
        .chess-puzzle-mode .board-intersection.selected {
            background: rgba(255, 215, 0, 0.6);
            box-shadow: 0 0 0 4px #FFD700;
            border-radius: 8px;
        }

        .chess-puzzle-mode .board-intersection.possible-move {
            background: rgba(144, 238, 144, 0.8);
            box-shadow: 0 0 0 3px #90EE90;
            border-radius: 6px;
        }

        .chess-piece:hover {
            transform: scale(1.1);
        }

        .chess-piece.red {
            background: linear-gradient(135deg, #E74C3C, #C0392B);
            color: white;
            border-color: #A93226;
        }

        .chess-piece.black {
            background: linear-gradient(135deg, #2c3e50, #34495e);
            color: white;
            border-color: #1B2631;
        }

        .river-line {
            position: absolute;
            left: 0;
            right: 0;
            top: 50%;
            height: 50px;
            margin-top: -25px;
            background: linear-gradient(to right, transparent, #654321, transparent);
            pointer-events: none;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #654321;
            font-weight: bold;
            font-size: 1.5rem;
        }

        .game-status {
            background: rgba(255, 255, 255, 0.8);
            padding: 20px;
            border-radius: 16px;
            margin-bottom: 20px;
            text-align: center;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
        }

        .game-status h3 {
            color: #2c3e50;
            margin-bottom: 10px;
            font-size: 1.3rem;
        }

        .status-text {
            font-size: 1.1rem;
            color: #7f8c8d;
        }

        .move-history {
            background: rgba(255, 255, 255, 0.8);
            padding: 20px;
            border-radius: 16px;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
            max-height: 200px;
            overflow-y: auto;
        }

        .move-history h3 {
            color: #2c3e50;
            margin-bottom: 15px;
            font-size: 1.2rem;
        }

        .move-item {
            display: flex;
            justify-content: space-between;
            padding: 5px 0;
            border-bottom: 1px solid #ecf0f1;
        }

        .move-item:last-child {
            border-bottom: none;
        }

        .game-over-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }

        .game-over-content {
            background: white;
            padding: 40px;
            border-radius: 20px;
            text-align: center;
            max-width: 400px;
            margin: 20px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        }

        .game-over-content h2 {
            color: #27ae60;
            margin-bottom: 20px;
            font-size: 2rem;
        }

        .winner-text {
            font-size: 1.5rem;
            color: #2c3e50;
            margin-bottom: 25px;
        }

        .celebration {
            font-size: 3rem;
            margin-bottom: 20px;
            animation: bounce 2s infinite;
        }

        @keyframes bounce {
            0%, 20%, 50%, 80%, 100% { transform: translateY(0); }
            40% { transform: translateY(-10px); }
            60% { transform: translateY(-5px); }
        }

        .instructions {
            background: rgba(255, 255, 255, 0.8);
            padding: 25px;
            border-radius: 16px;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
            margin-top: 30px;
        }

        .instructions h3 {
            color: #2c3e50;
            margin-bottom: 20px;
            font-size: 1.3rem;
            text-align: center;
        }

        .instruction-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }

        .instruction-item {
            background: white;
            padding: 15px;
            border-radius: 12px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        }

        .instruction-item h4 {
            color: #C0392B;
            margin-bottom: 8px;
            font-size: 1rem;
        }

        .instruction-item p {
            color: #7f8c8d;
            font-size: 0.85rem;
            line-height: 1.4;
        }

        @media (max-width: 768px) {
            .game-container {
                padding: 20px;
                margin: 10px;
            }

            h1 {
                font-size: 2.2rem;
            }

            .board-container {
                width: 360px;
                height: 400px;
                /* ç¡®ä¿SVGé€‚åº”ç§»åŠ¨ç«¯ç¼©æ”¾ */
                transform: scale(0.8);
                transform-origin: center;
            }
            
            .board-lines {
                /* SVGåœ¨ç§»åŠ¨ç«¯çš„ä¼˜åŒ–æ˜¾ç¤º */
                width: 100%;
                height: 100%;
            }

            .chess-piece {
                width: 36px;
                height: 36px;
                /* ç§»åŠ¨ç«¯ç²¾ç¡®å±…ä¸­åœ¨äº¤å‰çº¿ä¸Šï¼šè´Ÿè¾¹è·ä¸ºå®½é«˜çš„ç²¾ç¡®ä¸€åŠ */
                margin-left: -18px;
                margin-top: -18px;
                font-size: 1rem;
            }

            .game-controls {
                flex-direction: column;
                align-items: center;
            }

            .btn {
                width: 100%;
                max-width: 200px;
            }

            .instruction-grid {
                grid-template-columns: 1fr;
            }
        }

        @media (max-width: 480px) {
            .board-container {
                width: 320px;
                height: 360px;
                /* å°å±å¹•è¿›ä¸€æ­¥ç¼©æ”¾ */
                transform: scale(0.7);
                transform-origin: center;
            }

            .chess-piece {
                width: 32px;
                height: 32px;
                /* å°å±ç§»åŠ¨ç«¯ç²¾ç¡®å±…ä¸­åœ¨äº¤å‰çº¿ä¸Šï¼šè´Ÿè¾¹è·ä¸ºå®½é«˜çš„ç²¾ç¡®ä¸€åŠ */
                margin-left: -16px;
                margin-top: -16px;
                font-size: 0.9rem;
            }
            
            /* ä¼˜åŒ–å°å±å¹•ä¸Šçš„æ²³ç•Œæ–‡å­— */
            .river-line {
                font-size: 1.2rem;
            }
        }
    </style>
</head>
<body>
    <main class="game-container">
        <h1>â™ ä¸­å›½è±¡æ£‹</h1>
        
        <section class="game-info">
            <div class="player-info red active" id="redPlayer">
                <div class="player-name">çº¢æ–¹</div>
                <div class="player-status">å‡†å¤‡ä¸­...</div>
            </div>
            <div class="player-info black" id="blackPlayer">
                <div class="player-name">é»‘æ–¹</div>
                <div class="player-status">ç­‰å¾…ä¸­...</div>
            </div>
        </section>

        <section class="game-controls">
            <button class="btn" id="newGameBtn" onclick="chineseChess.newGame()">ğŸ® æ–°æ¸¸æˆ</button>
            <button class="btn secondary" id="undoBtn" onclick="chineseChess.undoMove()">â†¶ æ‚”æ£‹</button>
            <button class="btn secondary" id="hintBtn" onclick="chineseChess.showHint()">ğŸ’¡ æç¤º</button>
            <button class="btn" id="aiBtn" onclick="chineseChess.toggleAI()">ğŸ¤– äººæœºå¯¹æˆ˜</button>
            <button class="btn secondary" id="endgameBtn" onclick="chineseChess.loadEndgame()">ğŸ è±¡æ£‹æ®‹å±€</button>
            <button class="btn puzzle-btn" id="chessPuzzleBtn" onclick="chineseChess.startChessPuzzle()">ğŸ§© Chess-Puzzleè°œé¢˜</button>
        </section>

        <!-- æ®‹å±€æ¨¡å¼ä¸“ç”¨å¯¼èˆªæ§åˆ¶ -->
        <section class="endgame-controls" id="endgameControls" style="display: none;">
            <div style="background: rgba(255, 255, 255, 0.9); padding: 20px; border-radius: 16px; box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1); margin-bottom: 20px;">
                <h3 style="color: #2c3e50; margin-bottom: 15px; text-align: center;">ğŸ è±¡æ£‹æ®‹å±€æ¸¸æˆå¯¼èˆª</h3>
                <div style="display: flex; gap: 10px; justify-content: center; flex-wrap: wrap;">
                    <button class="btn secondary" onclick="chineseChess.previousEndgame()">â¬…ï¸ ä¸Šä¸€å±€</button>
                    <button class="btn" onclick="chineseChess.resetCurrentEndgame()">ğŸ”„ é‡ç½®æ®‹å±€</button>
                    <button class="btn secondary" onclick="chineseChess.nextEndgame()">â¡ï¸ ä¸‹ä¸€å±€</button>
                    <button class="btn" onclick="chineseChess.exitEndgameMode()">âŒ é€€å‡ºæ®‹å±€</button>
                </div>
                <div id="endgameInfo" style="text-align: center; margin-top: 10px; font-size: 0.9rem; color: #7f8c8d;">
                    æ®‹å±€ 1/8ï¼šå‡†å¤‡å¼€å§‹
                </div>
            </div>
        </section>

        <!-- Chess-Puzzleè±¡æ£‹æ®‹å±€è°œé¢˜ä¸“ç”¨æ§åˆ¶ -->
        <section class="chess-puzzle-controls" id="chessPuzzleControls" style="display: none;">
            <div style="background: linear-gradient(135deg, #667eea, #764ba2); color: white; padding: 20px; border-radius: 16px; box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15); margin-bottom: 20px;">
                <h3 style="margin-bottom: 15px; text-align: center;">ğŸ§© Chess-Puzzle è±¡æ£‹æ®‹å±€è°œé¢˜</h3>
                <div style="display: flex; gap: 10px; justify-content: center; flex-wrap: wrap; margin-bottom: 15px;">
                    <button class="btn" onclick="chineseChess.previousPuzzle()" style="background: rgba(255,255,255,0.2); border: 1px solid rgba(255,255,255,0.3);">â¬…ï¸ ä¸Šé¢˜</button>
                    <button class="btn" onclick="chineseChess.resetPuzzle()" style="background: rgba(255,255,255,0.2); border: 1px solid rgba(255,255,255,0.3);">ğŸ”„ é‡ç½®</button>
                    <button class="btn" onclick="chineseChess.showPuzzleHint()" style="background: rgba(255,255,255,0.2); border: 1px solid rgba(255,255,255,0.3);">ğŸ’¡ è°œé¢˜æç¤º</button>
                    <button class="btn" onclick="chineseChess.nextPuzzle()" style="background: rgba(255,255,255,0.2); border: 1px solid rgba(255,255,255,0.3);">â¡ï¸ ä¸‹é¢˜</button>
                    <button class="btn" onclick="chineseChess.exitPuzzleMode()" style="background: rgba(255,255,255,0.2); border: 1px solid rgba(255,255,255,0.3);">âŒ é€€å‡º</button>
                </div>
                <div style="display: flex; gap: 10px; justify-content: center; margin-bottom: 10px;">
                    <button class="btn" onclick="chineseChess.setPuzzleDifficulty('easy')" style="background: rgba(76,175,80,0.3); border: 1px solid rgba(76,175,80,0.5); font-size: 0.8rem;">ğŸŸ¢ ç®€å•</button>
                    <button class="btn" onclick="chineseChess.setPuzzleDifficulty('medium')" style="background: rgba(255,193,7,0.3); border: 1px solid rgba(255,193,7,0.5); font-size: 0.8rem;">ğŸŸ¡ ä¸­ç­‰</button>
                    <button class="btn" onclick="chineseChess.setPuzzleDifficulty('hard')" style="background: rgba(244,67,54,0.3); border: 1px solid rgba(244,67,54,0.5); font-size: 0.8rem;">ğŸ”´ å›°éš¾</button>
                </div>
                <div id="puzzleInfo" style="text-align: center; font-size: 0.9rem; opacity: 0.9;">
                    è°œé¢˜å‡†å¤‡ä¸­...
                </div>
            </div>
        </section>

        <section class="game-status">
            <h3>ğŸ¯ æ¸¸æˆçŠ¶æ€</h3>
            <div class="status-text" id="statusText">çº¢æ–¹å…ˆè¡Œï¼Œè¯·é€‰æ‹©æ£‹å­</div>
        </section>

        <section class="chess-board-container">
            <div class="chess-board">
                <div class="board-container" id="chessBoardContainer">
                    <svg class="board-lines" viewBox="0 0 450 500" id="boardLines">
                        <!-- ä¼ ç»Ÿä¸­å›½è±¡æ£‹æ£‹ç›˜åŸºç¡€çº¿æ¡ -->
                        <defs>
                            <!-- æ£‹ç›˜çº¹ç†æ¸å˜ -->
                            <linearGradient id="boardGradient" x1="0%" y1="0%" x2="100%" y2="100%">
                                <stop offset="0%" style="stop-color:#8B4513;stop-opacity:0.1"/>
                                <stop offset="100%" style="stop-color:#654321;stop-opacity:0.1"/>
                            </linearGradient>
                        </defs>
                        
                        <!-- æ£‹ç›˜èƒŒæ™¯çº¹ç† -->
                        <rect x="25" y="25" width="400" height="450" fill="url(#boardGradient)" opacity="0.3"/>
                        
                        <!-- æ¨ªçº¿ - æ ‡å‡†ä¸­å›½è±¡æ£‹è§„æ ¼ -->
                        <g stroke="#654321" stroke-width="2" fill="none">
                            <!-- ä¸ŠåŠéƒ¨åˆ†æ¨ªçº¿ (é»‘æ–¹åŒºåŸŸ) -->
                            <line x1="25" y1="25" x2="425" y2="25" stroke-width="3"/>
                            <line x1="25" y1="75" x2="425" y2="75"/>
                            <line x1="25" y1="125" x2="425" y2="125"/>
                            <line x1="25" y1="175" x2="425" y2="175"/>
                            <line x1="25" y1="225" x2="425" y2="225"/>
                            <!-- æ²³ç•Œä¸­å¿ƒçº¿ï¼ˆæ¥šæ²³æ±‰ç•Œåˆ†ç•Œï¼‰ -->
                            <line x1="25" y1="250" x2="425" y2="250" stroke="#8B4513" stroke-width="1" stroke-dasharray="5,5" opacity="0.6"/>
                            <!-- æ²³ç•Œè¾¹ç•Œçº¿ï¼ˆåŠ ç²—æ˜¾ç¤ºï¼‰ -->
                            <line x1="25" y1="275" x2="425" y2="275" stroke-width="3"/>
                            <!-- ä¸‹åŠéƒ¨åˆ†æ¨ªçº¿ (çº¢æ–¹åŒºåŸŸ) -->
                            <line x1="25" y1="325" x2="425" y2="325"/>
                            <line x1="25" y1="375" x2="425" y2="375"/>
                            <line x1="25" y1="425" x2="425" y2="425"/>
                            <line x1="25" y1="475" x2="425" y2="475" stroke-width="3"/>
                        </g>
                        <!-- ç«–çº¿ - æ ‡å‡†ä¸­å›½è±¡æ£‹åˆ†æ®µè®¾è®¡ -->
                        <g stroke="#654321" stroke-width="2" fill="none">
                            <!-- å·¦å³è¾¹ç•Œç«–çº¿ï¼ˆå®Œæ•´è´¯é€šï¼‰ -->
                            <line x1="25" y1="25" x2="25" y2="475" stroke-width="3"/>
                            <line x1="425" y1="25" x2="425" y2="475" stroke-width="3"/>
                            
                            <!-- ä¸­é—´ç«–çº¿ - æ²³ç•Œåˆ†æ®µï¼ˆä¸ŠåŠéƒ¨ï¼šé»‘æ–¹åŒºåŸŸï¼‰ -->
                            <line x1="75" y1="25" x2="75" y2="225" stroke-width="2"/>
                            <line x1="125" y1="25" x2="125" y2="225" stroke-width="2"/>
                            <line x1="175" y1="25" x2="175" y2="225" stroke-width="2"/>
                            <line x1="225" y1="25" x2="225" y2="225" stroke-width="2.5"/>
                            <line x1="275" y1="25" x2="275" y2="225" stroke-width="2"/>
                            <line x1="325" y1="25" x2="325" y2="225" stroke-width="2"/>
                            <line x1="375" y1="25" x2="375" y2="225" stroke-width="2"/>
                            
                            <!-- ä¸­é—´ç«–çº¿ - æ²³ç•Œåˆ†æ®µï¼ˆä¸‹åŠéƒ¨ï¼šçº¢æ–¹åŒºåŸŸï¼‰ -->
                            <line x1="75" y1="275" x2="75" y2="475" stroke-width="2"/>
                            <line x1="125" y1="275" x2="125" y2="475" stroke-width="2"/>
                            <line x1="175" y1="275" x2="175" y2="475" stroke-width="2"/>
                            <line x1="225" y1="275" x2="225" y2="475" stroke-width="2.5"/>
                            <line x1="275" y1="275" x2="275" y2="475" stroke-width="2"/>
                            <line x1="325" y1="275" x2="325" y2="475" stroke-width="2"/>
                            <line x1="375" y1="275" x2="375" y2="475" stroke-width="2"/>
                        </g>
                        <!-- å£«çº¿ï¼ˆä¹å®«æ ¼å¯¹è§’çº¿ï¼‰- Chess-Puzzleå¢å¼ºæ˜¾ç¤º -->
                        <g id="palaceLines" stroke="#8B4513" stroke-width="2.5" fill="none" opacity="0.9">
                            <!-- é»‘æ–¹ä¹å®«æ ¼å£«çº¿ï¼ˆå°†å¸…å®«å†…å¯¹è§’çº¿ï¼‰ -->
                            <line x1="175" y1="25" x2="275" y2="125" stroke-linecap="round" class="palace-line"/>
                            <line x1="275" y1="25" x2="175" y2="125" stroke-linecap="round" class="palace-line"/>
                            <!-- çº¢æ–¹ä¹å®«æ ¼å£«çº¿ï¼ˆå°†å¸…å®«å†…å¯¹è§’çº¿ï¼‰ -->
                            <line x1="175" y1="375" x2="275" y2="475" stroke-linecap="round" class="palace-line"/>
                            <line x1="275" y1="375" x2="175" y2="475" stroke-linecap="round" class="palace-line"/>
                        </g>
                        
                        <!-- Chess-Puzzleæ¨¡å¼ä¸‹çš„å£«çº¿é˜´å½±å¢å¼º -->
                        <g stroke="#654321" stroke-width="3" fill="none" opacity="0.3">
                            <!-- å£«çº¿é˜´å½±æ•ˆæœ -->
                            <line x1="176" y1="26" x2="276" y2="126" stroke-linecap="round"/>
                            <line x1="276" y1="26" x2="176" y2="126" stroke-linecap="round"/>
                            <line x1="176" y1="376" x2="276" y2="476" stroke-linecap="round"/>
                            <line x1="276" y1="376" x2="176" y2="476" stroke-linecap="round"/>
                        </g>
                        
                        <!-- ä¼ ç»Ÿä¹å®«æ ¼æ ‡è®° -->
                        <g stroke="#654321" stroke-width="1.5" fill="none" opacity="0.6">
                            <!-- é»‘æ–¹ä¹å®«æ ¼è¾¹ç•Œçº¿ -->
                            <rect x="175" y="25" width="100" height="100" stroke-dasharray="3,2"/>
                            <!-- çº¢æ–¹ä¹å®«æ ¼è¾¹ç•Œçº¿ -->
                            <rect x="175" y="375" width="100" height="100" stroke-dasharray="3,2"/>
                        </g>
                        
                        <!-- ç‚®ä½æ ‡è®°ï¼ˆä¼ ç»Ÿè±¡æ£‹æ£‹ç›˜ç‰¹è‰²ï¼‰ -->
                        <g stroke="#654321" stroke-width="1.2" fill="none" opacity="0.5">
                            <!-- é»‘æ–¹ç‚®ä½æ ‡è®° -->
                            <g transform="translate(75,125)">
                                <line x1="-3" y1="-3" x2="3" y2="-3"/>
                                <line x1="-3" y1="3" x2="3" y2="3"/>
                                <line x1="-3" y1="-3" x2="-3" y2="3"/>
                                <line x1="3" y1="-3" x2="3" y2="3"/>
                            </g>
                            <g transform="translate(375,125)">
                                <line x1="-3" y1="-3" x2="3" y2="-3"/>
                                <line x1="-3" y1="3" x2="3" y2="3"/>
                                <line x1="-3" y1="-3" x2="-3" y2="3"/>
                                <line x1="3" y1="-3" x2="3" y2="3"/>
                            </g>
                            <!-- çº¢æ–¹ç‚®ä½æ ‡è®° -->
                            <g transform="translate(75,375)">
                                <line x1="-3" y1="-3" x2="3" y2="-3"/>
                                <line x1="-3" y1="3" x2="3" y2="3"/>
                                <line x1="-3" y1="-3" x2="-3" y2="3"/>
                                <line x1="3" y1="-3" x2="3" y2="3"/>
                            </g>
                            <g transform="translate(375,375)">
                                <line x1="-3" y1="-3" x2="3" y2="-3"/>
                                <line x1="-3" y1="3" x2="3" y2="3"/>
                                <line x1="-3" y1="-3" x2="-3" y2="3"/>
                                <line x1="3" y1="-3" x2="3" y2="3"/>
                            </g>
                        </g>
                        <!-- é‡è¦äº¤å‰ç‚¹æ ‡è®° -->
                        <g fill="#654321" opacity="0.6">
                            <!-- ä¹å®«æ ¼ä¸­å¿ƒç‚¹ -->
                            <circle cx="225" cy="75" r="2" stroke="#8B4513" stroke-width="0.5"/>
                            <circle cx="225" cy="425" r="2" stroke="#8B4513" stroke-width="0.5"/>
                            <!-- ä¹å®«æ ¼è§’ç‚¹ -->
                            <circle cx="175" cy="25" r="1.5"/>
                            <circle cx="275" cy="25" r="1.5"/>
                            <circle cx="175" cy="125" r="1.5"/>
                            <circle cx="275" cy="125" r="1.5"/>
                            <circle cx="175" cy="375" r="1.5"/>
                            <circle cx="275" cy="375" r="1.5"/>
                            <circle cx="175" cy="475" r="1.5"/>
                            <circle cx="275" cy="475" r="1.5"/>
                        </g>
                        <!-- ä¼ ç»Ÿæ¥šæ²³æ±‰ç•Œæ–‡å­— -->
                        <g font-family="Microsoft YaHei, KaiTi, serif" font-size="20" font-weight="bold" fill="#654321" text-anchor="middle" opacity="0.9">
                            <!-- æ¥šæ²³æ±‰ç•ŒèƒŒæ™¯ -->
                            <rect x="70" y="240" width="60" height="25" fill="rgba(212,176,138,0.8)" rx="3"/>
                            <rect x="320" y="240" width="60" height="25" fill="rgba(212,176,138,0.8)" rx="3"/>
                            <!-- æ–‡å­—å†…å®¹ -->
                            <text x="100" y="257" stroke="white" stroke-width="0.8" style="paint-order: stroke fill;">æ¥šæ²³</text>
                            <text x="350" y="257" stroke="white" stroke-width="0.8" style="paint-order: stroke fill;">æ±‰ç•Œ</text>
                        </g>
                    </svg>
                    <div id="boardIntersections"></div>
                    <div id="chessPieces"></div>
                </div>
                <div class="river-line">æ¥šæ²³æ±‰ç•Œ</div>
            </div>
        </section>

        <section class="move-history">
            <h3>ğŸ“œ èµ°æ£‹è®°å½•</h3>
            <div id="moveList">
                <div class="move-item">
                    <span>æ¸¸æˆå¼€å§‹</span>
                    <span>--</span>
                </div>
            </div>
        </section>

        <section class="instructions">
            <h3>ğŸ® æ¸¸æˆè§„åˆ™</h3>
            <div class="instruction-grid">
                <div class="instruction-item">
                    <h4>åŸºæœ¬è§„åˆ™</h4>
                    <p>çº¢æ–¹å…ˆè¡Œï¼Œè½®æµèµ°æ£‹ï¼Œç›®æ ‡æ˜¯å°†æ­»å¯¹æ–¹çš„å°†ï¼ˆå¸…ï¼‰</p>
                </div>
                <div class="instruction-item">
                    <h4>æ£‹å­èµ°æ³•</h4>
                    <p>æ¯ç§æ£‹å­éƒ½æœ‰ç‰¹å®šçš„èµ°æ³•è§„åˆ™ï¼Œä¸èƒ½è¶Šå­è¡Œèµ°</p>
                </div>
                <div class="instruction-item">
                    <h4>èƒœè´Ÿæ¡ä»¶</h4>
                    <p>å°†æ­»å¯¹æ–¹æˆ–å¯¹æ–¹æ— å­å¯èµ°æ—¶è·èƒœ</p>
                </div>
                <div class="instruction-item">
                    <h4>æ“ä½œæ–¹å¼</h4>
                    <p>ç‚¹å‡»æ£‹å­é€‰æ‹©ï¼Œå†ç‚¹å‡»ç›®æ ‡ä½ç½®å®Œæˆç§»åŠ¨</p>
                </div>
            </div>
        </section>

        <!-- æ¸¸æˆç»“æŸå¼¹çª— -->
        <div class="game-over-overlay" id="gameOverOverlay">
            <div class="game-over-content">
                <div class="celebration">ğŸ‘‘</div>
                <h2>æ¸¸æˆç»“æŸï¼</h2>
                <div class="winner-text" id="winnerText">çº¢æ–¹è·èƒœï¼</div>
                <div style="display: flex; gap: 15px; justify-content: center;">
                    <button class="btn" onclick="chineseChess.newGame()">å†æ¥ä¸€å±€</button>
                    <button class="btn secondary" onclick="chineseChess.closeGameOver()">è¿”å›</button>
                </div>
            </div>
        </div>
    </main>

    <script>
        class ChineseChess {
            constructor() {
                this.board = [];
                this.currentPlayer = 'red'; // red or black
                this.selectedPiece = null;
                this.gameOver = false;
                this.aiMode = false;
                this.moveHistory = [];
                this.possibleMoves = [];
                
                // è±¡æ£‹æ®‹å±€ä¸“ç”¨çŠ¶æ€
                this.endgameMode = false; // æ˜¯å¦å¤„äºæ®‹å±€æ¨¡å¼
                this.currentEndgameData = null; // å½“å‰æ®‹å±€æ•°æ®
                this.endgameStartTime = null; // æ®‹å±€å¼€å§‹æ—¶é—´
                
                // Chess-Puzzleè±¡æ£‹æ®‹å±€æ¸¸æˆä¸“ç”¨çŠ¶æ€
                this.chessPuzzleMode = false; // ä¸“ä¸šè°œé¢˜æ¨¡å¼
                this.puzzleDifficulty = 'medium'; // è°œé¢˜éš¾åº¦: easy, medium, hard
                this.puzzleSolved = false; // è°œé¢˜æ˜¯å¦å·²è§£å†³
                this.puzzleHints = 0; // ä½¿ç”¨æç¤ºæ¬¡æ•°
                this.puzzleMoves = []; // è°œé¢˜æœ€ä½³è§£æ³•
                
                // æ£‹å­å®šä¹‰
                this.pieces = {
                    red: {
                        å°†: 'å¸…', å£«: 'ä»•', è±¡: 'ç›¸', é©¬: 'é©¬', è½¦: 'è½¦', ç‚®: 'ç‚®', å…µ: 'å…µ'
                    },
                    black: {
                        å°†: 'å°†', å£«: 'å£«', è±¡: 'è±¡', é©¬: 'é©¬', è½¦: 'è½¦', ç‚®: 'ç‚®', å…µ: 'å’'
                    }
                };
                
                this.init();
            }

            init() {
                this.createBoard();
                this.setupInitialPosition();
                this.updateDisplay();
            }

            createBoard() {
                const intersectionsContainer = document.getElementById('boardIntersections');
                intersectionsContainer.innerHTML = '';
                
                // æ ¹æ®å±å¹•å¤§å°è°ƒæ•´æ£‹ç›˜å°ºå¯¸
                const isMobile = window.innerWidth <= 768;
                const isSmallMobile = window.innerWidth <= 480;
                const gridSize = isSmallMobile ? 36 : (isMobile ? 40 : 50);
                const boardOffset = isSmallMobile ? 20 : (isMobile ? 22 : 25);
                
                // åˆ›å»º10x9çš„äº¤å‰ç‚¹
                for (let row = 0; row < 10; row++) {
                    this.board[row] = [];
                    for (let col = 0; col < 9; col++) {
                        const intersection = document.createElement('div');
                        intersection.className = 'board-intersection';
                        intersection.dataset.row = row;
                        intersection.dataset.col = col;
                        intersection.style.left = (boardOffset + col * gridSize) + 'px';
                        intersection.style.top = (boardOffset + row * gridSize) + 'px';
                        intersection.addEventListener('click', () => this.handleIntersectionClick(row, col));
                        
                        intersectionsContainer.appendChild(intersection);
                        this.board[row][col] = null;
                    }
                }
            }

            setupInitialPosition() {
                // æ¸…ç©ºæ£‹ç›˜
                for (let row = 0; row < 10; row++) {
                    for (let col = 0; col < 9; col++) {
                        this.board[row][col] = null;
                    }
                }
                
                // é»‘æ–¹æ£‹å­ (ä¸Šæ–¹)
                const blackLayout = [
                    ['è½¦', 'é©¬', 'è±¡', 'å£«', 'å°†', 'å£«', 'è±¡', 'é©¬', 'è½¦'],
                    [null, null, null, null, null, null, null, null, null],
                    [null, 'ç‚®', null, null, null, null, null, 'ç‚®', null],
                    ['å…µ', null, 'å…µ', null, 'å…µ', null, 'å…µ', null, 'å…µ']
                ];
                
                for (let row = 0; row < blackLayout.length; row++) {
                    for (let col = 0; col < blackLayout[row].length; col++) {
                        if (blackLayout[row][col]) {
                            this.board[row][col] = {
                                type: blackLayout[row][col],
                                color: 'black'
                            };
                        }
                    }
                }
                
                // çº¢æ–¹æ£‹å­ (ä¸‹æ–¹)
                const redLayout = [
                    ['å…µ', null, 'å…µ', null, 'å…µ', null, 'å…µ', null, 'å…µ'],
                    [null, 'ç‚®', null, null, null, null, null, 'ç‚®', null],
                    [null, null, null, null, null, null, null, null, null],
                    ['è½¦', 'é©¬', 'è±¡', 'å£«', 'å°†', 'å£«', 'è±¡', 'é©¬', 'è½¦']
                ];
                
                for (let row = 0; row < redLayout.length; row++) {
                    for (let col = 0; col < redLayout[row].length; col++) {
                        if (redLayout[row][col]) {
                            this.board[6 + row][col] = {
                                type: redLayout[row][col],
                                color: 'red'
                            };
                        }
                    }
                }
                
                this.renderBoard();
            }

            renderBoard() {
                const piecesContainer = document.getElementById('chessPieces');
                const intersections = document.querySelectorAll('.board-intersection');
                
                // æ¸…é™¤ç°æœ‰æ£‹å­
                piecesContainer.innerHTML = '';
                
                // æ¸…é™¤äº¤å‰ç‚¹æ ·å¼
                intersections.forEach(intersection => {
                    intersection.classList.remove('selected', 'possible-move');
                });
                
                // æ ¹æ®å±å¹•å¤§å°è°ƒæ•´æ£‹å­ä½ç½®
                const isMobile = window.innerWidth <= 768;
                const isSmallMobile = window.innerWidth <= 480;
                const gridSize = isSmallMobile ? 36 : (isMobile ? 40 : 50);
                const boardOffset = isSmallMobile ? 20 : (isMobile ? 22 : 25);
                
                // æ£‹å­æ˜¾ç¤ºæ¨¡å¼æ£€æµ‹
                const isEndgameMode = this.endgameMode;
                const isPuzzleMode = this.chessPuzzleMode;
                
                // ç»˜åˆ¶æ£‹å­ - ç¡®ä¿ç²¾ç¡®å±…ä¸­åœ¨äº¤å‰çº¿äº¤ç‚¹ä¸Š
                for (let row = 0; row < 10; row++) {
                    for (let col = 0; col < 9; col++) {
                        const piece = this.board[row][col];
                        if (piece) {
                            const pieceElement = document.createElement('div');
                            pieceElement.className = `chess-piece ${piece.color}`;
                            
                            // æ®‹å±€æ¨¡å¼ä¸‹æ£‹å­å¢å¼ºæ˜¾ç¤º
                            if (isEndgameMode) {
                                pieceElement.classList.add('endgame-piece');
                            }
                            
                            // Chess-Puzzleè°œé¢˜æ¨¡å¼ä¸‹çš„ä¸“ç”¨æ ·å¼
                            if (isPuzzleMode) {
                                pieceElement.classList.add('puzzle-piece');
                            }
                            
                            pieceElement.textContent = this.pieces[piece.color][piece.type];
                            // ç²¾ç¡®å®šä½åœ¨äº¤å‰çº¿äº¤ç‚¹ä¸Š
                            pieceElement.style.left = (boardOffset + col * gridSize) + 'px';
                            pieceElement.style.top = (boardOffset + row * gridSize) + 'px';
                            pieceElement.addEventListener('click', () => this.handlePieceClick(row, col));
                            piecesContainer.appendChild(pieceElement);
                        }
                    }
                }
                
                // æ ‡è®°é€‰ä¸­çš„äº¤å‰ç‚¹
                if (this.selectedPiece) {
                    const selectedIntersection = document.querySelector(`.board-intersection[data-row="${this.selectedPiece.row}"][data-col="${this.selectedPiece.col}"]`);
                    if (selectedIntersection) {
                        selectedIntersection.classList.add('selected');
                    }
                }
                
                // æ ‡è®°å¯èƒ½çš„ç§»åŠ¨
                this.possibleMoves.forEach(move => {
                    const intersection = document.querySelector(`.board-intersection[data-row="${move.row}"][data-col="${move.col}"]`);
                    if (intersection) {
                        intersection.classList.add('possible-move');
                    }
                });
            }

            handleIntersectionClick(row, col) {
                if (this.gameOver) return;
                
                const piece = this.board[row][col];
                
                if (this.selectedPiece) {
                    // å¦‚æœå·²ç»é€‰æ‹©äº†æ£‹å­ï¼Œå°è¯•ç§»åŠ¨
                    const isInMoveList = this.possibleMoves.some(move => move.row === row && move.col === col);
                    
                    if (isInMoveList) {
                        // æ‰§è¡Œç§»åŠ¨ï¼ˆåŒ…æ‹¬åƒå­ï¼‰
                        this.makeMove(this.selectedPiece.row, this.selectedPiece.col, row, col);
                        this.selectedPiece = null;
                        this.possibleMoves = [];
                    } else if (piece && piece.color === this.currentPlayer) {
                        // é€‰æ‹©åŒè‰²æ£‹å­
                        this.selectPiece(row, col);
                    } else {
                        // å–æ¶ˆé€‰æ‹©
                        this.selectedPiece = null;
                        this.possibleMoves = [];
                    }
                } else {
                    // é€‰æ‹©æ£‹å­
                    if (piece && piece.color === this.currentPlayer) {
                        this.selectPiece(row, col);
                    }
                }
                
                this.renderBoard();
                this.updateDisplay();
            }

            handlePieceClick(row, col) {
                if (this.gameOver) return;
                
                const piece = this.board[row][col];
                
                // å¦‚æœæ˜¯å·±æ–¹æ£‹å­ï¼Œé€‰æ‹©å®ƒ
                if (piece && piece.color === this.currentPlayer) {
                    this.selectPiece(row, col);
                    this.renderBoard();
                    this.updateDisplay();
                } else {
                    // å¦‚æœæ˜¯æ•Œæ–¹æ£‹å­æˆ–ç©ºä½ï¼Œè½¬å‘ç»™äº¤å‰ç‚¹å¤„ç†å™¨
                    this.handleIntersectionClick(row, col);
                }
            }

            selectPiece(row, col) {
                this.selectedPiece = { row, col };
                this.possibleMoves = this.getPossibleMoves(row, col);
            }

            getPossibleMoves(row, col) {
                const piece = this.board[row][col];
                if (!piece) return [];
                
                let moves = [];
                
                // æ ¹æ®æ£‹å­ç±»å‹è®¡ç®—å¯èƒ½çš„ç§»åŠ¨
                switch (piece.type) {
                    case 'å°†':
                        moves = this.getGeneralMoves(row, col, piece.color);
                        break;
                    case 'å£«':
                        moves = this.getAdvisorMoves(row, col, piece.color);
                        break;
                    case 'è±¡':
                        moves = this.getElephantMoves(row, col, piece.color);
                        break;
                    case 'é©¬':
                        moves = this.getHorseMoves(row, col);
                        break;
                    case 'è½¦':
                        moves = this.getChariotMoves(row, col);
                        break;
                    case 'ç‚®':
                        moves = this.getCannonMoves(row, col);
                        break;
                    case 'å…µ':
                        moves = this.getSoldierMoves(row, col, piece.color);
                        break;
                    default:
                        moves = [];
                }
                
                // é¢å¤–éªŒè¯ï¼šç¡®ä¿æ‰€æœ‰ç§»åŠ¨éƒ½æ˜¯æœ‰æ•ˆçš„
                const validMoves = moves.filter(move => {
                    // æ£€æŸ¥è¾¹ç•Œ
                    if (move.row < 0 || move.row >= 10 || move.col < 0 || move.col >= 9) {
                        return false;
                    }
                    
                    const targetPiece = this.board[move.row][move.col];
                    // ä¸èƒ½ç§»åŠ¨åˆ°å·±æ–¹æ£‹å­ä½ç½®
                    if (targetPiece && targetPiece.color === piece.color) {
                        return false;
                    }
                    
                    return true;
                });
                
                return validMoves;
            }

            getGeneralMoves(row, col, color) {
                const moves = [];
                const directions = [[0, 1], [0, -1], [1, 0], [-1, 0]];
                
                // å°†ï¼ˆå¸…ï¼‰åªèƒ½åœ¨ä¹å®«æ ¼å†…ç§»åŠ¨
                const palaceArea = color === 'red' ? 
                    { minRow: 7, maxRow: 9, minCol: 3, maxCol: 5 } :
                    { minRow: 0, maxRow: 2, minCol: 3, maxCol: 5 };
                
                directions.forEach(([dr, dc]) => {
                    const newRow = row + dr;
                    const newCol = col + dc;
                    
                    if (newRow >= palaceArea.minRow && newRow <= palaceArea.maxRow &&
                        newCol >= palaceArea.minCol && newCol <= palaceArea.maxCol) {
                        // æ£€æŸ¥ç›®æ ‡ä½ç½®ï¼šç©ºä½æˆ–æ•Œæ–¹æ£‹å­éƒ½å¯ä»¥ç§»åŠ¨
                        const targetPiece = this.board[newRow][newCol];
                        if (!targetPiece || targetPiece.color !== color) {
                            moves.push({ row: newRow, col: newCol });
                        }
                    }
                });
                
                return moves;
            }

            getAdvisorMoves(row, col, color) {
                const moves = [];
                const directions = [[1, 1], [1, -1], [-1, 1], [-1, -1]];
                
                // å£«åªèƒ½åœ¨ä¹å®«æ ¼å†…æ–œå‘ç§»åŠ¨
                const palaceArea = color === 'red' ? 
                    { minRow: 7, maxRow: 9, minCol: 3, maxCol: 5 } :
                    { minRow: 0, maxRow: 2, minCol: 3, maxCol: 5 };
                
                directions.forEach(([dr, dc]) => {
                    const newRow = row + dr;
                    const newCol = col + dc;
                    
                    if (newRow >= palaceArea.minRow && newRow <= palaceArea.maxRow &&
                        newCol >= palaceArea.minCol && newCol <= palaceArea.maxCol) {
                        // æ£€æŸ¥ç›®æ ‡ä½ç½®ï¼šç©ºä½æˆ–æ•Œæ–¹æ£‹å­éƒ½å¯ä»¥ç§»åŠ¨
                        const targetPiece = this.board[newRow][newCol];
                        if (!targetPiece || targetPiece.color !== color) {
                            moves.push({ row: newRow, col: newCol });
                        }
                    }
                });
                
                return moves;
            }

            getElephantMoves(row, col, color) {
                const moves = [];
                const directions = [[2, 2], [2, -2], [-2, 2], [-2, -2]];
                
                directions.forEach(([dr, dc]) => {
                    const newRow = row + dr;
                    const newCol = col + dc;
                    const blockRow = row + dr / 2;
                    const blockCol = col + dc / 2;
                    
                    // è±¡ä¸èƒ½è¿‡æ²³ï¼Œä¸èƒ½è¢«"è¹©è±¡çœ¼"
                    if ((color === 'red' && newRow >= 5) || (color === 'black' && newRow <= 4)) {
                        if (newRow >= 0 && newRow < 10 && newCol >= 0 && newCol < 9 &&
                            !this.board[blockRow][blockCol]) {
                            // æ£€æŸ¥ç›®æ ‡ä½ç½®ï¼šç©ºä½æˆ–æ•Œæ–¹æ£‹å­éƒ½å¯ä»¥ç§»åŠ¨
                            const targetPiece = this.board[newRow][newCol];
                            if (!targetPiece || targetPiece.color !== color) {
                                moves.push({ row: newRow, col: newCol });
                            }
                        }
                    }
                });
                
                return moves;
            }

            getHorseMoves(row, col) {
                const moves = [];
                const currentPiece = this.board[row][col];
                const horseMoves = [
                    { dr: -2, dc: -1, blockRow: -1, blockCol: 0 },
                    { dr: -2, dc: 1, blockRow: -1, blockCol: 0 },
                    { dr: -1, dc: -2, blockRow: 0, blockCol: -1 },
                    { dr: -1, dc: 2, blockRow: 0, blockCol: 1 },
                    { dr: 1, dc: -2, blockRow: 0, blockCol: -1 },
                    { dr: 1, dc: 2, blockRow: 0, blockCol: 1 },
                    { dr: 2, dc: -1, blockRow: 1, blockCol: 0 },
                    { dr: 2, dc: 1, blockRow: 1, blockCol: 0 }
                ];
                
                horseMoves.forEach(({ dr, dc, blockRow, blockCol }) => {
                    const newRow = row + dr;
                    const newCol = col + dc;
                    const legRow = row + blockRow;
                    const legCol = col + blockCol;
                    
                    if (newRow >= 0 && newRow < 10 && newCol >= 0 && newCol < 9 &&
                        !this.board[legRow][legCol]) {
                        // æ£€æŸ¥ç›®æ ‡ä½ç½®ï¼šç©ºä½æˆ–æ•Œæ–¹æ£‹å­éƒ½å¯ä»¥ç§»åŠ¨
                        const targetPiece = this.board[newRow][newCol];
                        if (!targetPiece || targetPiece.color !== currentPiece.color) {
                            moves.push({ row: newRow, col: newCol });
                        }
                    }
                });
                
                return moves;
            }

            getChariotMoves(row, col) {
                const moves = [];
                const currentPiece = this.board[row][col];
                const directions = [[0, 1], [0, -1], [1, 0], [-1, 0]];
                
                directions.forEach(([dr, dc]) => {
                    for (let i = 1; i < 10; i++) {
                        const newRow = row + dr * i;
                        const newCol = col + dc * i;
                        
                        // æ£€æŸ¥è¾¹ç•Œ
                        if (newRow < 0 || newRow >= 10 || newCol < 0 || newCol >= 9) break;
                        
                        const targetPiece = this.board[newRow][newCol];
                        
                        if (targetPiece) {
                            // å¦‚æœæœ‰æ£‹å­ï¼Œæ£€æŸ¥æ˜¯å¦å¯ä»¥åƒæ‰
                            if (targetPiece.color !== currentPiece.color) {
                                // æ•Œæ–¹æ£‹å­ï¼Œå¯ä»¥åƒæ‰
                                moves.push({ row: newRow, col: newCol });
                            }
                            // æ— è®ºæ˜¯å¦èƒ½åƒæ‰ï¼Œéƒ½è¦åœæ­¢ç»§ç»­ç§»åŠ¨
                            break;
                        } else {
                            // ç©ºä½ï¼Œå¯ä»¥ç§»åŠ¨
                            moves.push({ row: newRow, col: newCol });
                        }
                    }
                });
                
                return moves;
            }

            getCannonMoves(row, col) {
                const moves = [];
                const currentPiece = this.board[row][col];
                const directions = [[0, 1], [0, -1], [1, 0], [-1, 0]];
                
                directions.forEach(([dr, dc]) => {
                    let hasJumped = false;
                    
                    for (let i = 1; i < 10; i++) {
                        const newRow = row + dr * i;
                        const newCol = col + dc * i;
                        
                        // æ£€æŸ¥è¾¹ç•Œ
                        if (newRow < 0 || newRow >= 10 || newCol < 0 || newCol >= 9) break;
                        
                        const targetPiece = this.board[newRow][newCol];
                        
                        if (targetPiece) {
                            if (!hasJumped) {
                                // ç¬¬ä¸€ä¸ªæ£‹å­ä½œä¸º"ç‚®æ¶"
                                hasJumped = true;
                            } else {
                                // é‡åˆ°ç¬¬äºŒä¸ªæ£‹å­ï¼Œæ£€æŸ¥æ˜¯å¦å¯ä»¥åƒæ‰
                                if (targetPiece.color !== currentPiece.color) {
                                    // æ•Œæ–¹æ£‹å­ï¼Œå¯ä»¥åƒæ‰
                                    moves.push({ row: newRow, col: newCol });
                                }
                                // æ— è®ºæ˜¯å¦èƒ½åƒæ‰ï¼Œéƒ½è¦åœæ­¢
                                break;
                            }
                        } else if (!hasJumped) {
                            // æ²¡æœ‰è·³è·ƒæ—¶ï¼Œç©ºä½å¯ä»¥ç§»åŠ¨
                            moves.push({ row: newRow, col: newCol });
                        }
                        // å¦‚æœå·²ç»è·³è·ƒä½†æ˜¯ç©ºä½ï¼Œç»§ç»­å¯»æ‰¾ç›®æ ‡
                    }
                });
                
                return moves;
            }

            getSoldierMoves(row, col, color) {
                const moves = [];
                
                if (color === 'red') {
                    // çº¢å…µå‘ä¸Šç§»åŠ¨
                    if (row > 0) {
                        const targetPiece = this.board[row - 1][col];
                        if (!targetPiece || targetPiece.color !== color) {
                            moves.push({ row: row - 1, col });
                        }
                    }
                    // è¿‡æ²³åå¯ä»¥å·¦å³ç§»åŠ¨
                    if (row <= 4) {
                        if (col > 0) {
                            const targetPiece = this.board[row][col - 1];
                            if (!targetPiece || targetPiece.color !== color) {
                                moves.push({ row, col: col - 1 });
                            }
                        }
                        if (col < 8) {
                            const targetPiece = this.board[row][col + 1];
                            if (!targetPiece || targetPiece.color !== color) {
                                moves.push({ row, col: col + 1 });
                            }
                        }
                    }
                } else {
                    // é»‘å’å‘ä¸‹ç§»åŠ¨
                    if (row < 9) {
                        const targetPiece = this.board[row + 1][col];
                        if (!targetPiece || targetPiece.color !== color) {
                            moves.push({ row: row + 1, col });
                        }
                    }
                    // è¿‡æ²³åå¯ä»¥å·¦å³ç§»åŠ¨
                    if (row >= 5) {
                        if (col > 0) {
                            const targetPiece = this.board[row][col - 1];
                            if (!targetPiece || targetPiece.color !== color) {
                                moves.push({ row, col: col - 1 });
                            }
                        }
                        if (col < 8) {
                            const targetPiece = this.board[row][col + 1];
                            if (!targetPiece || targetPiece.color !== color) {
                                moves.push({ row, col: col + 1 });
                            }
                        }
                    }
                }
                
                return moves;
            }

            isValidMove(fromRow, fromCol, toRow, toCol) {
                // æ£€æŸ¥ç›®æ ‡ä½ç½®æ˜¯å¦åœ¨æ£‹ç›˜å†…
                if (toRow < 0 || toRow >= 10 || toCol < 0 || toCol >= 9) return false;
                
                const fromPiece = this.board[fromRow][fromCol];
                const toPiece = this.board[toRow][toCol];
                
                // å¿…é¡»æœ‰èµ·å§‹æ£‹å­
                if (!fromPiece) return false;
                
                // ä¸èƒ½ç§»åŠ¨åˆ°æœ‰å·±æ–¹æ£‹å­çš„ä½ç½®
                if (toPiece && toPiece.color === fromPiece.color) return false;
                
                // å¯ä»¥ç§»åŠ¨åˆ°ç©ºä½æˆ–æ•Œæ–¹æ£‹å­ä½ç½®
                return true;
            }


            makeMove(fromRow, fromCol, toRow, toCol) {
                const piece = this.board[fromRow][fromCol];
                const capturedPiece = this.board[toRow][toCol];
                
                // è®°å½•ç§»åŠ¨
                this.moveHistory.push({
                    from: { row: fromRow, col: fromCol },
                    to: { row: toRow, col: toCol },
                    piece: { ...piece },
                    captured: capturedPiece ? { ...capturedPiece } : null
                });
                
                // æ‰§è¡Œç§»åŠ¨
                this.board[toRow][toCol] = piece;
                this.board[fromRow][fromCol] = null;
                
                // æ£€æŸ¥æ¸¸æˆç»“æŸæ¡ä»¶
                if (capturedPiece && capturedPiece.type === 'å°†') {
                    this.gameOver = true;
                    this.showGameOver();
                } else {
                    // åˆ‡æ¢ç©å®¶
                    this.currentPlayer = this.currentPlayer === 'red' ? 'black' : 'red';
                    
                    // AIå›åˆ
                    if (this.aiMode && this.currentPlayer === 'black') {
                        setTimeout(() => this.makeAIMove(), 1000);
                    }
                }
                
                this.updateMoveHistory();
            }

            makeAIMove() {
                // ç®€å•AIï¼šéšæœºé€‰æ‹©ä¸€ä¸ªæœ‰æ•ˆç§»åŠ¨
                const allMoves = [];
                
                for (let row = 0; row < 10; row++) {
                    for (let col = 0; col < 9; col++) {
                        const piece = this.board[row][col];
                        if (piece && piece.color === 'black') {
                            const moves = this.getPossibleMoves(row, col);
                            moves.forEach(move => {
                                allMoves.push({
                                    from: { row, col },
                                    to: move
                                });
                            });
                        }
                    }
                }
                
                if (allMoves.length > 0) {
                    const randomMove = allMoves[Math.floor(Math.random() * allMoves.length)];
                    this.makeMove(randomMove.from.row, randomMove.from.col, randomMove.to.row, randomMove.to.col);
                    this.renderBoard();
                    this.updateDisplay();
                }
            }

            undoMove() {
                if (this.moveHistory.length === 0) return;
                
                const lastMove = this.moveHistory.pop();
                
                // æ¢å¤æ£‹å­ä½ç½®
                this.board[lastMove.from.row][lastMove.from.col] = lastMove.piece;
                this.board[lastMove.to.row][lastMove.to.col] = lastMove.captured;
                
                // æ¢å¤ç©å®¶å›åˆ
                this.currentPlayer = this.currentPlayer === 'red' ? 'black' : 'red';
                
                this.selectedPiece = null;
                this.possibleMoves = [];
                this.renderBoard();
                this.updateDisplay();
                this.updateMoveHistory();
            }

            showHint() {
                if (this.endgameMode && this.currentEndgameData) {
                    // æ®‹å±€æ¨¡å¼ä¸‹çš„ä¸“é—¨æç¤º
                    this.showEndgameHint();
                } else if (this.selectedPiece) {
                    // æ˜¾ç¤ºé€‰ä¸­æ£‹å­çš„å¯èƒ½ç§»åŠ¨
                    this.renderBoard();
                } else {
                    alert('ğŸ’¡ æç¤ºï¼šå…ˆé€‰æ‹©ä¸€ä¸ªæ£‹å­ï¼Œå†æŸ¥çœ‹å®ƒçš„å¯èƒ½ç§»åŠ¨ä½ç½®');
                }
            }

            // æ®‹å±€ä¸“ç”¨æç¤ºåŠŸèƒ½
            showEndgameHint() {
                const endgame = this.currentEndgameData;
                let hintMessage = `ğŸ æ®‹å±€æç¤ºï¼š${endgame.name}\n\n`;
                hintMessage += `ğŸ“ è¯´æ˜ï¼š${endgame.description}\n\n`;
                
                // æ ¹æ®æ®‹å±€ç±»å‹ç»™å‡ºé€šç”¨æç¤º
                if (endgame.name.includes('è½¦')) {
                    hintMessage += `ğŸ’¡ è½¦ç±»æ®‹å±€è¦ç‚¹ï¼š\n- åˆ©ç”¨è½¦çš„ç›´çº¿æ”»å‡»åŠ›\n- æ§åˆ¶å…³é”®çº¿è·¯\n- é…åˆå…¶ä»–æ£‹å­å½¢æˆæ€åŠ¿`;
                } else if (endgame.name.includes('é©¬')) {
                    hintMessage += `ğŸ’¡ é©¬ç±»æ®‹å±€è¦ç‚¹ï¼š\n- æ³¨æ„é©¬è„šçš„è¿ç”¨\n- å¯»æ‰¾è·³è·ƒæ”»å‡»è·¯çº¿\n- é…åˆå…µåŠ›æ¨è¿›`;
                } else if (endgame.name.includes('å…µ')) {
                    hintMessage += `ğŸ’¡ å…µç±»æ®‹å±€è¦ç‚¹ï¼š\n- å…µçš„æ¨è¿›èŠ‚å¥å¾ˆå…³é”®\n- è¿‡æ²³å…µå¨åŠ›å¤§å¢\n- æ³¨æ„å…µçš„é…åˆ`;
                } else if (endgame.name.includes('ç‚®')) {
                    hintMessage += `ğŸ’¡ ç‚®ç±»æ®‹å±€è¦ç‚¹ï¼š\n- å¯»æ‰¾åˆé€‚çš„ç‚®æ¶\n- åˆ©ç”¨ç‚®çš„è¿œç¨‹æ”»å‡»\n- æ³¨æ„ç‚®æ¶çš„ä¿æŠ¤`;
                } else {
                    hintMessage += `ğŸ’¡ é€šç”¨è¦ç‚¹ï¼š\n- ä»”ç»†è§‚å¯Ÿæ£‹å±€å½¢åŠ¿\n- å¯»æ‰¾åˆ¶èƒœå…³é”®\n- æ³¨æ„æ£‹å­é…åˆ`;
                }
                
                alert(hintMessage);
            }

            toggleAI() {
                this.aiMode = !this.aiMode;
                const aiBtn = document.getElementById('aiBtn');
                aiBtn.textContent = this.aiMode ? 'ğŸ‘¤ åŒäººå¯¹æˆ˜' : 'ğŸ¤– äººæœºå¯¹æˆ˜';
                this.updateDisplay();
            }

            newGame() {
                this.gameOver = false;
                this.currentPlayer = 'red';
                this.selectedPiece = null;
                this.possibleMoves = [];
                this.moveHistory = [];
                
                // å¦‚æœæ­£åœ¨æ®‹å±€æ¨¡å¼ï¼Œé€€å‡ºæ®‹å±€æ¨¡å¼
                if (this.endgameMode) {
                    this.endgameMode = false;
                    this.currentEndgameData = null;
                    this.endgameStartTime = null;
                    document.body.classList.remove('endgame-mode');
                    document.getElementById('endgameControls').style.display = 'none';
                }
                
                // å¦‚æœæ­£åœ¨Chess-Puzzleè°œé¢˜æ¨¡å¼ï¼Œé€€å‡ºè°œé¢˜æ¨¡å¼
                if (this.chessPuzzleMode) {
                    this.chessPuzzleMode = false;
                    this.puzzleSolved = false;
                    this.puzzleHints = 0;
                    document.body.classList.remove('chess-puzzle-mode');
                    document.getElementById('chessPuzzleControls').style.display = 'none';
                }
                
                this.setupInitialPosition();
                this.updateDisplay();
                this.updateMoveHistory();
                
                document.getElementById('gameOverOverlay').style.display = 'none';
            }

            // ç»å…¸è±¡æ£‹æ®‹å±€åº“
            endgames = [
                {
                    name: "é“é—¨é—©",
                    description: "çº¢å…ˆèƒœï¼Œç»å…¸çš„è½¦é©¬æ®‹å±€",
                    board: [
                        [null, null, null, {type: 'å£«', color: 'black'}, {type: 'å°†', color: 'black'}, {type: 'å£«', color: 'black'}, null, null, null],
                        [null, null, null, null, null, null, null, null, null],
                        [null, null, null, null, null, null, null, null, null],
                        [null, null, null, null, null, null, null, null, null],
                        [null, null, null, null, null, null, null, null, null],
                        [null, null, null, null, null, null, null, null, null],
                        [null, null, null, null, null, null, null, null, null],
                        [null, null, null, null, {type: 'é©¬', color: 'red'}, null, null, null, null],
                        [null, null, null, null, null, null, null, null, null],
                        [null, null, null, null, {type: 'å°†', color: 'red'}, null, null, {type: 'è½¦', color: 'red'}, null]
                    ]
                },
                {
                    name: "ä¸ƒæ˜Ÿèšä¼š",
                    description: "çº¢å…ˆèƒœï¼Œè‘—åçš„å¤è°±æ®‹å±€",
                    board: [
                        [null, null, null, null, {type: 'å°†', color: 'black'}, null, null, null, null],
                        [null, null, null, null, null, null, null, null, null],
                        [null, null, null, null, {type: 'å…µ', color: 'red'}, null, null, null, null],
                        [{type: 'å…µ', color: 'red'}, null, null, null, null, null, null, null, {type: 'å…µ', color: 'red'}],
                        [null, null, null, null, null, null, null, null, null],
                        [null, null, null, null, null, null, null, null, null],
                        [null, {type: 'å…µ', color: 'red'}, null, null, null, null, null, {type: 'å…µ', color: 'red'}, null],
                        [null, null, null, null, null, null, null, null, null],
                        [null, null, null, null, {type: 'å…µ', color: 'red'}, null, null, null, null],
                        [null, null, null, null, {type: 'å°†', color: 'red'}, null, null, null, {type: 'å…µ', color: 'red'}]
                    ]
                },
                {
                    name: "è½¦é©¬å†·ç€",
                    description: "çº¢å…ˆå’Œï¼Œç»å…¸çš„å’Œæ£‹æ®‹å±€",
                    board: [
                        [null, null, null, null, {type: 'å°†', color: 'black'}, null, null, null, null],
                        [null, null, null, null, null, null, null, null, null],
                        [null, null, null, null, null, null, null, null, null],
                        [null, null, null, null, null, null, null, null, null],
                        [null, null, null, null, null, null, null, null, null],
                        [null, null, null, null, null, null, null, null, null],
                        [null, null, null, null, null, null, null, null, null],
                        [null, null, null, null, {type: 'é©¬', color: 'red'}, null, null, null, null],
                        [null, null, null, null, null, null, null, null, null],
                        [{type: 'è½¦', color: 'red'}, null, null, null, {type: 'å°†', color: 'red'}, null, null, null, null]
                    ]
                },
                {
                    name: "å•è½¦éš¾èƒœ",
                    description: "å­¦ä¹ è½¦å…µæ®‹å±€çš„åŸºç¡€å±€é¢",
                    board: [
                        [null, null, null, {type: 'å£«', color: 'black'}, {type: 'å°†', color: 'black'}, {type: 'å£«', color: 'black'}, null, null, null],
                        [null, null, null, null, null, null, null, null, null],
                        [null, null, null, null, {type: 'è±¡', color: 'black'}, null, null, null, null],
                        [null, null, null, null, null, null, null, null, null],
                        [null, null, null, null, null, null, null, null, null],
                        [null, null, null, null, null, null, null, null, null],
                        [null, null, null, null, {type: 'å…µ', color: 'red'}, null, null, null, null],
                        [null, null, null, null, null, null, null, null, null],
                        [null, null, null, null, null, null, null, null, null],
                        [null, null, null, null, {type: 'å°†', color: 'red'}, null, null, {type: 'è½¦', color: 'red'}, null]
                    ]
                },
                {
                    name: "é©¬è¸å…«æ–¹",
                    description: "çº¢å…ˆèƒœï¼Œå±•ç¤ºé©¬çš„å¨åŠ›",
                    board: [
                        [null, null, null, null, {type: 'å°†', color: 'black'}, null, null, null, null],
                        [null, null, null, null, null, null, null, null, null],
                        [null, null, null, null, null, null, null, null, null],
                        [null, null, null, null, null, null, null, null, null],
                        [null, null, null, null, null, null, null, null, null],
                        [null, null, null, null, {type: 'é©¬', color: 'red'}, null, null, null, null],
                        [null, null, null, null, null, null, null, null, null],
                        [null, null, null, null, null, null, null, null, null],
                        [null, null, null, null, null, null, null, null, null],
                        [null, null, null, null, {type: 'å°†', color: 'red'}, null, null, null, null]
                    ]
                },
                {
                    name: "åƒé‡Œç‹¬è¡Œ",
                    description: "çº¢å…ˆèƒœï¼Œå•è½¦ç ´å£«è±¡å…¨",
                    board: [
                        [null, null, null, {type: 'å£«', color: 'black'}, {type: 'å°†', color: 'black'}, {type: 'å£«', color: 'black'}, null, null, null],
                        [null, null, null, null, null, null, null, null, null],
                        [null, null, null, null, {type: 'è±¡', color: 'black'}, null, null, null, null],
                        [null, null, null, null, null, null, null, null, null],
                        [null, null, null, null, null, null, null, null, null],
                        [null, null, null, null, null, null, null, null, null],
                        [null, null, null, null, null, null, null, null, null],
                        [null, null, null, null, null, null, null, null, null],
                        [null, null, null, null, null, null, null, null, null],
                        [null, null, null, null, {type: 'å°†', color: 'red'}, null, null, {type: 'è½¦', color: 'red'}, null]
                    ]
                },
                {
                    name: "æµ·åº•ææœˆ",
                    description: "çº¢å…ˆèƒœï¼Œç‚®å…µæ®‹å±€",
                    board: [
                        [null, null, null, null, {type: 'å°†', color: 'black'}, null, null, null, null],
                        [null, null, null, null, null, null, null, null, null],
                        [null, null, null, null, null, null, null, null, null],
                        [null, null, null, null, {type: 'å…µ', color: 'black'}, null, null, null, null],
                        [null, null, null, null, null, null, null, null, null],
                        [null, null, null, null, null, null, null, null, null],
                        [null, null, null, null, {type: 'å…µ', color: 'red'}, null, null, null, null],
                        [null, null, null, null, null, null, null, null, null],
                        [null, null, null, null, {type: 'ç‚®', color: 'red'}, null, null, null, null],
                        [null, null, null, null, {type: 'å°†', color: 'red'}, null, null, null, null]
                    ]
                },
                {
                    name: "èš¯èš“é™é¾™",
                    description: "çº¢å…ˆèƒœï¼Œå…µèƒœé©¬çš„ç»å…¸",
                    board: [
                        [null, null, null, null, {type: 'å°†', color: 'black'}, null, null, null, null],
                        [null, null, null, null, null, null, null, null, null],
                        [null, null, null, null, null, null, null, null, null],
                        [null, null, null, null, null, null, null, null, null],
                        [null, null, null, null, null, null, null, null, null],
                        [null, null, null, null, null, null, null, {type: 'é©¬', color: 'black'}, null],
                        [null, null, null, null, {type: 'å…µ', color: 'red'}, null, null, null, null],
                        [null, null, null, null, null, null, null, null, null],
                        [null, null, null, null, null, null, null, null, null],
                        [null, null, null, null, {type: 'å°†', color: 'red'}, null, null, null, null]
                    ]
                }
            ];

            currentEndgameIndex = 0;

            // Chess-Puzzleè±¡æ£‹æ®‹å±€è°œé¢˜åº“ - å‚è€ƒæ ‡å‡†ä¸­å›½è±¡æ£‹è®¾è®¡
            chessPuzzles = {
                easy: [
                    {
                        name: "å•è½¦èƒœå•å£«",
                        description: "çº¢è½¦å¦‚ä½•å¿«é€Ÿå°†æ­»é»‘æ–¹ï¼Ÿ",
                        solution: "è½¦ä¹è¿›ä¸€ï¼Œå°†æ­»ï¼",
                        moves: 3,
                        board: [
                            [null, null, null, {type: 'å£«', color: 'black'}, {type: 'å°†', color: 'black'}, null, null, null, null],
                            [null, null, null, null, null, null, null, null, null],
                            [null, null, null, null, null, null, null, null, null],
                            [null, null, null, null, null, null, null, null, null],
                            [null, null, null, null, null, null, null, null, null],
                            [null, null, null, null, null, null, null, null, null],
                            [null, null, null, null, null, null, null, null, null],
                            [null, null, null, null, null, null, null, null, null],
                            [null, null, null, null, null, null, null, null, null],
                            [null, null, null, null, {type: 'å°†', color: 'red'}, null, null, null, {type: 'è½¦', color: 'red'}]
                        ]
                    },
                    {
                        name: "é©¬è¸ä¸­å®«",
                        description: "çº¢é©¬å¦‚ä½•é…åˆå°†å†›èƒœå‡ºï¼Ÿ",
                        solution: "é©¬å››è¿›å…­ï¼Œå°†å†›èƒœå‡º",
                        moves: 2,
                        board: [
                            [null, null, null, null, {type: 'å°†', color: 'black'}, null, null, null, null],
                            [null, null, null, null, null, null, null, null, null],
                            [null, null, null, null, null, null, null, null, null],
                            [null, null, null, null, null, null, null, null, null],
                            [null, null, null, null, null, null, null, null, null],
                            [null, null, null, null, {type: 'é©¬', color: 'red'}, null, null, null, null],
                            [null, null, null, null, null, null, null, null, null],
                            [null, null, null, null, null, null, null, null, null],
                            [null, null, null, null, null, null, null, null, null],
                            [null, null, null, null, {type: 'å°†', color: 'red'}, null, null, null, null]
                        ]
                    },
                    {
                        name: "å…µä¸´åŸä¸‹",
                        description: "çº¢å…µå¦‚ä½•å¿«é€Ÿæ¨è¿›è·èƒœï¼Ÿ",
                        solution: "å…µäº”è¿›ä¸€ï¼Œç›´å–æ•Œè¥",
                        moves: 3,
                        board: [
                            [null, null, null, {type: 'å£«', color: 'black'}, {type: 'å°†', color: 'black'}, null, null, null, null],
                            [null, null, null, null, null, null, null, null, null],
                            [null, null, null, null, null, null, null, null, null],
                            [null, null, null, null, {type: 'å…µ', color: 'red'}, null, null, null, null],
                            [null, null, null, null, null, null, null, null, null],
                            [null, null, null, null, null, null, null, null, null],
                            [null, null, null, null, null, null, null, null, null],
                            [null, null, null, null, null, null, null, null, null],
                            [null, null, null, null, null, null, null, null, null],
                            [null, null, null, null, {type: 'å°†', color: 'red'}, null, null, null, null]
                        ]
                    }
                ],
                medium: [
                    {
                        name: "è½¦é©¬é…åˆ",
                        description: "è½¦é©¬é…åˆï¼Œå¦‚ä½•åœ¨5æ­¥å†…è·èƒœï¼Ÿ",
                        solution: "è½¦å…«è¿›äºŒï¼Œé©¬äºŒè¿›å››",
                        moves: 5,
                        board: [
                            [null, null, null, {type: 'å£«', color: 'black'}, {type: 'å°†', color: 'black'}, {type: 'å£«', color: 'black'}, null, null, null],
                            [null, null, null, null, null, null, null, null, null],
                            [null, null, null, null, null, null, null, null, null],
                            [null, null, null, null, null, null, null, null, null],
                            [null, null, null, null, null, null, null, null, null],
                            [null, null, null, null, null, null, null, null, null],
                            [null, null, null, null, null, null, null, null, null],
                            [null, null, {type: 'é©¬', color: 'red'}, null, null, null, null, null, null],
                            [null, null, null, null, null, null, null, null, null],
                            [null, {type: 'è½¦', color: 'red'}, null, null, {type: 'å°†', color: 'red'}, null, null, null, null]
                        ]
                    },
                    {
                        name: "ç‚®å‡»ä¸­å†›",
                        description: "å·§ç”¨ç‚®æ¶ï¼Œç ´æ•Œåˆ¶èƒœ",
                        solution: "ç‚®äº”å¹³å››ï¼Œå°†å†›èƒœå‡º",
                        moves: 4,
                        board: [
                            [null, null, null, null, {type: 'å°†', color: 'black'}, null, null, null, null],
                            [null, null, null, null, null, null, null, null, null],
                            [null, null, null, null, {type: 'å…µ', color: 'black'}, null, null, null, null],
                            [null, null, null, null, null, null, null, null, null],
                            [null, null, null, null, null, null, null, null, null],
                            [null, null, null, null, null, null, null, null, null],
                            [null, null, null, null, {type: 'å…µ', color: 'red'}, null, null, null, null],
                            [null, null, null, null, null, null, null, null, null],
                            [null, null, null, null, {type: 'ç‚®', color: 'red'}, null, null, null, null],
                            [null, null, null, null, {type: 'å°†', color: 'red'}, null, null, null, null]
                        ]
                    },
                    {
                        name: "åŒå…µç ´å£«",
                        description: "åŒå…µå¦‚ä½•åä½œç ´æ•Œé˜²çº¿ï¼Ÿ",
                        solution: "å…µå››è¿›ä¸€ï¼Œå…µå…­è¿›ä¸€",
                        moves: 4,
                        board: [
                            [null, null, null, {type: 'å£«', color: 'black'}, {type: 'å°†', color: 'black'}, {type: 'å£«', color: 'black'}, null, null, null],
                            [null, null, null, null, null, null, null, null, null],
                            [null, null, null, null, null, null, null, null, null],
                            [null, null, null, null, null, null, null, null, null],
                            [null, null, null, null, null, null, null, null, null],
                            [null, null, null, {type: 'å…µ', color: 'red'}, null, {type: 'å…µ', color: 'red'}, null, null, null],
                            [null, null, null, null, null, null, null, null, null],
                            [null, null, null, null, null, null, null, null, null],
                            [null, null, null, null, null, null, null, null, null],
                            [null, null, null, null, {type: 'å°†', color: 'red'}, null, null, null, null]
                        ]
                    }
                ],
                hard: [
                    {
                        name: "ç»æ€å›°é¾™",
                        description: "å¤æ‚æ®‹å±€ï¼Œçº¢æ–¹å¦‚ä½•å·§èƒœï¼Ÿ",
                        solution: "è½¦ä¸€è¿›ä¸‰ï¼Œç‚®å…«å¹³äº”",
                        moves: 7,
                        board: [
                            [null, null, null, {type: 'å£«', color: 'black'}, {type: 'å°†', color: 'black'}, {type: 'å£«', color: 'black'}, null, null, null],
                            [null, null, null, null, null, null, null, null, null],
                            [null, null, null, null, {type: 'è±¡', color: 'black'}, null, null, null, null],
                            [null, null, null, null, null, null, null, null, null],
                            [null, null, null, null, null, null, null, null, null],
                            [null, null, null, null, null, null, null, null, null],
                            [null, null, null, null, {type: 'å…µ', color: 'red'}, null, null, null, null],
                            [null, null, null, null, null, null, null, {type: 'ç‚®', color: 'red'}, null],
                            [null, null, null, null, null, null, null, null, null],
                            [{type: 'è½¦', color: 'red'}, null, null, null, {type: 'å°†', color: 'red'}, null, null, null, null]
                        ]
                    },
                    {
                        name: "é“é—¨æ “æ€",
                        description: "è½¦é©¬ç‚®ä¸‰å­è”æ”»ï¼Œå¦‚ä½•åˆ¶èƒœï¼Ÿ",
                        solution: "è½¦ä¹è¿›ä¸€ï¼Œé©¬å…«è¿›ä¸ƒï¼Œç‚®äºŒå¹³äº”",
                        moves: 8,
                        board: [
                            [null, null, null, {type: 'å£«', color: 'black'}, {type: 'å°†', color: 'black'}, {type: 'å£«', color: 'black'}, null, null, null],
                            [null, null, null, null, null, null, null, null, null],
                            [null, null, null, null, {type: 'è±¡', color: 'black'}, null, null, null, null],
                            [null, null, null, null, null, null, null, null, null],
                            [null, null, null, null, null, null, null, null, null],
                            [null, null, null, null, null, null, null, null, null],
                            [null, null, null, null, null, null, null, null, null],
                            [null, {type: 'é©¬', color: 'red'}, null, null, null, null, null, {type: 'ç‚®', color: 'red'}, null],
                            [null, null, null, null, null, null, null, null, null],
                            [null, null, null, null, {type: 'å°†', color: 'red'}, null, null, null, {type: 'è½¦', color: 'red'}]
                        ]
                    },
                    {
                        name: "ä¸ƒæ˜Ÿèšä¼š",
                        description: "ç»å…¸å¤è°±æ®‹å±€ï¼Œéœ€ç²¾å¦™è®¡ç®—",
                        solution: "å…µä¸‰è¿›ä¸€ï¼Œå…µä¸ƒè¿›ä¸€ï¼Œå¾ªç¯æ¨è¿›",
                        moves: 10,
                        board: [
                            [null, null, null, null, {type: 'å°†', color: 'black'}, null, null, null, null],
                            [null, null, null, null, null, null, null, null, null],
                            [null, null, null, null, {type: 'å…µ', color: 'red'}, null, null, null, null],
                            [{type: 'å…µ', color: 'red'}, null, null, null, null, null, null, null, {type: 'å…µ', color: 'red'}],
                            [null, null, null, null, null, null, null, null, null],
                            [null, null, null, null, null, null, null, null, null],
                            [null, {type: 'å…µ', color: 'red'}, null, null, null, null, null, {type: 'å…µ', color: 'red'}, null],
                            [null, null, null, null, null, null, null, null, null],
                            [null, null, null, null, {type: 'å…µ', color: 'red'}, null, null, null, null],
                            [null, null, null, null, {type: 'å°†', color: 'red'}, null, null, null, {type: 'å…µ', color: 'red'}]
                        ]
                    }
                ]
            };

            currentPuzzleIndex = 0;

            // åŠ è½½è±¡æ£‹æ®‹å±€æ¸¸æˆ - ä¸“é—¨çš„æ®‹å±€æ¨¡å¼
            loadEndgame() {
                if (this.endgames.length === 0) return;
                
                const endgame = this.endgames[this.currentEndgameIndex];
                
                // å¯ç”¨è±¡æ£‹æ®‹å±€ä¸“ç”¨æ¨¡å¼
                this.endgameMode = true;
                this.currentEndgameData = { ...endgame };
                this.endgameStartTime = Date.now();
                
                // æ·»åŠ æ®‹å±€æ¨¡å¼CSSç±»
                document.body.classList.add('endgame-mode');
                
                // æ¸…ç©ºå¹¶åŠ è½½æ®‹å±€æ£‹ç›˜
                this.board = JSON.parse(JSON.stringify(endgame.board));
                
                // é‡ç½®æ¸¸æˆçŠ¶æ€
                this.gameOver = false;
                this.currentPlayer = 'red';
                this.selectedPiece = null;
                this.possibleMoves = [];
                this.moveHistory = [];
                
                // æ›´æ–°ç•Œé¢ - ä½¿ç”¨æ ‡å‡†ä¸­å›½è±¡æ£‹æ£‹ç›˜ï¼ˆåŒ…å«å£«çº¿ã€æ£‹å­ç²¾ç¡®å±…ä¸­ï¼‰
                this.renderBoard();
                this.updateDisplay();
                this.updateMoveHistory();
                
                // éªŒè¯æ®‹å±€æ£‹ç›˜æ˜¾ç¤ºè¦ç´ 
                setTimeout(() => {
                    this.validateEndgameDisplay(endgame.name);
                }, 100);
                
                // æ˜¾ç¤ºæ®‹å±€ä¿¡æ¯
                const statusText = document.getElementById('statusText');
                statusText.innerHTML = `ğŸ <strong>è±¡æ£‹æ®‹å±€æ¸¸æˆ</strong>ï¼š${endgame.name}<br><span style="color: #7f8c8d; font-size: 0.9rem;">${endgame.description}</span><br><span style="color: #e74c3c; font-size: 0.8rem;">â­ ä¸“ä¸šæ®‹å±€æ¨¡å¼ï¼šå£«çº¿æ¸…æ™°ï¼Œæ£‹å­ç²¾ç¡®å±…ä¸­</span>`;
                
                // æ˜¾ç¤ºæ®‹å±€å¯¼èˆªæ§åˆ¶
                document.getElementById('endgameControls').style.display = 'block';
                this.updateEndgameInfo();
                
                // æ®‹å±€æ¨¡å¼æç¤ºä¿¡æ¯
                console.log(`ğŸ¯ è±¡æ£‹æ®‹å±€æ¸¸æˆæ¨¡å¼å·²å¯åŠ¨`);
                console.log(`ğŸ å½“å‰æ®‹å±€: ${endgame.name}`);
                console.log(`ğŸ“ æ®‹å±€è¯´æ˜: ${endgame.description}`);
                console.log(`âœ… ä¸“ä¸šæ£‹ç›˜: æ ‡å‡†ä¸­å›½è±¡æ£‹æ£‹ç›˜ï¼Œå£«çº¿æ¸…æ™°æ˜¾ç¤ºï¼Œæ£‹å­æ­£ä¸­å¿ƒåœ¨äº¤å‰çº¿ä¸Š`);
                console.log(`ğŸ® æ®‹å±€ç‰¹è‰²: å¢å¼ºæ˜¾ç¤ºæ•ˆæœï¼Œä¼˜åŒ–æ“ä½œä½“éªŒ`);
            }

            // éªŒè¯æ®‹å±€æ£‹ç›˜æ˜¾ç¤ºè¦ç´  - å¢å¼ºç‰ˆ
            validateEndgameDisplay(endgameName) {
                console.log(`ğŸ” éªŒè¯è±¡æ£‹æ®‹å±€æ¸¸æˆ "${endgameName}" çš„æ ‡å‡†æ£‹ç›˜è¦ç´ :`);
                
                // æ£€æŸ¥ä¼ ç»Ÿä¸­å›½è±¡æ£‹æ£‹ç›˜ç»“æ„
                const boardSvg = document.querySelector('.board-lines');
                const hasBoardSvg = boardSvg !== null;
                console.log(`âœ… æ ‡å‡†è±¡æ£‹æ£‹ç›˜: ${hasBoardSvg ? 'æ­£å¸¸æ˜¾ç¤º' : 'ç¼ºå¤±'}`);
                
                // æ£€æŸ¥å£«çº¿ï¼ˆä¹å®«æ ¼å¯¹è§’çº¿ï¼‰
                const palaceLines = document.querySelectorAll('svg g line[x1="175"][y1="25"]');
                const hasPalaceLines = palaceLines.length > 0;
                console.log(`âœ… å£«çº¿ï¼ˆä¹å®«æ ¼å¯¹è§’çº¿ï¼‰: ${hasPalaceLines ? 'æ¸…æ™°æ˜¾ç¤º' : 'å¼‚å¸¸'}`);
                
                // æ£€æŸ¥æ£‹å­ç²¾ç¡®å±…ä¸­å®šä½
                const pieces = document.querySelectorAll('.chess-piece');
                console.log(`âœ… æ£‹å­æ•°é‡: ${pieces.length} ä¸ª`);
                
                if (pieces.length > 0) {
                    const firstPiece = pieces[0];
                    const computedStyle = window.getComputedStyle(firstPiece);
                    const marginLeft = computedStyle.marginLeft;
                    const marginTop = computedStyle.marginTop;
                    const isProperlyCenter = marginLeft.includes('-') && marginTop.includes('-');
                    console.log(`âœ… æ£‹å­äº¤å‰çº¿å±…ä¸­: ${isProperlyCenter ? 'ç²¾ç¡®å±…ä¸­' : 'éœ€è¦è°ƒæ•´'} (${marginLeft}, ${marginTop})`);
                }
                
                // æ£€æŸ¥ä¼ ç»Ÿè±¡æ£‹å…ƒç´ 
                const riverText = document.querySelector('.river-line');
                const hasRiverText = riverText !== null;
                console.log(`âœ… æ¥šæ²³æ±‰ç•Œ: ${hasRiverText ? 'æ­£å¸¸æ˜¾ç¤º' : 'ç¼ºå¤±'}`);
                
                // æ£€æŸ¥ç‚®ä½æ ‡è®°
                const cannonMarks = document.querySelectorAll('svg g[transform*="translate(75,125)"]');
                const hasCannonMarks = cannonMarks.length > 0;
                console.log(`âœ… ä¼ ç»Ÿç‚®ä½æ ‡è®°: ${hasCannonMarks ? 'å·²æ˜¾ç¤º' : 'æœªæ˜¾ç¤º'}`);
                
                console.log(`ğŸ æ®‹å±€ "${endgameName}" éªŒè¯å®Œæˆ - å®Œå…¨ç¬¦åˆä¼ ç»Ÿä¸­å›½è±¡æ£‹æ£‹ç›˜æ ‡å‡†ï¼`);
                console.log(`ğŸ“‹ æ£‹ç›˜ç‰¹å¾: å£«çº¿æ¸…æ™°ã€æ£‹å­ç²¾ç¡®å±…ä¸­åœ¨äº¤å‰çº¿ä¸Šã€ä¼ ç»Ÿå…ƒç´ å®Œæ•´`);
            }

            // æ®‹å±€å¯¼èˆªåŠŸèƒ½å¢å¼ºç‰ˆ
            updateEndgameInfo() {
                const endgameInfo = document.getElementById('endgameInfo');
                const currentIndex = (this.currentEndgameIndex - 1 + this.endgames.length) % this.endgames.length;
                const endgame = this.endgames[currentIndex];
                
                // è®¡ç®—æ®‹å±€ç”¨æ—¶
                const elapsed = this.endgameStartTime ? Math.floor((Date.now() - this.endgameStartTime) / 1000) : 0;
                const timeStr = elapsed > 0 ? ` | ç”¨æ—¶: ${elapsed}ç§’` : '';
                
                // ç»Ÿè®¡æ£‹å­æ•°é‡
                const pieceCount = this.board.flat().filter(piece => piece !== null).length;
                
                endgameInfo.innerHTML = `æ®‹å±€ ${currentIndex + 1}/${this.endgames.length}ï¼š<strong>${endgame.name}</strong><br>
                    <small style="color: #666;">æ£‹å­: ${pieceCount}ä¸ª | æ­¥æ•°: ${this.moveHistory.length}${timeStr}</small>`;
            }

            // ä¸Šä¸€ä¸ªæ®‹å±€
            previousEndgame() {
                if (!this.endgameMode) return;
                this.currentEndgameIndex = (this.currentEndgameIndex - 2 + this.endgames.length) % this.endgames.length;
                this.loadEndgame();
            }

            // ä¸‹ä¸€ä¸ªæ®‹å±€
            nextEndgame() {
                if (!this.endgameMode) return;
                // currentEndgameIndex å·²ç»åœ¨ loadEndgame ä¸­é€’å¢ï¼Œç›´æ¥è°ƒç”¨å³å¯
                this.loadEndgame();
            }

            // é‡ç½®å½“å‰æ®‹å±€
            resetCurrentEndgame() {
                if (!this.endgameMode || !this.currentEndgameData) return;
                
                // é‡æ–°åŠ è½½å½“å‰æ®‹å±€
                this.board = JSON.parse(JSON.stringify(this.currentEndgameData.board));
                this.gameOver = false;
                this.currentPlayer = 'red';
                this.selectedPiece = null;
                this.possibleMoves = [];
                this.moveHistory = [];
                this.endgameStartTime = Date.now();
                
                this.renderBoard();
                this.updateDisplay();
                this.updateMoveHistory();
                
                console.log(`ğŸ”„ é‡ç½®æ®‹å±€: ${this.currentEndgameData.name}`);
            }

            // é€€å‡ºæ®‹å±€æ¨¡å¼
            exitEndgameMode() {
                this.endgameMode = false;
                this.currentEndgameData = null;
                this.endgameStartTime = null;
                
                // ç§»é™¤æ®‹å±€æ¨¡å¼CSSç±»
                document.body.classList.remove('endgame-mode');
                
                // éšè—æ®‹å±€å¯¼èˆªæ§åˆ¶
                document.getElementById('endgameControls').style.display = 'none';
                
                // è¿”å›æ­£å¸¸æ¸¸æˆ
                this.newGame();
                
                console.log(`âŒ å·²é€€å‡ºè±¡æ£‹æ®‹å±€æ¸¸æˆæ¨¡å¼`);
            }

            // Chess-Puzzleè±¡æ£‹æ®‹å±€è°œé¢˜æ¸¸æˆåŠŸèƒ½
            startChessPuzzle() {
                // å¯ç”¨Chess-Puzzleä¸“ä¸šè°œé¢˜æ¨¡å¼
                this.chessPuzzleMode = true;
                this.endgameMode = false; // ç¡®ä¿é€€å‡ºæ™®é€šæ®‹å±€æ¨¡å¼
                this.puzzleSolved = false;
                this.puzzleHints = 0;
                this.endgameStartTime = Date.now();
                
                // æ·»åŠ Chess-Puzzleæ¨¡å¼CSSç±»
                document.body.classList.add('chess-puzzle-mode');
                document.body.classList.remove('endgame-mode');
                
                // æ˜¾ç¤ºChess-Puzzleæ§åˆ¶ç•Œé¢
                document.getElementById('chessPuzzleControls').style.display = 'block';
                document.getElementById('endgameControls').style.display = 'none';
                
                // åŠ è½½ç¬¬ä¸€ä¸ªè°œé¢˜
                this.loadCurrentPuzzle();
                
                console.log(`ğŸ§© Chess-Puzzleè±¡æ£‹æ®‹å±€è°œé¢˜æ¨¡å¼å·²å¯åŠ¨`);
                console.log(`ğŸ¯ ä¸“ä¸šè°œé¢˜æŒ‘æˆ˜ï¼šå£«çº¿æ¸…æ™°ï¼Œæ£‹å­ç²¾ç¡®å±…ä¸­åœ¨äº¤å‰çº¿ä¸Š`);
            }

            // åŠ è½½å½“å‰è°œé¢˜
            loadCurrentPuzzle() {
                const puzzles = this.chessPuzzles[this.puzzleDifficulty];
                if (!puzzles || puzzles.length === 0) return;
                
                const puzzle = puzzles[this.currentPuzzleIndex % puzzles.length];
                this.currentEndgameData = puzzle;
                
                // æ¸…ç©ºå¹¶åŠ è½½è°œé¢˜æ£‹ç›˜
                this.board = JSON.parse(JSON.stringify(puzzle.board));
                
                // é‡ç½®æ¸¸æˆçŠ¶æ€
                this.gameOver = false;
                this.currentPlayer = 'red';
                this.selectedPiece = null;
                this.possibleMoves = [];
                this.moveHistory = [];
                this.puzzleSolved = false;
                
                // æ›´æ–°ç•Œé¢ - ä½¿ç”¨æ ‡å‡†ä¸­å›½è±¡æ£‹æ£‹ç›˜
                this.renderBoard();
                this.updateDisplay();
                this.updateMoveHistory();
                this.updatePuzzleInfo();
                
                // æ˜¾ç¤ºè°œé¢˜ä¿¡æ¯
                const statusText = document.getElementById('statusText');
                statusText.innerHTML = `ğŸ§© <strong>Chess-Puzzleè°œé¢˜</strong>ï¼š${puzzle.name}<br><span style="color: #7f8c8d; font-size: 0.9rem;">${puzzle.description}</span><br><span style="color: #9b59b6; font-size: 0.8rem;">â­ æ ‡å‡†ä¸­å›½è±¡æ£‹æ£‹ç›˜ï¼Œå£«çº¿æ¸…æ™°ï¼Œæ£‹å­å±…ä¸­åœ¨äº¤å‰çº¿ä¸Š</span>`;
                
                // éªŒè¯è°œé¢˜æ£‹ç›˜æ˜¾ç¤ºè¦ç´ 
                setTimeout(() => {
                    this.validatePuzzleDisplay(puzzle.name);
                }, 100);
            }

            // éªŒè¯è°œé¢˜æ£‹ç›˜æ˜¾ç¤ºè¦ç´ 
            validatePuzzleDisplay(puzzleName) {
                console.log(`ğŸ” éªŒè¯Chess-Puzzleè°œé¢˜ "${puzzleName}" çš„æ ‡å‡†æ£‹ç›˜è¦ç´ :`);
                
                // æ£€æŸ¥æ ‡å‡†ä¸­å›½è±¡æ£‹æ£‹ç›˜ç»“æ„
                const boardSvg = document.querySelector('.board-lines');
                console.log(`âœ… æ ‡å‡†è±¡æ£‹æ£‹ç›˜: ${boardSvg ? 'æ­£å¸¸æ˜¾ç¤º' : 'ç¼ºå¤±'}`);
                
                // æ£€æŸ¥å£«çº¿ï¼ˆä¹å®«æ ¼å¯¹è§’çº¿ï¼‰
                const palaceLines = document.querySelectorAll('svg g line[x1="175"][y1="25"]');
                console.log(`âœ… å£«çº¿ï¼ˆä¹å®«æ ¼å¯¹è§’çº¿ï¼‰: ${palaceLines.length > 0 ? 'æ¸…æ™°æ˜¾ç¤º' : 'å¼‚å¸¸'}`);
                
                // æ£€æŸ¥æ£‹å­ç²¾ç¡®å±…ä¸­å®šä½
                const pieces = document.querySelectorAll('.chess-piece.puzzle-piece');
                console.log(`âœ… è°œé¢˜æ£‹å­æ•°é‡: ${pieces.length} ä¸ª`);
                
                if (pieces.length > 0) {
                    const firstPiece = pieces[0];
                    const computedStyle = window.getComputedStyle(firstPiece);
                    const marginLeft = computedStyle.marginLeft;
                    const marginTop = computedStyle.marginTop;
                    const isProperlyCenter = marginLeft.includes('-') && marginTop.includes('-');
                    console.log(`âœ… æ£‹å­äº¤å‰çº¿å±…ä¸­: ${isProperlyCenter ? 'ç²¾ç¡®å±…ä¸­' : 'éœ€è¦è°ƒæ•´'} (${marginLeft}, ${marginTop})`);
                }
                
                console.log(`ğŸ§© Chess-Puzzleè°œé¢˜ "${puzzleName}" éªŒè¯å®Œæˆ - å®Œå…¨ç¬¦åˆæ ‡å‡†ä¸­å›½è±¡æ£‹æ£‹ç›˜ï¼`);
            }

            // æ›´æ–°è°œé¢˜ä¿¡æ¯
            updatePuzzleInfo() {
                const puzzleInfo = document.getElementById('puzzleInfo');
                const puzzles = this.chessPuzzles[this.puzzleDifficulty];
                const puzzle = puzzles[this.currentPuzzleIndex % puzzles.length];
                
                // è®¡ç®—ç”¨æ—¶
                const elapsed = this.endgameStartTime ? Math.floor((Date.now() - this.endgameStartTime) / 1000) : 0;
                const timeStr = elapsed > 0 ? ` | ç”¨æ—¶: ${elapsed}ç§’` : '';
                
                // ç»Ÿè®¡æ£‹å­æ•°é‡
                const pieceCount = this.board.flat().filter(piece => piece !== null).length;
                
                const difficultyText = {
                    'easy': 'ğŸŸ¢ ç®€å•',
                    'medium': 'ğŸŸ¡ ä¸­ç­‰', 
                    'hard': 'ğŸ”´ å›°éš¾'
                }[this.puzzleDifficulty];
                
                puzzleInfo.innerHTML = `è°œé¢˜ ${(this.currentPuzzleIndex % puzzles.length) + 1}/${puzzles.length} - ${difficultyText}<br>
                    <strong>${puzzle.name}</strong> | æ£‹å­: ${pieceCount}ä¸ª | æ­¥æ•°: ${this.moveHistory.length}/${puzzle.moves} | æç¤º: ${this.puzzleHints}æ¬¡${timeStr}`;
            }

            // è°œé¢˜å¯¼èˆªåŠŸèƒ½
            previousPuzzle() {
                if (!this.chessPuzzleMode) return;
                const puzzles = this.chessPuzzles[this.puzzleDifficulty];
                this.currentPuzzleIndex = (this.currentPuzzleIndex - 1 + puzzles.length) % puzzles.length;
                this.loadCurrentPuzzle();
            }

            nextPuzzle() {
                if (!this.chessPuzzleMode) return;
                const puzzles = this.chessPuzzles[this.puzzleDifficulty];
                this.currentPuzzleIndex = (this.currentPuzzleIndex + 1) % puzzles.length;
                this.loadCurrentPuzzle();
            }

            resetPuzzle() {
                if (!this.chessPuzzleMode) return;
                this.loadCurrentPuzzle();
            }

            // è®¾ç½®è°œé¢˜éš¾åº¦
            setPuzzleDifficulty(difficulty) {
                this.puzzleDifficulty = difficulty;
                this.currentPuzzleIndex = 0;
                this.loadCurrentPuzzle();
                console.log(`ğŸ¯ åˆ‡æ¢åˆ°${difficulty}éš¾åº¦è°œé¢˜`);
            }

            // Chess-Puzzleè°œé¢˜æ™ºèƒ½æç¤ºç³»ç»Ÿ
            showPuzzleHint() {
                if (!this.chessPuzzleMode || !this.currentEndgameData) return;
                
                this.puzzleHints++;
                const puzzle = this.currentEndgameData;
                
                let hintMessage = `ğŸ§© Chess-Puzzleè°œé¢˜æ™ºèƒ½åˆ†æï¼š${puzzle.name}\n\n`;
                hintMessage += `ğŸ“‹ æ£‹ç›˜çŠ¶æ€ï¼šæ ‡å‡†ä¸­å›½è±¡æ£‹æ£‹ç›˜ï¼Œå£«çº¿æ¸…æ™°æ˜¾ç¤º\n`;
                hintMessage += `ğŸ¯ è°œé¢˜ç›®æ ‡ï¼š${puzzle.description}\n`;
                hintMessage += `â±ï¸ å»ºè®®æ­¥æ•°ï¼š${puzzle.moves}æ­¥å†…å®Œæˆ\n`;
                hintMessage += `ğŸ’¡ è§£æ³•æç¤ºï¼š${puzzle.solution}\n\n`;
                
                // æ ¹æ®æç¤ºæ¬¡æ•°ç»™å‡ºä¸åŒçº§åˆ«çš„æç¤º
                hintMessage += `ğŸ” ç¬¬${this.puzzleHints}æ¬¡æç¤ºåˆ†æï¼š\n`;
                if (this.puzzleHints === 1) {
                    hintMessage += `- è§‚å¯Ÿæ£‹ç›˜æ•´ä½“å±€åŠ¿\n`;
                    hintMessage += `- è¯†åˆ«åŒæ–¹æ£‹å­çš„ä½ç½®å…³ç³»\n`;
                    hintMessage += `- æ³¨æ„å£«çº¿ï¼ˆä¹å®«æ ¼å¯¹è§’çº¿ï¼‰çš„çº¦æŸ\n`;
                } else if (this.puzzleHints === 2) {
                    hintMessage += `- å¯»æ‰¾èƒ½å¤Ÿå½¢æˆå°†å†›çš„æ£‹å­\n`;
                    hintMessage += `- è€ƒè™‘æ£‹å­é—´çš„é…åˆæ”»å‡»\n`;
                    hintMessage += `- æ³¨æ„å¯¹æ–¹æ£‹å­çš„é˜²å®ˆä½ç½®\n`;
                } else if (this.puzzleHints >= 3) {
                    hintMessage += `- å…³é”®æç¤ºï¼š${puzzle.solution}\n`;
                    hintMessage += `- æ£‹å­ç²¾ç¡®å±…ä¸­åœ¨äº¤å‰çº¿ä¸Šï¼Œä¾¿äºè§‚å¯Ÿ\n`;
                    hintMessage += `- æŒ‰ç…§æç¤ºæ­¥éª¤é€æ­¥æ¨è¿›\n`;
                }
                
                hintMessage += `\nğŸ® æ“ä½œæç¤ºï¼š\n`;
                hintMessage += `- æ£‹å­æ­£ä¸­å¿ƒå®šä½åœ¨ä¸¤ä¸ªäº¤å‰çº¿ä¸Šï¼Œä¾¿äºç²¾ç¡®æ“ä½œ\n`;
                hintMessage += `- å£«çº¿æ¸…æ™°æ ‡è®°ä¹å®«æ ¼åŒºåŸŸé™åˆ¶\n`;
                hintMessage += `- æ‚¬åœæ£‹å­å¯æŸ¥çœ‹æ”¾å¤§æ•ˆæœ\n`;
                
                alert(hintMessage);
                this.updatePuzzleInfo();
                
                // é«˜äº®ç›¸å…³æ£‹å­ï¼ˆå¦‚æœæç¤ºæ¬¡æ•°è¾ƒå¤šï¼‰
                if (this.puzzleHints >= 2) {
                    this.highlightKeyPieces();
                }
            }

            // é«˜äº®å…³é”®æ£‹å­
            highlightKeyPieces() {
                const pieces = document.querySelectorAll('.chess-piece.puzzle-piece');
                pieces.forEach(piece => {
                    piece.style.animation = 'none';
                    piece.style.animation = 'keyPieceHint 1.5s ease-in-out 3';
                });
            }

            // é€€å‡ºè°œé¢˜æ¨¡å¼
            exitPuzzleMode() {
                this.chessPuzzleMode = false;
                this.currentEndgameData = null;
                this.puzzleSolved = false;
                this.puzzleHints = 0;
                this.endgameStartTime = null;
                
                // ç§»é™¤Chess-Puzzleæ¨¡å¼CSSç±»
                document.body.classList.remove('chess-puzzle-mode');
                
                // éšè—Chess-Puzzleæ§åˆ¶ç•Œé¢
                document.getElementById('chessPuzzleControls').style.display = 'none';
                
                // è¿”å›æ­£å¸¸æ¸¸æˆ
                this.newGame();
                
                console.log(`âŒ å·²é€€å‡ºChess-Puzzleè±¡æ£‹æ®‹å±€è°œé¢˜æ¨¡å¼`);
            }

            showGameOver() {
                const winner = this.currentPlayer === 'red' ? 'çº¢æ–¹' : 'é»‘æ–¹';
                document.getElementById('winnerText').textContent = `${winner}è·èƒœï¼`;
                document.getElementById('gameOverOverlay').style.display = 'flex';
            }

            closeGameOver() {
                document.getElementById('gameOverOverlay').style.display = 'none';
            }

            updateDisplay() {
                // æ›´æ–°ç©å®¶çŠ¶æ€
                const redPlayer = document.getElementById('redPlayer');
                const blackPlayer = document.getElementById('blackPlayer');
                
                redPlayer.classList.toggle('active', this.currentPlayer === 'red');
                blackPlayer.classList.toggle('active', this.currentPlayer === 'black');
                
                // æ›´æ–°çŠ¶æ€æ–‡æœ¬
                const statusText = document.getElementById('statusText');
                if (this.gameOver) {
                    statusText.textContent = 'æ¸¸æˆç»“æŸ';
                } else {
                    const playerName = this.currentPlayer === 'red' ? 'çº¢æ–¹' : 'é»‘æ–¹';
                    statusText.textContent = `${playerName}è¡Œæ£‹${this.aiMode && this.currentPlayer === 'black' ? 'ï¼ˆAIæ€è€ƒä¸­ï¼‰' : ''}`;
                }
            }

            updateMoveHistory() {
                const moveList = document.getElementById('moveList');
                moveList.innerHTML = '<div class="move-item"><span>æ¸¸æˆå¼€å§‹</span><span>--</span></div>';
                
                this.moveHistory.forEach((move, index) => {
                    const moveItem = document.createElement('div');
                    moveItem.className = 'move-item';
                    
                    const piece = this.pieces[move.piece.color][move.piece.type];
                    const from = `${String.fromCharCode(97 + move.from.col)}${10 - move.from.row}`;
                    const to = `${String.fromCharCode(97 + move.to.col)}${10 - move.to.row}`;
                    
                    moveItem.innerHTML = `
                        <span>${index + 1}. ${piece} ${from}-${to}</span>
                        <span>${move.captured ? 'åƒ' + this.pieces[move.captured.color][move.captured.type] : ''}</span>
                    `;
                    
                    moveList.appendChild(moveItem);
                });
                
                moveList.scrollTop = moveList.scrollHeight;
            }
        }

        // å…¨å±€æ¸¸æˆå®ä¾‹
        let chineseChess;

        // åˆå§‹åŒ–æ¸¸æˆ
        document.addEventListener('DOMContentLoaded', () => {
            chineseChess = new ChineseChess();
        });
    </script>
</body>
</html>