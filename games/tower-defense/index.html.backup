<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å¡”é˜²æ¸¸æˆ - åœ¨çº¿å…è´¹ç­–ç•¥é˜²å¾¡æ¸¸æˆ | æ‰å¹³åŒ–è®¾è®¡</title>
    
    <!-- SEO Metaæ ‡ç­¾ -->
    <meta name="description" content="å…è´¹åœ¨çº¿å¡”é˜²æ¸¸æˆï¼Œå»ºé€ é˜²å¾¡å¡”æŠµå¾¡æ•Œäººè¿›æ”»ï¼Œå¤šç§å¡”å‹å’Œæ•Œäººç±»å‹ï¼Œç­–ç•¥é˜²å¾¡æ¸¸æˆï¼Œæ‰å¹³åŒ–è®¾è®¡ç•Œé¢ï¼">
    <meta name="keywords" content="å¡”é˜²æ¸¸æˆ,ç­–ç•¥æ¸¸æˆ,é˜²å¾¡æ¸¸æˆ,å¡”é˜²,åœ¨çº¿æ¸¸æˆ,å…è´¹æ¸¸æˆ,ç­–ç•¥é˜²å¾¡,æ‰å¹³åŒ–è®¾è®¡">
    <meta name="author" content="æ¸¸æˆå·¥å…·ç®±">
    <meta name="theme-color" content="#3F51B5">
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #7986CB 0%, #3F51B5 100%);
            min-height: 100vh;
            color: #fff;
            overflow-x: hidden;
            user-select: none;
        }

        .game-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .game-header {
            text-align: center;
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(20px);
            border-radius: 20px;
            padding: 25px;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .game-header h1 {
            font-size: 2.5rem;
            font-weight: 300;
            margin-bottom: 10px;
            letter-spacing: 3px;
            text-shadow: 0 2px 10px rgba(0, 0, 0, 0.3);
        }

        .game-subtitle {
            font-size: 1rem;
            opacity: 0.8;
            letter-spacing: 1px;
        }

        .game-interface {
            display: grid;
            grid-template-columns: 1fr 300px;
            gap: 20px;
        }

        .game-board-container {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(20px);
            border-radius: 20px;
            padding: 20px;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        #gameCanvas {
            background: linear-gradient(135deg, #2E7D32 0%, #4CAF50 100%);
            border-radius: 15px;
            border: 2px solid rgba(255, 255, 255, 0.2);
            cursor: crosshair;
            display: block;
            margin: 0 auto;
        }

        .control-panel {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .game-stats {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(20px);
            border-radius: 20px;
            padding: 20px;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .game-stats h3 {
            text-align: center;
            margin-bottom: 15px;
            font-weight: 300;
            font-size: 1.2rem;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
        }

        .stat-item {
            text-align: center;
            padding: 10px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 12px;
        }

        .stat-value {
            font-size: 1.5rem;
            font-weight: 600;
            margin-bottom: 5px;
            text-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
        }

        .stat-label {
            font-size: 0.8rem;
            opacity: 0.8;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .tower-shop {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(20px);
            border-radius: 20px;
            padding: 20px;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .tower-shop h3 {
            text-align: center;
            margin-bottom: 15px;
            font-weight: 300;
            font-size: 1.2rem;
        }

        .tower-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
        }

        .tower-btn {
            padding: 15px 10px;
            border: none;
            border-radius: 15px;
            background: rgba(255, 255, 255, 0.1);
            color: white;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: center;
            border: 2px solid transparent;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 5px;
        }

        .tower-btn:hover {
            background: rgba(255, 255, 255, 0.2);
            transform: translateY(-2px);
        }

        .tower-btn.selected {
            background: rgba(76, 175, 80, 0.3);
            border-color: rgba(76, 175, 80, 0.5);
        }

        .tower-btn.disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        .tower-icon {
            font-size: 1.5rem;
            margin-bottom: 5px;
        }

        .tower-name {
            font-size: 0.8rem;
            font-weight: 600;
            margin-bottom: 2px;
        }

        .tower-cost {
            font-size: 0.7rem;
            opacity: 0.8;
        }

        .wave-info {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(20px);
            border-radius: 20px;
            padding: 20px;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .wave-info h3 {
            text-align: center;
            margin-bottom: 15px;
            font-weight: 300;
            font-size: 1.2rem;
        }

        .wave-progress {
            margin-bottom: 15px;
        }

        .progress-bar {
            width: 100%;
            height: 10px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 5px;
            overflow: hidden;
            margin-bottom: 10px;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #F44336, #FF9800);
            border-radius: 5px;
            transition: width 0.3s ease;
            width: 0;
        }

        .wave-text {
            text-align: center;
            font-size: 0.9rem;
            opacity: 0.9;
        }

        .game-controls {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(20px);
            border-radius: 20px;
            padding: 20px;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .control-buttons {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .btn {
            padding: 12px 20px;
            border: none;
            border-radius: 25px;
            background: #303F9F;
            color: white;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 0.9rem;
            box-shadow: 0 4px 15px rgba(48, 63, 159, 0.3);
        }

        .btn:hover {
            background: #283593;
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(48, 63, 159, 0.4);
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        .btn.start-btn {
            background: #4CAF50;
            box-shadow: 0 4px 15px rgba(76, 175, 80, 0.3);
        }

        .btn.start-btn:hover {
            background: #43A047;
        }

        .btn.danger {
            background: #F44336;
            box-shadow: 0 4px 15px rgba(244, 67, 54, 0.3);
        }

        .btn.danger:hover {
            background: #E53935;
        }

        .btn.secondary {
            background: rgba(255, 255, 255, 0.2);
            box-shadow: 0 4px 15px rgba(255, 255, 255, 0.1);
        }

        .btn.secondary:hover {
            background: rgba(255, 255, 255, 0.3);
        }

        /* å¼¹çª—æ ·å¼ */
        .popup {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(10px);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }

        .popup.show {
            display: flex;
        }

        .popup-content {
            background: linear-gradient(135deg, #7986CB 0%, #3F51B5 100%);
            border-radius: 25px;
            padding: 40px;
            text-align: center;
            max-width: 500px;
            width: 90%;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            border: 2px solid rgba(255, 255, 255, 0.2);
            max-height: 80vh;
            overflow-y: auto;
        }

        .popup-content h2 {
            font-size: 2rem;
            margin-bottom: 25px;
            font-weight: 300;
        }

        .final-stats {
            display: grid;
            gap: 15px;
            margin-bottom: 25px;
        }

        .stat-display {
            display: flex;
            align-items: center;
            gap: 15px;
            padding: 15px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 15px;
        }

        .stat-icon {
            font-size: 2rem;
            width: 50px;
            text-align: center;
        }

        .popup-actions {
            display: flex;
            gap: 15px;
            justify-content: center;
            flex-wrap: wrap;
        }

        /* å“åº”å¼è®¾è®¡ */
        @media (max-width: 768px) {
            .game-container {
                padding: 15px;
                gap: 15px;
            }
            
            .game-header h1 {
                font-size: 2rem;
            }
            
            .game-interface {
                grid-template-columns: 1fr;
                gap: 15px;
            }
            
            #gameCanvas {
                width: 100% !important;
                height: 300px !important;
            }
            
            .control-panel {
                order: -1;
            }
            
            .stats-grid {
                grid-template-columns: repeat(4, 1fr);
            }
            
            .tower-grid {
                grid-template-columns: repeat(4, 1fr);
            }
        }

        @media (max-width: 480px) {
            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .tower-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }
    </style>
</head>
<body>
    <main class="game-container">
        <header class="game-header">
            <h1>ğŸ° å¡”é˜²æ¸¸æˆ</h1>
            <div class="game-subtitle">å»ºé€ é˜²å¾¡å¡”æŠµå¾¡æ•Œäººè¿›æ”»</div>
        </header>

        <section class="game-interface">
            <div class="game-board-container">
                <canvas id="gameCanvas" width="600" height="400"></canvas>
            </div>

            <div class="control-panel">
                <div class="game-stats">
                    <h3>ğŸ“Š æ¸¸æˆçŠ¶æ€</h3>
                    <div class="stats-grid">
                        <div class="stat-item">
                            <div class="stat-value" id="health">100</div>
                            <div class="stat-label">ç”Ÿå‘½å€¼</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-value" id="money">500</div>
                            <div class="stat-label">é‡‘å¸</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-value" id="score">0</div>
                            <div class="stat-label">åˆ†æ•°</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-value" id="kills">0</div>
                            <div class="stat-label">å‡»æ€</div>
                        </div>
                    </div>
                </div>

                <div class="tower-shop">
                    <h3>ğŸ—ï¸ é˜²å¾¡å¡”å•†åº—</h3>
                    <div class="tower-grid">
                        <button class="tower-btn" onclick="towerDefense.selectTower('basic')" id="basicTowerBtn">
                            <div class="tower-icon">ğŸ”«</div>
                            <div class="tower-name">åŸºç¡€å¡”</div>
                            <div class="tower-cost">$50</div>
                        </button>
                        <button class="tower-btn" onclick="towerDefense.selectTower('cannon')" id="cannonTowerBtn">
                            <div class="tower-icon">ğŸ’¥</div>
                            <div class="tower-name">åŠ å†œç‚®</div>
                            <div class="tower-cost">$100</div>
                        </button>
                        <button class="tower-btn" onclick="towerDefense.selectTower('laser')" id="laserTowerBtn">
                            <div class="tower-icon">ğŸ”´</div>
                            <div class="tower-name">æ¿€å…‰å¡”</div>
                            <div class="tower-cost">$150</div>
                        </button>
                        <button class="tower-btn" onclick="towerDefense.selectTower('ice')" id="iceTowerBtn">
                            <div class="tower-icon">â„ï¸</div>
                            <div class="tower-name">å†°å†»å¡”</div>
                            <div class="tower-cost">$80</div>
                        </button>
                    </div>
                </div>

                <div class="wave-info">
                    <h3>ğŸŒŠ æ³¢æ¬¡ä¿¡æ¯</h3>
                    <div class="wave-progress">
                        <div class="progress-bar">
                            <div class="progress-fill" id="waveProgress"></div>
                        </div>
                        <div class="wave-text" id="waveText">ç‚¹å‡»å¼€å§‹æ¸¸æˆ</div>
                    </div>
                </div>

                <div class="game-controls">
                    <div class="control-buttons">
                        <button class="btn start-btn" onclick="towerDefense.startGame()" id="startBtn">ğŸš€ å¼€å§‹æ¸¸æˆ</button>
                        <button class="btn" onclick="towerDefense.startWave()" id="waveBtn" disabled>ğŸŒŠ å¼€å§‹æ³¢æ¬¡</button>
                        <button class="btn secondary" onclick="towerDefense.pauseGame()" id="pauseBtn" disabled>â¸ï¸ æš‚åœ</button>
                        <button class="btn danger" onclick="towerDefense.resetGame()">ğŸ”„ é‡ç½®æ¸¸æˆ</button>
                        <button class="btn secondary" onclick="towerDefense.showHelp()">â“ å¸®åŠ©</button>
                    </div>
                </div>
            </div>
        </section>

        <!-- æ¸¸æˆç»“æŸå¼¹çª— -->
        <div class="popup" id="gameOverPopup">
            <div class="popup-content">
                <h2 id="gameOverTitle">ğŸ’¥ æ¸¸æˆç»“æŸ</h2>
                <div class="final-stats">
                    <div class="stat-display">
                        <div class="stat-icon">ğŸ†</div>
                        <div>
                            <div class="stat-label">æœ€ç»ˆåˆ†æ•°</div>
                            <div class="stat-value" id="finalScore">0</div>
                        </div>
                    </div>
                    <div class="stat-display">
                        <div class="stat-icon">ğŸŒŠ</div>
                        <div>
                            <div class="stat-label">å®Œæˆæ³¢æ¬¡</div>
                            <div class="stat-value" id="finalWave">0</div>
                        </div>
                    </div>
                    <div class="stat-display">
                        <div class="stat-icon">ğŸ’€</div>
                        <div>
                            <div class="stat-label">æ€»å‡»æ€</div>
                            <div class="stat-value" id="finalKills">0</div>
                        </div>
                    </div>
                    <div class="stat-display">
                        <div class="stat-icon">ğŸ—ï¸</div>
                        <div>
                            <div class="stat-label">å»ºé€ å¡”æ•°</div>
                            <div class="stat-value" id="towersBuilt">0</div>
                        </div>
                    </div>
                </div>
                <div class="popup-actions">
                    <button class="btn" onclick="towerDefense.closeGameOver(); towerDefense.startGame();">å†æ¥ä¸€æ¬¡</button>
                    <button class="btn secondary" onclick="towerDefense.closeGameOver();">å…³é—­</button>
                </div>
            </div>
        </div>

        <!-- å¸®åŠ©å¼¹çª— -->
        <div class="popup" id="helpPopup">
            <div class="popup-content">
                <h2>ğŸ° æ¸¸æˆè¯´æ˜</h2>
                
                <div style="text-align: left; margin-bottom: 20px;">
                    <h3 style="color: #FFD54F; margin-bottom: 10px;">ğŸ¯ æ¸¸æˆç›®æ ‡</h3>
                    <p style="line-height: 1.6; margin-bottom: 15px;">
                        å»ºé€ é˜²å¾¡å¡”é˜»æ­¢æ•Œäººåˆ°è¾¾ç»ˆç‚¹ï¼Œä¿æŠ¤ä½ çš„åŸºåœ°ã€‚æ•Œäººä¼šæ²¿ç€å›ºå®šè·¯å¾„å‰è¿›ï¼Œä½ éœ€è¦ç­–ç•¥æ€§åœ°æ”¾ç½®ä¸åŒç±»å‹çš„å¡”æ¥å‡»è´¥ä»–ä»¬ã€‚
                    </p>
                    
                    <h3 style="color: #FFD54F; margin-bottom: 10px;">ğŸ—ï¸ é˜²å¾¡å¡”ç±»å‹</h3>
                    <p style="line-height: 1.6; margin-bottom: 15px;">
                        â€¢ <strong>åŸºç¡€å¡”ï¼š</strong>ä½æˆæœ¬ï¼Œä¸­ç­‰ä¼¤å®³ï¼Œå°„é€Ÿå¿«<br>
                        â€¢ <strong>åŠ å†œç‚®ï¼š</strong>é«˜ä¼¤å®³ï¼Œæº…å°„æ•ˆæœï¼Œå°„é€Ÿæ…¢<br>
                        â€¢ <strong>æ¿€å…‰å¡”ï¼š</strong>æŒç»­ä¼¤å®³ï¼Œç©¿é€æ•ˆæœï¼Œé«˜æˆæœ¬<br>
                        â€¢ <strong>å†°å†»å¡”ï¼š</strong>å‡é€Ÿæ•Œäººï¼Œè¾…åŠ©å…¶ä»–å¡”æ”»å‡»
                    </p>
                    
                    <h3 style="color: #FFD54F; margin-bottom: 10px;">ğŸ® æ“ä½œæ–¹å¼</h3>
                    <p style="line-height: 1.6; margin-bottom: 15px;">
                        1. é€‰æ‹©è¦å»ºé€ çš„é˜²å¾¡å¡”ç±»å‹<br>
                        2. ç‚¹å‡»åœ°å›¾ä¸Šçš„ç©ºç™½ä½ç½®å»ºé€ <br>
                        3. ç‚¹å‡»"å¼€å§‹æ³¢æ¬¡"æŒ‰é’®å¼€å§‹æ•Œäººè¿›æ”»<br>
                        4. å‡»è´¥æ•Œäººè·å¾—é‡‘å¸è´­ä¹°æ›´å¤šå¡”
                    </p>
                    
                    <h3 style="color: #FFD54F; margin-bottom: 10px;">ğŸ’¡ ç­–ç•¥æç¤º</h3>
                    <p style="line-height: 1.6; margin-bottom: 15px;">
                        â€¢ åœ¨æ•Œäººè·¯å¾„çš„æ‹è§’å¤„å»ºé€ å¡”æ•ˆæœæ›´å¥½<br>
                        â€¢ åˆç†æ­é…ä¸åŒç±»å‹çš„å¡”<br>
                        â€¢ ä¼˜å…ˆå‡çº§å…³é”®ä½ç½®çš„å¡”<br>
                        â€¢ æ³¨æ„ç®¡ç†é‡‘å¸ï¼Œä¸ºåç»­æ³¢æ¬¡åšå‡†å¤‡
                    </p>
                    
                    <h3 style="color: #FFD54F; margin-bottom: 10px;">ğŸ† è¯„åˆ†è§„åˆ™</h3>
                    <p style="line-height: 1.6;">
                        â€¢ å‡»è´¥æ•Œäººè·å¾—åˆ†æ•°å’Œé‡‘å¸<br>
                        â€¢ å®Œæˆæ³¢æ¬¡è·å¾—å¥–åŠ±åˆ†æ•°<br>
                        â€¢ ä¿æŒæ»¡è¡€é€šå…³è·å¾—é¢å¤–å¥–åŠ±<br>
                        â€¢ ä½¿ç”¨æ›´å°‘çš„å¡”å®ŒæˆæŒ‘æˆ˜è·å¾—æ•ˆç‡å¥–åŠ±
                    </p>
                </div>
                
                <div class="popup-actions">
                    <button class="btn" onclick="towerDefense.closeHelp();">æ˜ç™½äº†</button>
                </div>
            </div>
        </div>
    </main>

    <script>
        class TowerDefense {
            constructor() {
                this.canvas = document.getElementById('gameCanvas');
                this.ctx = this.canvas.getContext('2d');
                
                // æ¸¸æˆçŠ¶æ€
                this.gameActive = false;
                this.gamePaused = false;
                this.health = 100;
                this.money = 500;
                this.score = 0;
                this.kills = 0;
                this.wave = 0;
                this.towersBuilt = 0;
                
                // æ¸¸æˆå¯¹è±¡
                this.towers = [];
                this.enemies = [];
                this.projectiles = [];
                this.selectedTowerType = null;
                
                // è·¯å¾„ç‚¹
                this.path = [
                    {x: 0, y: 200},
                    {x: 150, y: 200},
                    {x: 150, y: 100},
                    {x: 300, y: 100},
                    {x: 300, y: 300},
                    {x: 450, y: 300},
                    {x: 450, y: 150},
                    {x: 600, y: 150}
                ];
                
                // é˜²å¾¡å¡”é…ç½®
                this.towerTypes = {
                    basic: {
                        cost: 50,
                        damage: 20,
                        range: 80,
                        fireRate: 1000,
                        color: '#FF9800',
                        projectileSpeed: 200
                    },
                    cannon: {
                        cost: 100,
                        damage: 60,
                        range: 100,
                        fireRate: 2000,
                        color: '#F44336',
                        projectileSpeed: 150,
                        splash: 40
                    },
                    laser: {
                        cost: 150,
                        damage: 8,
                        range: 120,
                        fireRate: 100,
                        color: '#E91E63',
                        continuous: true
                    },
                    ice: {
                        cost: 80,
                        damage: 5,
                        range: 90,
                        fireRate: 800,
                        color: '#00BCD4',
                        slow: 0.5,
                        slowDuration: 2000
                    }
                };
                
                // æ•Œäººé…ç½®
                this.enemyTypes = {
                    basic: {
                        health: 50,
                        speed: 50,
                        reward: 15,
                        color: '#4CAF50'
                    },
                    fast: {
                        health: 30,
                        speed: 80,
                        reward: 20,
                        color: '#FFEB3B'
                    },
                    tank: {
                        health: 150,
                        speed: 30,
                        reward: 40,
                        color: '#795548'
                    },
                    boss: {
                        health: 300,
                        speed: 40,
                        reward: 100,
                        color: '#9C27B0'
                    }
                };
                
                // æ³¢æ¬¡é…ç½®
                this.waves = [
                    {enemies: [{type: 'basic', count: 5, interval: 1000}]},
                    {enemies: [{type: 'basic', count: 8, interval: 800}]},
                    {enemies: [{type: 'basic', count: 5, interval: 800}, {type: 'fast', count: 3, interval: 1200}]},
                    {enemies: [{type: 'basic', count: 10, interval: 600}, {type: 'fast', count: 5, interval: 800}]},
                    {enemies: [{type: 'tank', count: 2, interval: 2000}, {type: 'basic', count: 8, interval: 600}]},
                    {enemies: [{type: 'boss', count: 1, interval: 3000}, {type: 'fast', count: 8, interval: 800}]}
                ];
                
                // å½“å‰æ³¢æ¬¡çŠ¶æ€
                this.currentWave = null;
                this.waveInProgress = false;
                this.enemySpawnQueue = [];
                this.lastSpawnTime = 0;
                
                this.gameLoop = null;
                this.lastTime = 0;
                
                this.bindEvents();
            }
            
            bindEvents() {
                this.canvas.addEventListener('click', (e) => {
                    if (this.gameActive && !this.gamePaused) {
                        this.handleCanvasClick(e);
                    }
                });
                
                // é”®ç›˜å¿«æ·é”®
                document.addEventListener('keydown', (e) => {
                    if (e.key === ' ') {
                        e.preventDefault();
                        if (this.gameActive) {
                            this.pauseGame();
                        }
                    } else if (e.key >= '1' && e.key <= '4') {
                        const towers = ['basic', 'cannon', 'laser', 'ice'];
                        this.selectTower(towers[parseInt(e.key) - 1]);
                    }
                });
            }
            
            handleCanvasClick(e) {
                const rect = this.canvas.getBoundingClientRect();
                const x = e.clientX - rect.left;
                const y = e.clientY - rect.top;
                
                if (this.selectedTowerType) {
                    this.placeTower(x, y);
                }
            }
            
            selectTower(type) {
                if (!this.gameActive) return;
                
                const cost = this.towerTypes[type].cost;
                if (this.money < cost) return;
                
                // æ¸…é™¤ä¹‹å‰çš„é€‰æ‹©
                document.querySelectorAll('.tower-btn').forEach(btn => {
                    btn.classList.remove('selected');
                });
                
                // é€‰æ‹©æ–°å¡”
                this.selectedTowerType = type;
                document.getElementById(type + 'TowerBtn').classList.add('selected');
            }
            
            placeTower(x, y) {
                if (!this.selectedTowerType) return;
                
                const towerConfig = this.towerTypes[this.selectedTowerType];
                
                // æ£€æŸ¥æ˜¯å¦åœ¨è·¯å¾„ä¸Š
                if (this.isOnPath(x, y, 30)) return;
                
                // æ£€æŸ¥æ˜¯å¦ä¸å…¶ä»–å¡”é‡å 
                if (this.towers.some(tower => 
                    Math.hypot(tower.x - x, tower.y - y) < 60)) return;
                
                // æ£€æŸ¥é‡‘å¸
                if (this.money < towerConfig.cost) return;
                
                // åˆ›å»ºå¡”
                const tower = {
                    x: x,
                    y: y,
                    type: this.selectedTowerType,
                    ...towerConfig,
                    lastFire: 0,
                    target: null,
                    level: 1
                };
                
                this.towers.push(tower);
                this.money -= towerConfig.cost;
                this.towersBuilt++;
                
                // å–æ¶ˆé€‰æ‹©
                this.selectedTowerType = null;
                document.querySelectorAll('.tower-btn').forEach(btn => {
                    btn.classList.remove('selected');
                });
                
                this.updateDisplay();
            }
            
            isOnPath(x, y, radius = 25) {
                for (let i = 0; i < this.path.length - 1; i++) {
                    const start = this.path[i];
                    const end = this.path[i + 1];
                    
                    const distance = this.distanceToLineSegment(x, y, start.x, start.y, end.x, end.y);
                    if (distance < radius) return true;
                }
                return false;
            }
            
            distanceToLineSegment(px, py, x1, y1, x2, y2) {
                const A = px - x1;
                const B = py - y1;
                const C = x2 - x1;
                const D = y2 - y1;
                
                const dot = A * C + B * D;
                const lenSq = C * C + D * D;
                
                if (lenSq === 0) return Math.hypot(A, B);
                
                let t = Math.max(0, Math.min(1, dot / lenSq));
                
                const projX = x1 + t * C;
                const projY = y1 + t * D;
                
                return Math.hypot(px - projX, py - projY);
            }
            
            startGame() {
                this.gameActive = true;
                this.gamePaused = false;
                this.health = 100;
                this.money = 500;
                this.score = 0;
                this.kills = 0;
                this.wave = 0;
                this.towersBuilt = 0;
                
                this.towers = [];
                this.enemies = [];
                this.projectiles = [];
                this.selectedTowerType = null;
                
                this.waveInProgress = false;
                this.enemySpawnQueue = [];
                
                document.getElementById('startBtn').disabled = true;
                document.getElementById('waveBtn').disabled = false;
                document.getElementById('pauseBtn').disabled = false;
                
                this.updateDisplay();
                this.updateTowerButtons();
                this.startGameLoop();
            }
            
            startWave() {
                if (this.waveInProgress || this.wave >= this.waves.length) return;
                
                this.wave++;
                this.waveInProgress = true;
                
                const waveConfig = this.waves[this.wave - 1];
                this.enemySpawnQueue = [];
                
                // å‡†å¤‡æ•Œäººç”Ÿæˆé˜Ÿåˆ—
                waveConfig.enemies.forEach(enemyGroup => {
                    for (let i = 0; i < enemyGroup.count; i++) {
                        this.enemySpawnQueue.push({
                            type: enemyGroup.type,
                            spawnTime: Date.now() + i * enemyGroup.interval
                        });
                    }
                });
                
                // æŒ‰æ—¶é—´æ’åº
                this.enemySpawnQueue.sort((a, b) => a.spawnTime - b.spawnTime);
                
                document.getElementById('waveBtn').disabled = true;
                this.updateWaveDisplay();
            }
            
            pauseGame() {
                if (!this.gameActive) return;
                
                this.gamePaused = !this.gamePaused;
                const pauseBtn = document.getElementById('pauseBtn');
                
                if (this.gamePaused) {
                    pauseBtn.textContent = 'â–¶ï¸ ç»§ç»­';
                } else {
                    pauseBtn.textContent = 'â¸ï¸ æš‚åœ';
                }
            }
            
            resetGame() {
                this.gameActive = false;
                this.gamePaused = false;
                
                if (this.gameLoop) {
                    cancelAnimationFrame(this.gameLoop);
                    this.gameLoop = null;
                }
                
                document.getElementById('startBtn').disabled = false;
                document.getElementById('waveBtn').disabled = true;
                document.getElementById('pauseBtn').disabled = true;
                document.getElementById('pauseBtn').textContent = 'â¸ï¸ æš‚åœ';
                
                this.selectedTowerType = null;
                document.querySelectorAll('.tower-btn').forEach(btn => {
                    btn.classList.remove('selected');
                });
                
                this.updateDisplay();
                this.updateTowerButtons();
                this.updateWaveDisplay();
                this.draw();
            }
            
            startGameLoop() {
                const loop = (currentTime) => {
                    if (this.gameActive) {
                        const deltaTime = currentTime - this.lastTime;
                        this.lastTime = currentTime;
                        
                        if (!this.gamePaused) {
                            this.update(deltaTime);
                        }
                        this.draw();
                        
                        this.gameLoop = requestAnimationFrame(loop);
                    }
                };
                this.gameLoop = requestAnimationFrame(loop);
            }
            
            update(deltaTime) {
                this.spawnEnemies();
                this.updateEnemies(deltaTime);
                this.updateTowers(deltaTime);
                this.updateProjectiles(deltaTime);
                this.checkWaveComplete();
                this.checkGameOver();
            }
            
            spawnEnemies() {
                const now = Date.now();
                
                while (this.enemySpawnQueue.length > 0 && this.enemySpawnQueue[0].spawnTime <= now) {
                    const enemyData = this.enemySpawnQueue.shift();
                    const enemyConfig = this.enemyTypes[enemyData.type];
                    
                    const enemy = {
                        x: this.path[0].x,
                        y: this.path[0].y,
                        type: enemyData.type,
                        health: enemyConfig.health,
                        maxHealth: enemyConfig.health,
                        speed: enemyConfig.speed,
                        reward: enemyConfig.reward,
                        color: enemyConfig.color,
                        pathIndex: 0,
                        pathProgress: 0,
                        slowFactor: 1,
                        slowEnd: 0
                    };
                    
                    this.enemies.push(enemy);
                }
            }
            
            updateEnemies(deltaTime) {
                for (let i = this.enemies.length - 1; i >= 0; i--) {
                    const enemy = this.enemies[i];
                    
                    // æ›´æ–°å‡é€Ÿæ•ˆæœ
                    if (Date.now() > enemy.slowEnd) {
                        enemy.slowFactor = 1;
                    }
                    
                    // ç§»åŠ¨æ•Œäºº
                    this.moveEnemy(enemy, deltaTime);
                    
                    // æ£€æŸ¥æ˜¯å¦åˆ°è¾¾ç»ˆç‚¹
                    if (enemy.pathIndex >= this.path.length - 1) {
                        this.health -= 10;
                        this.enemies.splice(i, 1);
                        continue;
                    }
                    
                    // æ£€æŸ¥æ˜¯å¦æ­»äº¡
                    if (enemy.health <= 0) {
                        this.money += enemy.reward;
                        this.score += enemy.reward * 10;
                        this.kills++;
                        this.enemies.splice(i, 1);
                    }
                }
            }
            
            moveEnemy(enemy, deltaTime) {
                if (enemy.pathIndex >= this.path.length - 1) return;
                
                const currentPoint = this.path[enemy.pathIndex];
                const nextPoint = this.path[enemy.pathIndex + 1];
                
                const dx = nextPoint.x - currentPoint.x;
                const dy = nextPoint.y - currentPoint.y;
                const distance = Math.hypot(dx, dy);
                
                const moveDistance = (enemy.speed * enemy.slowFactor * deltaTime) / 1000;
                enemy.pathProgress += moveDistance / distance;
                
                if (enemy.pathProgress >= 1) {
                    enemy.pathIndex++;
                    enemy.pathProgress = 0;
                    if (enemy.pathIndex < this.path.length) {
                        enemy.x = this.path[enemy.pathIndex].x;
                        enemy.y = this.path[enemy.pathIndex].y;
                    }
                } else {
                    enemy.x = currentPoint.x + dx * enemy.pathProgress;
                    enemy.y = currentPoint.y + dy * enemy.pathProgress;
                }
            }
            
            updateTowers(deltaTime) {
                const now = Date.now();
                
                this.towers.forEach(tower => {
                    // å¯»æ‰¾ç›®æ ‡
                    if (!tower.target || tower.target.health <= 0 || 
                        Math.hypot(tower.x - tower.target.x, tower.y - tower.target.y) > tower.range) {
                        tower.target = this.findNearestEnemy(tower);
                    }
                    
                    // æ”»å‡»ç›®æ ‡
                    if (tower.target && now - tower.lastFire >= tower.fireRate) {
                        this.towerAttack(tower);
                        tower.lastFire = now;
                    }
                });
            }
            
            findNearestEnemy(tower) {
                let nearest = null;
                let minDistance = tower.range;
                
                this.enemies.forEach(enemy => {
                    const distance = Math.hypot(tower.x - enemy.x, tower.y - enemy.y);
                    if (distance < minDistance) {
                        minDistance = distance;
                        nearest = enemy;
                    }
                });
                
                return nearest;
            }
            
            towerAttack(tower) {
                if (!tower.target) return;
                
                if (tower.continuous) {
                    // æ¿€å…‰å¡”æŒç»­ä¼¤å®³
                    tower.target.health -= tower.damage;
                } else {
                    // å‘å°„å­å¼¹
                    const dx = tower.target.x - tower.x;
                    const dy = tower.target.y - tower.y;
                    const distance = Math.hypot(dx, dy);
                    
                    const projectile = {
                        x: tower.x,
                        y: tower.y,
                        dx: (dx / distance) * tower.projectileSpeed,
                        dy: (dy / distance) * tower.projectileSpeed,
                        damage: tower.damage,
                        splash: tower.splash,
                        slow: tower.slow,
                        slowDuration: tower.slowDuration,
                        color: tower.color,
                        target: tower.target
                    };
                    
                    this.projectiles.push(projectile);
                }
            }
            
            updateProjectiles(deltaTime) {
                for (let i = this.projectiles.length - 1; i >= 0; i--) {
                    const projectile = this.projectiles[i];
                    
                    projectile.x += (projectile.dx * deltaTime) / 1000;
                    projectile.y += (projectile.dy * deltaTime) / 1000;
                    
                    // æ£€æŸ¥ç¢°æ’
                    let hit = false;
                    this.enemies.forEach(enemy => {
                        const distance = Math.hypot(projectile.x - enemy.x, projectile.y - enemy.y);
                        if (distance < 15) {
                            // é€ æˆä¼¤å®³
                            enemy.health -= projectile.damage;
                            
                            // å‡é€Ÿæ•ˆæœ
                            if (projectile.slow) {
                                enemy.slowFactor = projectile.slow;
                                enemy.slowEnd = Date.now() + projectile.slowDuration;
                            }
                            
                            // æº…å°„ä¼¤å®³
                            if (projectile.splash) {
                                this.enemies.forEach(splashEnemy => {
                                    const splashDistance = Math.hypot(projectile.x - splashEnemy.x, projectile.y - splashEnemy.y);
                                    if (splashDistance < projectile.splash && splashDistance > 0) {
                                        splashEnemy.health -= projectile.damage * 0.5;
                                    }
                                });
                            }
                            
                            hit = true;
                        }
                    });
                    
                    // ç§»é™¤å‡»ä¸­çš„å­å¼¹æˆ–å‡ºç•Œçš„å­å¼¹
                    if (hit || projectile.x < 0 || projectile.x > this.canvas.width || 
                        projectile.y < 0 || projectile.y > this.canvas.height) {
                        this.projectiles.splice(i, 1);
                    }
                }
            }
            
            checkWaveComplete() {
                if (this.waveInProgress && this.enemies.length === 0 && this.enemySpawnQueue.length === 0) {
                    this.waveInProgress = false;
                    this.score += this.wave * 100;
                    this.money += 50;
                    
                    if (this.wave < this.waves.length) {
                        document.getElementById('waveBtn').disabled = false;
                    }
                    
                    this.updateWaveDisplay();
                }
            }
            
            checkGameOver() {
                if (this.health <= 0) {
                    this.endGame(false);
                } else if (this.wave >= this.waves.length && !this.waveInProgress) {
                    this.endGame(true);
                }
            }
            
            endGame(victory) {
                this.gameActive = false;
                
                if (this.gameLoop) {
                    cancelAnimationFrame(this.gameLoop);
                    this.gameLoop = null;
                }
                
                document.getElementById('startBtn').disabled = false;
                document.getElementById('waveBtn').disabled = true;
                document.getElementById('pauseBtn').disabled = true;
                
                this.showGameOver(victory);
            }
            
            showGameOver(victory) {
                document.getElementById('finalScore').textContent = this.score;
                document.getElementById('finalWave').textContent = this.wave;
                document.getElementById('finalKills').textContent = this.kills;
                document.getElementById('towersBuilt').textContent = this.towersBuilt;
                
                const title = document.getElementById('gameOverTitle');
                if (victory) {
                    title.textContent = 'ğŸ† èƒœåˆ©ï¼';
                } else if (this.wave >= 3) {
                    title.textContent = 'ğŸ‘ ä¸é”™çš„è¡¨ç°ï¼';
                } else {
                    title.textContent = 'ğŸ’¥ æ¸¸æˆç»“æŸ';
                }
                
                document.getElementById('gameOverPopup').classList.add('show');
            }
            
            closeGameOver() {
                document.getElementById('gameOverPopup').classList.remove('show');
            }
            
            updateDisplay() {
                document.getElementById('health').textContent = this.health;
                document.getElementById('money').textContent = this.money;
                document.getElementById('score').textContent = this.score;
                document.getElementById('kills').textContent = this.kills;
            }
            
            updateTowerButtons() {
                Object.keys(this.towerTypes).forEach(type => {
                    const btn = document.getElementById(type + 'TowerBtn');
                    const cost = this.towerTypes[type].cost;
                    
                    if (this.money < cost || !this.gameActive) {
                        btn.classList.add('disabled');
                    } else {
                        btn.classList.remove('disabled');
                    }
                });
            }
            
            updateWaveDisplay() {
                const waveText = document.getElementById('waveText');
                const waveProgress = document.getElementById('waveProgress');
                
                if (!this.gameActive) {
                    waveText.textContent = 'ç‚¹å‡»å¼€å§‹æ¸¸æˆ';
                    waveProgress.style.width = '0%';
                } else if (this.waveInProgress) {
                    const remaining = this.enemies.length + this.enemySpawnQueue.length;
                    const total = this.waves[this.wave - 1].enemies.reduce((sum, group) => sum + group.count, 0);
                    const progress = ((total - remaining) / total) * 100;
                    
                    waveText.textContent = `æ³¢æ¬¡ ${this.wave} - å‰©ä½™æ•Œäºº: ${remaining}`;
                    waveProgress.style.width = progress + '%';
                } else if (this.wave >= this.waves.length) {
                    waveText.textContent = 'æ‰€æœ‰æ³¢æ¬¡å®Œæˆï¼';
                    waveProgress.style.width = '100%';
                } else {
                    waveText.textContent = `å‡†å¤‡æ³¢æ¬¡ ${this.wave + 1}`;
                    waveProgress.style.width = '0%';
                }
            }
            
            draw() {
                // æ¸…ç©ºç”»å¸ƒ
                this.ctx.fillStyle = '#2E7D32';
                this.ctx.fillRect(0, 0, this.canvas.width, this.canvas.height);
                
                // ç»˜åˆ¶è·¯å¾„
                this.drawPath();
                
                // ç»˜åˆ¶å¡”çš„å°„ç¨‹ï¼ˆé€‰ä¸­å¡”æ—¶ï¼‰
                if (this.selectedTowerType) {
                    this.drawTowerRange();
                }
                
                // ç»˜åˆ¶å¡”
                this.drawTowers();
                
                // ç»˜åˆ¶æ•Œäºº
                this.drawEnemies();
                
                // ç»˜åˆ¶å­å¼¹
                this.drawProjectiles();
                
                // ç»˜åˆ¶æ¿€å…‰
                this.drawLasers();
            }
            
            drawPath() {
                this.ctx.strokeStyle = '#8BC34A';
                this.ctx.lineWidth = 40;
                this.ctx.lineCap = 'round';
                this.ctx.lineJoin = 'round';
                
                this.ctx.beginPath();
                this.ctx.moveTo(this.path[0].x, this.path[0].y);
                
                for (let i = 1; i < this.path.length; i++) {
                    this.ctx.lineTo(this.path[i].x, this.path[i].y);
                }
                
                this.ctx.stroke();
                
                // ç»˜åˆ¶èµ·ç‚¹å’Œç»ˆç‚¹
                this.ctx.fillStyle = '#4CAF50';
                this.ctx.beginPath();
                this.ctx.arc(this.path[0].x, this.path[0].y, 20, 0, Math.PI * 2);
                this.ctx.fill();
                
                this.ctx.fillStyle = '#F44336';
                this.ctx.beginPath();
                this.ctx.arc(this.path[this.path.length - 1].x, this.path[this.path.length - 1].y, 20, 0, Math.PI * 2);
                this.ctx.fill();
            }
            
            drawTowerRange() {
                // åœ¨é¼ æ ‡ä½ç½®ç»˜åˆ¶å°„ç¨‹é¢„è§ˆ
                this.canvas.addEventListener('mousemove', (e) => {
                    if (this.selectedTowerType && this.gameActive && !this.gamePaused) {
                        const rect = this.canvas.getBoundingClientRect();
                        const x = e.clientX - rect.left;
                        const y = e.clientY - rect.top;
                        
                        this.ctx.save();
                        this.ctx.globalAlpha = 0.3;
                        this.ctx.fillStyle = '#FFD54F';
                        this.ctx.beginPath();
                        this.ctx.arc(x, y, this.towerTypes[this.selectedTowerType].range, 0, Math.PI * 2);
                        this.ctx.fill();
                        this.ctx.restore();
                    }
                });
            }
            
            drawTowers() {
                this.towers.forEach(tower => {
                    // å¡”åŸºåº§
                    this.ctx.fillStyle = '#424242';
                    this.ctx.beginPath();
                    this.ctx.arc(tower.x, tower.y, 18, 0, Math.PI * 2);
                    this.ctx.fill();
                    
                    // å¡”ä¸»ä½“
                    this.ctx.fillStyle = tower.color;
                    this.ctx.beginPath();
                    this.ctx.arc(tower.x, tower.y, 12, 0, Math.PI * 2);
                    this.ctx.fill();
                    
                    // å°„ç¨‹æ˜¾ç¤ºï¼ˆé€‰ä¸­æ—¶ï¼‰
                    if (tower.target) {
                        this.ctx.save();
                        this.ctx.globalAlpha = 0.2;
                        this.ctx.strokeStyle = tower.color;
                        this.ctx.lineWidth = 2;
                        this.ctx.beginPath();
                        this.ctx.arc(tower.x, tower.y, tower.range, 0, Math.PI * 2);
                        this.ctx.stroke();
                        this.ctx.restore();
                    }
                });
            }
            
            drawEnemies() {
                this.enemies.forEach(enemy => {
                    // æ•Œäººä¸»ä½“
                    this.ctx.fillStyle = enemy.color;
                    this.ctx.beginPath();
                    this.ctx.arc(enemy.x, enemy.y, 12, 0, Math.PI * 2);
                    this.ctx.fill();
                    
                    // è¡€æ¡
                    const healthPercent = enemy.health / enemy.maxHealth;
                    this.ctx.fillStyle = '#424242';
                    this.ctx.fillRect(enemy.x - 15, enemy.y - 20, 30, 4);
                    
                    this.ctx.fillStyle = healthPercent > 0.5 ? '#4CAF50' : 
                                       healthPercent > 0.25 ? '#FF9800' : '#F44336';
                    this.ctx.fillRect(enemy.x - 15, enemy.y - 20, 30 * healthPercent, 4);
                });
            }
            
            drawProjectiles() {
                this.projectiles.forEach(projectile => {
                    this.ctx.fillStyle = projectile.color;
                    this.ctx.beginPath();
                    this.ctx.arc(projectile.x, projectile.y, 4, 0, Math.PI * 2);
                    this.ctx.fill();
                });
            }
            
            drawLasers() {
                this.towers.forEach(tower => {
                    if (tower.continuous && tower.target) {
                        this.ctx.strokeStyle = tower.color;
                        this.ctx.lineWidth = 3;
                        this.ctx.beginPath();
                        this.ctx.moveTo(tower.x, tower.y);
                        this.ctx.lineTo(tower.target.x, tower.target.y);
                        this.ctx.stroke();
                    }
                });
            }
            
            showHelp() {
                document.getElementById('helpPopup').classList.add('show');
            }
            
            closeHelp() {
                document.getElementById('helpPopup').classList.remove('show');
            }
        }

        // å…¨å±€å˜é‡
        let towerDefense;

        // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', () => {
            towerDefense = new TowerDefense();
            towerDefense.draw();
        });
    </script>
</body>
</html>