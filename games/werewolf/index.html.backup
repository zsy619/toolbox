<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç‹¼äººæ€ - é€»è¾‘æ¨ç†æ¸¸æˆ</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Microsoft YaHei', Arial, sans-serif;
            background: linear-gradient(135deg, #2c3e50 0%, #34495e 50%, #2c3e50 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }

        .game-container {
            background: white;
            border-radius: 20px;
            padding: 20px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.3);
            max-width: 1200px;
            width: 100%;
        }

        h1 {
            text-align: center;
            color: #2c3e50;
            margin-bottom: 20px;
            font-size: 2.5rem;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.1);
        }

        .game-info {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .info-card {
            background: #ecf0f1;
            padding: 15px;
            border-radius: 15px;
            text-align: center;
            border: 2px solid #bdc3c7;
        }

        .info-label {
            color: #2c3e50;
            font-size: 0.9rem;
            margin-bottom: 5px;
            font-weight: bold;
        }

        .info-value {
            color: #34495e;
            font-size: 1.2rem;
            font-weight: bold;
        }

        .controls {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        button {
            background: #3498db;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 25px;
            cursor: pointer;
            font-size: 1rem;
            font-weight: bold;
            transition: all 0.3s ease;
        }

        button:hover {
            background: #2980b9;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }

        button:disabled {
            background: #95a5a6;
            cursor: not-allowed;
            transform: none;
        }

        .btn-danger {
            background: #e74c3c;
        }

        .btn-danger:hover {
            background: #c0392b;
        }

        .btn-success {
            background: #27ae60;
        }

        .btn-success:hover {
            background: #229954;
        }

        .game-board {
            display: grid;
            grid-template-columns: 1fr 2fr 1fr;
            gap: 20px;
            margin: 20px 0;
            min-height: 600px;
        }

        .players-section {
            background: #ecf0f1;
            border-radius: 15px;
            padding: 15px;
            border: 2px solid #bdc3c7;
        }

        .section-title {
            text-align: center;
            color: #2c3e50;
            font-weight: bold;
            margin-bottom: 15px;
            font-size: 1.2rem;
        }

        .player-card {
            background: white;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 10px;
            border: 2px solid #ddd;
            transition: all 0.3s ease;
            cursor: pointer;
            position: relative;
        }

        .player-card:hover {
            transform: scale(1.02);
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }

        .player-card.current {
            border-color: #f39c12;
            background: #fef9e7;
        }

        .player-card.dead {
            opacity: 0.5;
            background: #f8f9fa;
            border-color: #95a5a6;
        }

        .player-card.werewolf {
            border-color: #e74c3c;
            background: #fdf2f2;
        }

        .player-card.villager {
            border-color: #27ae60;
            background: #f8fff8;
        }

        .player-card.seer {
            border-color: #8e44ad;
            background: #f8f4ff;
        }

        .player-card.doctor {
            border-color: #3498db;
            background: #f0f8ff;
        }

        .player-card.selected {
            border-color: #f39c12;
            background: #fff3cd;
            box-shadow: 0 0 10px rgba(243, 156, 18, 0.5);
        }

        .player-name {
            font-weight: bold;
            color: #2c3e50;
            margin-bottom: 8px;
            font-size: 1.1rem;
        }

        .player-role {
            font-size: 0.9rem;
            margin-bottom: 8px;
            padding: 4px 8px;
            border-radius: 12px;
            text-align: center;
            color: white;
            font-weight: bold;
        }

        .role-werewolf { background: #e74c3c; }
        .role-villager { background: #27ae60; }
        .role-seer { background: #8e44ad; }
        .role-doctor { background: #3498db; }
        .role-unknown { background: #95a5a6; }

        .player-status {
            font-size: 0.8rem;
            color: #7f8c8d;
            text-align: center;
        }

        .night-actions {
            background: #2c3e50;
            color: white;
            border-radius: 15px;
            padding: 20px;
            text-align: center;
        }

        .night-actions h3 {
            margin-bottom: 20px;
            color: #ecf0f1;
        }

        .action-buttons {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin-top: 20px;
        }

        .action-btn {
            background: #34495e;
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 10px;
            cursor: pointer;
            font-size: 1rem;
            transition: all 0.3s ease;
        }

        .action-btn:hover {
            background: #4a6741;
            transform: translateY(-1px);
        }

        .action-btn:disabled {
            background: #7f8c8d;
            cursor: not-allowed;
            transform: none;
        }

        .day-discussion {
            background: #f8f9fa;
            border-radius: 15px;
            padding: 20px;
            border: 2px solid #dee2e6;
        }

        .voting-section {
            margin-top: 20px;
        }

        .vote-buttons {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 8px;
            margin-top: 15px;
        }

        .vote-btn {
            background: #6c757d;
            color: white;
            border: none;
            padding: 8px 12px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: all 0.3s ease;
        }

        .vote-btn:hover {
            background: #5a6268;
        }

        .vote-btn.voted {
            background: #dc3545;
        }

        .game-log {
            background: #ecf0f1;
            border-radius: 15px;
            padding: 15px;
            border: 2px solid #bdc3c7;
            max-height: 400px;
            overflow-y: auto;
        }

        .log-entry {
            padding: 8px 0;
            border-bottom: 1px solid #d5dbdb;
            font-size: 0.9rem;
            color: #2c3e50;
        }

        .log-entry:last-child {
            border-bottom: none;
        }

        .log-entry.night {
            background: #2c3e50;
            color: white;
            padding: 8px;
            border-radius: 5px;
            margin: 5px 0;
        }

        .log-entry.day {
            background: #f8f9fa;
            padding: 8px;
            border-radius: 5px;
            margin: 5px 0;
        }

        .log-entry.important {
            background: #e74c3c;
            color: white;
            font-weight: bold;
            padding: 8px;
            border-radius: 5px;
            margin: 5px 0;
        }

        .phase-indicator {
            text-align: center;
            font-size: 1.5rem;
            font-weight: bold;
            padding: 15px;
            border-radius: 15px;
            margin-bottom: 20px;
        }

        .phase-night {
            background: #2c3e50;
            color: white;
        }

        .phase-day {
            background: #f39c12;
            color: white;
        }

        .winner-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.8);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .winner-content {
            background: white;
            padding: 40px;
            border-radius: 20px;
            text-align: center;
            animation: winnerPop 0.5s ease-out;
            border: 3px solid #2c3e50;
            max-width: 500px;
        }

        @keyframes winnerPop {
            0% { transform: scale(0.5); opacity: 0; }
            100% { transform: scale(1); opacity: 1; }
        }

        .role-reveal {
            background: #fff3cd;
            border: 2px solid #ffeaa7;
            border-radius: 10px;
            padding: 15px;
            margin: 10px 0;
            text-align: center;
        }

        .countdown {
            font-size: 2rem;
            font-weight: bold;
            color: #e74c3c;
            text-align: center;
            margin: 10px 0;
        }

        @media (max-width: 768px) {
            .game-container {
                padding: 15px;
            }
            
            h1 {
                font-size: 2rem;
            }
            
            .game-board {
                grid-template-columns: 1fr;
                gap: 15px;
            }
            
            .game-info {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .controls {
                gap: 8px;
            }
            
            button {
                padding: 10px 20px;
                font-size: 0.9rem;
            }
        }
    </style>
</head>
<body>
    <div class="game-container">
        <h1>ğŸº ç‹¼äººæ€ ğŸº</h1>
        
        <div class="game-info">
            <div class="info-card">
                <div class="info-label">æ¸¸æˆé˜¶æ®µ</div>
                <div class="info-value" id="currentPhase">ç­‰å¾…å¼€å§‹</div>
            </div>
            <div class="info-card">
                <div class="info-label">å¤©æ•°</div>
                <div class="info-value" id="dayCount">0</div>
            </div>
            <div class="info-card">
                <div class="info-label">å­˜æ´»äººæ•°</div>
                <div class="info-value" id="aliveCount">0</div>
            </div>
            <div class="info-card">
                <div class="info-label">ç‹¼äººæ•°é‡</div>
                <div class="info-value" id="werewolfCount">0</div>
            </div>
            <div class="info-card">
                <div class="info-label">æ‘æ°‘æ•°é‡</div>
                <div class="info-value" id="villagerCount">0</div>
            </div>
        </div>

        <div class="controls">
            <button id="newGameBtn" onclick="werewolfGame.newGame()">æ–°æ¸¸æˆ</button>
            <button id="nextPhaseBtn" onclick="werewolfGame.nextPhase()" disabled>ä¸‹ä¸€é˜¶æ®µ</button>
            <button id="rulesBtn" onclick="werewolfGame.showRules()">æ¸¸æˆè§„åˆ™</button>
            <button id="statsBtn" onclick="werewolfGame.showStats()">æ¸¸æˆç»Ÿè®¡</button>
        </div>

        <div class="phase-indicator" id="phaseIndicator">å‡†å¤‡å¼€å§‹æ¸¸æˆ</div>

        <div class="game-board">
            <div class="players-section">
                <div class="section-title">ç©å®¶åˆ—è¡¨</div>
                <div id="playersContainer"></div>
            </div>

            <div id="centerArea">
                <!-- å¤œæ™šè¡ŒåŠ¨åŒºåŸŸ -->
                <div class="night-actions" id="nightActions" style="display: none;">
                    <h3 id="nightTitle">å¤œæ™šé™ä¸´</h3>
                    <div id="nightInstructions">æ‰€æœ‰ç©å®¶è¯·é—­çœ¼</div>
                    <div class="action-buttons" id="nightActionBtns"></div>
                </div>

                <!-- ç™½å¤©è®¨è®ºåŒºåŸŸ -->
                <div class="day-discussion" id="dayDiscussion" style="display: none;">
                    <h3>ç™½å¤©è®¨è®º</h3>
                    <div id="dayInstructions">è¯·è®¨è®ºå¹¶æŠ•ç¥¨å†³å®šè¦æ·˜æ±°çš„ç©å®¶</div>
                    <div class="voting-section">
                        <h4>æŠ•ç¥¨æ·˜æ±°ï¼š</h4>
                        <div class="vote-buttons" id="voteButtons"></div>
                        <div id="voteResults" style="margin-top: 15px;"></div>
                    </div>
                    <div class="countdown" id="discussionTimer"></div>
                </div>

                <!-- è§’è‰²æ­ç¤ºåŒºåŸŸ -->
                <div class="role-reveal" id="roleReveal" style="display: none;">
                    <h3>ä½ çš„èº«ä»½</h3>
                    <div id="playerRole"></div>
                    <div id="roleDescription"></div>
                    <button onclick="werewolfGame.confirmRole()">ç¡®è®¤èº«ä»½</button>
                </div>
            </div>

            <div class="game-log">
                <div class="section-title">æ¸¸æˆæ—¥å¿—</div>
                <div id="gameLog"></div>
            </div>
        </div>
    </div>

    <div class="winner-modal" id="winnerModal">
        <div class="winner-content">
            <h2 id="winnerTitle">ğŸ‰ æ¸¸æˆç»“æŸ ğŸ‰</h2>
            <p id="winnerText"></p>
            <div id="finalRoles" style="margin: 20px 0;"></div>
            <button onclick="werewolfGame.closeWinnerModal()">å†æ¥ä¸€å±€</button>
        </div>
    </div>

    <script>
        class WerewolfGame {
            constructor() {
                this.players = [];
                this.currentPhase = 'waiting'; // waiting, night, day, voting, end
                this.dayCount = 0;
                this.gameStarted = false;
                this.nightActions = {};
                this.votes = {};
                this.discussionTime = 60; // è®¨è®ºæ—¶é—´(ç§’)
                this.timerInterval = null;
                
                this.roles = [
                    { name: 'werewolf', displayName: 'ç‹¼äºº', count: 2, description: 'å¤œæ™šå¯ä»¥æ€æ­»ä¸€åæ‘æ°‘ï¼Œç›®æ ‡æ˜¯æ€æ­»æ‰€æœ‰æ‘æ°‘' },
                    { name: 'seer', displayName: 'é¢„è¨€å®¶', count: 1, description: 'å¤œæ™šå¯ä»¥æŸ¥çœ‹ä¸€åç©å®¶çš„èº«ä»½' },
                    { name: 'doctor', displayName: 'åŒ»ç”Ÿ', count: 1, description: 'å¤œæ™šå¯ä»¥æ‹¯æ•‘ä¸€åç©å®¶ï¼ˆåŒ…æ‹¬è‡ªå·±ï¼‰' },
                    { name: 'villager', displayName: 'æ‘æ°‘', count: 4, description: 'ç™½å¤©å‚ä¸è®¨è®ºå’ŒæŠ•ç¥¨ï¼Œç›®æ ‡æ˜¯æ‰¾å‡ºæ‰€æœ‰ç‹¼äºº' }
                ];
                
                this.gameStats = JSON.parse(localStorage.getItem('werewolfStats') || '{}');
                
                this.init();
            }

            init() {
                this.updateDisplay();
                this.addLogEntry('ç‹¼äººæ€æ¸¸æˆå‡†å¤‡å°±ç»ªï¼Œç‚¹å‡»æ–°æ¸¸æˆå¼€å§‹');
            }

            newGame() {
                this.gameStarted = false;
                this.currentPhase = 'waiting';
                this.dayCount = 0;
                this.nightActions = {};
                this.votes = {};
                this.clearTimer();
                
                this.createPlayers();
                this.assignRoles();
                this.gameStarted = true;
                
                this.addLogEntry('æ–°æ¸¸æˆå¼€å§‹ï¼', 'important');
                this.revealPlayerRole();
                
                document.getElementById('winnerModal').style.display = 'none';
            }

            createPlayers() {
                this.players = [];
                const playerNames = ['ä½ ', 'è‰¾ä¸½å¨…', 'é²å‹ƒ', 'å¡æ‹‰', 'å¤§å«', 'ä¼Šå¨ƒ', 'å¼—å…°å…‹', 'æ ¼è•¾ä¸'];
                
                for (let i = 0; i < 8; i++) {
                    this.players.push({
                        id: i,
                        name: playerNames[i],
                        role: null,
                        alive: true,
                        isPlayer: i === 0, // ç¬¬ä¸€ä¸ªæ˜¯çœŸå®ç©å®¶
                        votes: 0,
                        votedFor: null
                    });
                }
            }

            assignRoles() {
                let rolePool = [];
                
                // æ ¹æ®è§’è‰²é…ç½®åˆ›å»ºè§’è‰²æ± 
                this.roles.forEach(roleConfig => {
                    for (let i = 0; i < roleConfig.count; i++) {
                        rolePool.push(roleConfig.name);
                    }
                });
                
                // æ‰“ä¹±è§’è‰²æ± 
                rolePool = this.shuffleArray(rolePool);
                
                // åˆ†é…è§’è‰²
                this.players.forEach((player, index) => {
                    player.role = rolePool[index];
                });
            }

            revealPlayerRole() {
                const player = this.players[0]; // ç©å®¶è‡ªå·±
                const roleConfig = this.roles.find(r => r.name === player.role);
                
                document.getElementById('playerRole').innerHTML = 
                    `<div class="player-role role-${player.role}">${roleConfig.displayName}</div>`;
                document.getElementById('roleDescription').textContent = roleConfig.description;
                
                document.getElementById('roleReveal').style.display = 'block';
                document.getElementById('nightActions').style.display = 'none';
                document.getElementById('dayDiscussion').style.display = 'none';
                
                this.updateDisplay();
            }

            confirmRole() {
                document.getElementById('roleReveal').style.display = 'none';
                this.currentPhase = 'night';
                this.dayCount = 1;
                this.startNightPhase();
            }

            startNightPhase() {
                this.currentPhase = 'night';
                this.nightActions = {};
                
                document.getElementById('nightActions').style.display = 'block';
                document.getElementById('dayDiscussion').style.display = 'none';
                
                this.addLogEntry(`ç¬¬${this.dayCount}å¤œå¼€å§‹ï¼Œæ‰€æœ‰ç©å®¶è¯·é—­çœ¼`, 'night');
                
                this.updateDisplay();
                this.performNightActions();
            }

            performNightActions() {
                const nightActionContainer = document.getElementById('nightActionBtns');
                nightActionContainer.innerHTML = '';
                
                const player = this.players[0];
                
                if (!player.alive) {
                    this.processNightActions();
                    return;
                }
                
                switch (player.role) {
                    case 'werewolf':
                        this.showWerewolfAction();
                        break;
                    case 'seer':
                        this.showSeerAction();
                        break;
                    case 'doctor':
                        this.showDoctorAction();
                        break;
                    default:
                        // æ™®é€šæ‘æ°‘åªèƒ½ç­‰å¾…
                        document.getElementById('nightInstructions').textContent = 'ä½ æ˜¯æ‘æ°‘ï¼Œå¤œæ™šè¯·å®‰é™ç­‰å¾…...';
                        setTimeout(() => this.processNightActions(), 3000);
                        break;
                }
            }

            showWerewolfAction() {
                document.getElementById('nightTitle').textContent = 'ç‹¼äººè¯·ççœ¼';
                document.getElementById('nightInstructions').textContent = 'é€‰æ‹©ä¸€åæ‘æ°‘æ€æ­»ï¼š';
                
                const alivePlayers = this.players.filter(p => p.alive && p.role !== 'werewolf');
                const actionContainer = document.getElementById('nightActionBtns');
                
                alivePlayers.forEach(player => {
                    const btn = document.createElement('button');
                    btn.className = 'action-btn';
                    btn.textContent = `æ€æ­» ${player.name}`;
                    btn.onclick = () => this.werewolfKill(player.id);
                    actionContainer.appendChild(btn);
                });
            }

            showSeerAction() {
                document.getElementById('nightTitle').textContent = 'é¢„è¨€å®¶è¯·ççœ¼';
                document.getElementById('nightInstructions').textContent = 'é€‰æ‹©ä¸€åç©å®¶æŸ¥çœ‹èº«ä»½ï¼š';
                
                const otherPlayers = this.players.filter(p => p.alive && p.id !== 0);
                const actionContainer = document.getElementById('nightActionBtns');
                
                otherPlayers.forEach(player => {
                    const btn = document.createElement('button');
                    btn.className = 'action-btn';
                    btn.textContent = `æŸ¥çœ‹ ${player.name}`;
                    btn.onclick = () => this.seerCheck(player.id);
                    actionContainer.appendChild(btn);
                });
            }

            showDoctorAction() {
                document.getElementById('nightTitle').textContent = 'åŒ»ç”Ÿè¯·ççœ¼';
                document.getElementById('nightInstructions').textContent = 'é€‰æ‹©ä¸€åç©å®¶æ•‘æ²»ï¼š';
                
                const alivePlayers = this.players.filter(p => p.alive);
                const actionContainer = document.getElementById('nightActionBtns');
                
                alivePlayers.forEach(player => {
                    const btn = document.createElement('button');
                    btn.className = 'action-btn';
                    btn.textContent = `æ•‘æ²» ${player.name}`;
                    btn.onclick = () => this.doctorSave(player.id);
                    actionContainer.appendChild(btn);
                });
            }

            werewolfKill(targetId) {
                this.nightActions.werewolfKill = targetId;
                this.addLogEntry('ç‹¼äººå·²é€‰æ‹©ç›®æ ‡');
                this.processNightActions();
            }

            seerCheck(targetId) {
                const target = this.players[targetId];
                const roleConfig = this.roles.find(r => r.name === target.role);
                
                this.nightActions.seerCheck = targetId;
                this.addLogEntry(`é¢„è¨€å®¶æŸ¥çœ‹ï¼š${target.name} æ˜¯ ${roleConfig.displayName}`);
                
                alert(`${target.name} çš„èº«ä»½æ˜¯ï¼š${roleConfig.displayName}`);
                this.processNightActions();
            }

            doctorSave(targetId) {
                this.nightActions.doctorSave = targetId;
                this.addLogEntry('åŒ»ç”Ÿå·²é€‰æ‹©æ•‘æ²»ç›®æ ‡');
                this.processNightActions();
            }

            processNightActions() {
                // AIç©å®¶æ‰§è¡Œå¤œé—´è¡ŒåŠ¨
                this.performAINightActions();
                
                // å¤„ç†å¤œé—´è¡ŒåŠ¨ç»“æœ
                let killedPlayer = null;
                
                if (this.nightActions.werewolfKill !== undefined) {
                    const targetId = this.nightActions.werewolfKill;
                    const savedId = this.nightActions.doctorSave;
                    
                    if (targetId !== savedId) {
                        killedPlayer = this.players[targetId];
                        killedPlayer.alive = false;
                    }
                }
                
                setTimeout(() => {
                    this.startDayPhase(killedPlayer);
                }, 2000);
            }

            performAINightActions() {
                const aliveWerewolves = this.players.filter(p => p.alive && p.role === 'werewolf' && !p.isPlayer);
                const aliveSeer = this.players.find(p => p.alive && p.role === 'seer' && !p.isPlayer);
                const aliveDoctor = this.players.find(p => p.alive && p.role === 'doctor' && !p.isPlayer);
                
                // AIç‹¼äººé€‰æ‹©å‡»æ€ç›®æ ‡
                if (aliveWerewolves.length > 0 && this.nightActions.werewolfKill === undefined) {
                    const targets = this.players.filter(p => p.alive && p.role !== 'werewolf');
                    if (targets.length > 0) {
                        const target = targets[Math.floor(Math.random() * targets.length)];
                        this.nightActions.werewolfKill = target.id;
                    }
                }
                
                // AIé¢„è¨€å®¶é€‰æ‹©æŸ¥çœ‹ç›®æ ‡
                if (aliveSeer && this.nightActions.seerCheck === undefined) {
                    const targets = this.players.filter(p => p.alive && p.id !== aliveSeer.id);
                    if (targets.length > 0) {
                        const target = targets[Math.floor(Math.random() * targets.length)];
                        this.nightActions.seerCheck = target.id;
                    }
                }
                
                // AIåŒ»ç”Ÿé€‰æ‹©æ•‘æ²»ç›®æ ‡
                if (aliveDoctor && this.nightActions.doctorSave === undefined) {
                    const targets = this.players.filter(p => p.alive);
                    if (targets.length > 0) {
                        const target = targets[Math.floor(Math.random() * targets.length)];
                        this.nightActions.doctorSave = target.id;
                    }
                }
            }

            startDayPhase(killedPlayer) {
                this.currentPhase = 'day';
                
                document.getElementById('nightActions').style.display = 'none';
                document.getElementById('dayDiscussion').style.display = 'block';
                
                if (killedPlayer) {
                    this.addLogEntry(`å¤©äº®äº†ï¼Œ${killedPlayer.name} æ˜¨å¤œè¢«ç‹¼äººæ€æ­»äº†`, 'important');
                } else {
                    this.addLogEntry('å¤©äº®äº†ï¼Œæ˜¨å¤œæ˜¯å¹³å®‰å¤œï¼Œæ²¡æœ‰äººæ­»äº¡', 'day');
                }
                
                // æ£€æŸ¥æ¸¸æˆç»“æŸæ¡ä»¶
                if (this.checkWinCondition()) {
                    return;
                }
                
                this.setupVoting();
                this.startDiscussionTimer();
                this.updateDisplay();
            }

            setupVoting() {
                this.votes = {};
                const voteContainer = document.getElementById('voteButtons');
                voteContainer.innerHTML = '';
                
                const alivePlayers = this.players.filter(p => p.alive);
                
                alivePlayers.forEach(player => {
                    const btn = document.createElement('button');
                    btn.className = 'vote-btn';
                    btn.textContent = player.name;
                    btn.onclick = () => this.vote(player.id);
                    voteContainer.appendChild(btn);
                });
                
                // æ·»åŠ è·³è¿‡æŠ•ç¥¨é€‰é¡¹
                const skipBtn = document.createElement('button');
                skipBtn.className = 'vote-btn';
                skipBtn.textContent = 'å¼ƒæƒ';
                skipBtn.onclick = () => this.vote(-1);
                voteContainer.appendChild(skipBtn);
            }

            vote(playerId) {
                if (this.votes[0] !== undefined) {
                    return; // å·²ç»æŠ•è¿‡ç¥¨äº†
                }
                
                this.votes[0] = playerId;
                
                // æ›´æ–°æŒ‰é’®æ ·å¼
                document.querySelectorAll('.vote-btn').forEach(btn => {
                    btn.classList.remove('voted');
                });
                
                if (playerId >= 0) {
                    const player = this.players[playerId];
                    event.target.classList.add('voted');
                    this.addLogEntry(`ä½ æŠ•ç¥¨ç»™äº† ${player.name}`);
                } else {
                    event.target.classList.add('voted');
                    this.addLogEntry('ä½ é€‰æ‹©äº†å¼ƒæƒ');
                }
                
                // AIæŠ•ç¥¨
                this.performAIVoting();
                
                // å¤„ç†æŠ•ç¥¨ç»“æœ
                setTimeout(() => this.processVotes(), 1000);
            }

            performAIVoting() {
                const alivePlayers = this.players.filter((p, index) => p.alive && index > 0);
                
                alivePlayers.forEach(player => {
                    if (this.votes[player.id] === undefined) {
                        const possibleTargets = this.players.filter(p => p.alive);
                        
                        let targetId;
                        if (player.role === 'werewolf') {
                            // ç‹¼äººå€¾å‘äºæŠ•ç¥¨ç»™éç‹¼äºº
                            const nonWerewolves = possibleTargets.filter(p => p.role !== 'werewolf');
                            targetId = nonWerewolves.length > 0 ? 
                                nonWerewolves[Math.floor(Math.random() * nonWerewolves.length)].id :
                                possibleTargets[Math.floor(Math.random() * possibleTargets.length)].id;
                        } else {
                            // å…¶ä»–è§’è‰²éšæœºæŠ•ç¥¨
                            if (Math.random() < 0.2) {
                                targetId = -1; // 20%æ¦‚ç‡å¼ƒæƒ
                            } else {
                                targetId = possibleTargets[Math.floor(Math.random() * possibleTargets.length)].id;
                            }
                        }
                        
                        this.votes[player.id] = targetId;
                    }
                });
            }

            processVotes() {
                const voteCount = {};
                let abstentions = 0;
                
                // ç»Ÿè®¡æŠ•ç¥¨
                Object.values(this.votes).forEach(vote => {
                    if (vote === -1) {
                        abstentions++;
                    } else {
                        voteCount[vote] = (voteCount[vote] || 0) + 1;
                    }
                });
                
                // æ˜¾ç¤ºæŠ•ç¥¨ç»“æœ
                let resultText = 'æŠ•ç¥¨ç»“æœï¼š\n';
                Object.entries(voteCount).forEach(([playerId, count]) => {
                    const player = this.players[playerId];
                    resultText += `${player.name}: ${count}ç¥¨\n`;
                });
                if (abstentions > 0) {
                    resultText += `å¼ƒæƒ: ${abstentions}ç¥¨\n`;
                }
                
                document.getElementById('voteResults').innerHTML = resultText.replace(/\n/g, '<br>');
                
                // æ‰¾å‡ºå¾—ç¥¨æœ€å¤šçš„ç©å®¶
                let maxVotes = 0;
                let eliminatedPlayers = [];
                
                Object.entries(voteCount).forEach(([playerId, count]) => {
                    if (count > maxVotes) {
                        maxVotes = count;
                        eliminatedPlayers = [parseInt(playerId)];
                    } else if (count === maxVotes) {
                        eliminatedPlayers.push(parseInt(playerId));
                    }
                });
                
                if (eliminatedPlayers.length === 1 && maxVotes > 0) {
                    const eliminatedPlayer = this.players[eliminatedPlayers[0]];
                    eliminatedPlayer.alive = false;
                    this.addLogEntry(`${eliminatedPlayer.name} è¢«æŠ•ç¥¨æ·˜æ±°äº†`, 'important');
                    
                    // æ­ç¤ºè¢«æ·˜æ±°ç©å®¶çš„èº«ä»½
                    const roleConfig = this.roles.find(r => r.name === eliminatedPlayer.role);
                    this.addLogEntry(`${eliminatedPlayer.name} çš„èº«ä»½æ˜¯ ${roleConfig.displayName}`, 'important');
                } else {
                    this.addLogEntry('æŠ•ç¥¨ç»“æœå¹³ç¥¨æˆ–æ— äººå¾—ç¥¨ï¼Œä»Šå¤©æ²¡æœ‰äººè¢«æ·˜æ±°', 'day');
                }
                
                // æ£€æŸ¥æ¸¸æˆç»“æŸæ¡ä»¶
                if (this.checkWinCondition()) {
                    return;
                }
                
                // å¼€å§‹ä¸‹ä¸€ä¸ªå¤œæ™š
                setTimeout(() => {
                    this.dayCount++;
                    this.startNightPhase();
                }, 3000);
            }

            startDiscussionTimer() {
                this.discussionTime = 60;
                this.updateTimer();
                
                this.timerInterval = setInterval(() => {
                    this.discussionTime--;
                    this.updateTimer();
                    
                    if (this.discussionTime <= 0) {
                        this.clearTimer();
                        // å¦‚æœè¿˜æ²¡æŠ•ç¥¨ï¼Œè‡ªåŠ¨å¼ƒæƒ
                        if (this.votes[0] === undefined) {
                            this.vote(-1);
                        }
                    }
                }, 1000);
            }

            updateTimer() {
                const timerElement = document.getElementById('discussionTimer');
                timerElement.textContent = `å‰©ä½™æ—¶é—´: ${this.discussionTime}ç§’`;
                
                if (this.discussionTime <= 10) {
                    timerElement.style.color = '#e74c3c';
                } else if (this.discussionTime <= 30) {
                    timerElement.style.color = '#f39c12';
                } else {
                    timerElement.style.color = '#27ae60';
                }
            }

            clearTimer() {
                if (this.timerInterval) {
                    clearInterval(this.timerInterval);
                    this.timerInterval = null;
                }
            }

            checkWinCondition() {
                const aliveWerewolves = this.players.filter(p => p.alive && p.role === 'werewolf').length;
                const aliveVillagers = this.players.filter(p => p.alive && p.role !== 'werewolf').length;
                
                if (aliveWerewolves === 0) {
                    this.endGame('villagers', 'æ‘æ°‘è·èƒœï¼æ‰€æœ‰ç‹¼äººéƒ½è¢«æ·˜æ±°äº†ï¼');
                    return true;
                } else if (aliveWerewolves >= aliveVillagers) {
                    this.endGame('werewolves', 'ç‹¼äººè·èƒœï¼ç‹¼äººæ•°é‡è¾¾åˆ°æˆ–è¶…è¿‡æ‘æ°‘ï¼');
                    return true;
                }
                
                return false;
            }

            endGame(winner, message) {
                this.gameStarted = false;
                this.clearTimer();
                
                // æ›´æ–°ç»Ÿè®¡
                if (!this.gameStats[winner]) {
                    this.gameStats[winner] = 0;
                }
                this.gameStats[winner]++;
                localStorage.setItem('werewolfStats', JSON.stringify(this.gameStats));
                
                // æ˜¾ç¤ºæ‰€æœ‰ç©å®¶çš„èº«ä»½
                let rolesText = 'æ‰€æœ‰ç©å®¶èº«ä»½ï¼š\n';
                this.players.forEach(player => {
                    const roleConfig = this.roles.find(r => r.name === player.role);
                    const status = player.alive ? 'å­˜æ´»' : 'æ­»äº¡';
                    rolesText += `${player.name}: ${roleConfig.displayName} (${status})\n`;
                });
                
                document.getElementById('winnerTitle').textContent = 'ğŸ‰ æ¸¸æˆç»“æŸ ğŸ‰';
                document.getElementById('winnerText').textContent = message;
                document.getElementById('finalRoles').innerHTML = rolesText.replace(/\n/g, '<br>');
                document.getElementById('winnerModal').style.display = 'flex';
                
                this.addLogEntry(message, 'important');
            }

            closeWinnerModal() {
                document.getElementById('winnerModal').style.display = 'none';
                this.newGame();
            }

            nextPhase() {
                // æ‰‹åŠ¨è¿›å…¥ä¸‹ä¸€é˜¶æ®µï¼ˆå¼€å‘ç”¨ï¼‰
                if (this.currentPhase === 'night') {
                    this.processNightActions();
                } else if (this.currentPhase === 'day') {
                    this.processVotes();
                }
            }

            showRules() {
                alert(`ç‹¼äººæ€æ¸¸æˆè§„åˆ™ï¼š

è§’è‰²ä»‹ç»ï¼š
â€¢ ç‹¼äºº(2äºº)ï¼šå¤œæ™šæ€æ­»æ‘æ°‘ï¼Œç›®æ ‡æ˜¯æ€æ­»æ‰€æœ‰æ‘æ°‘
â€¢ é¢„è¨€å®¶(1äºº)ï¼šå¤œæ™šå¯ä»¥æŸ¥çœ‹ä¸€åç©å®¶çš„èº«ä»½
â€¢ åŒ»ç”Ÿ(1äºº)ï¼šå¤œæ™šå¯ä»¥æ•‘æ²»ä¸€åç©å®¶
â€¢ æ‘æ°‘(4äºº)ï¼šç™½å¤©è®¨è®ºæŠ•ç¥¨ï¼Œç›®æ ‡æ˜¯æ‰¾å‡ºæ‰€æœ‰ç‹¼äºº

æ¸¸æˆæµç¨‹ï¼š
1. å¤œæ™šé˜¶æ®µï¼š
   - ç‹¼äººé€‰æ‹©æ€æ­»ä¸€åæ‘æ°‘
   - é¢„è¨€å®¶é€‰æ‹©æŸ¥çœ‹ä¸€åç©å®¶èº«ä»½
   - åŒ»ç”Ÿé€‰æ‹©æ•‘æ²»ä¸€åç©å®¶

2. ç™½å¤©é˜¶æ®µï¼š
   - å…¬å¸ƒå¤œæ™šæ­»äº¡æƒ…å†µ
   - æ‰€æœ‰ç©å®¶è®¨è®º(60ç§’)
   - æŠ•ç¥¨æ·˜æ±°ä¸€åç©å®¶
   - å…¬å¸ƒè¢«æ·˜æ±°ç©å®¶èº«ä»½

è·èƒœæ¡ä»¶ï¼š
â€¢ æ‘æ°‘èƒœåˆ©ï¼šæ·˜æ±°æ‰€æœ‰ç‹¼äºº
â€¢ ç‹¼äººèƒœåˆ©ï¼šç‹¼äººæ•°é‡â‰¥æ‘æ°‘æ•°é‡

æ¸¸æˆæŠ€å·§ï¼š
â€¢ è§‚å¯Ÿå…¶ä»–ç©å®¶çš„å‘è¨€å’ŒæŠ•ç¥¨è¡Œä¸º
â€¢ åˆç†åˆ©ç”¨èº«ä»½æŠ€èƒ½
â€¢ æ³¨æ„é€»è¾‘æ¨ç†å’Œä¿¡æ¯æ”¶é›†`);
            }

            showStats() {
                let statsText = 'æ¸¸æˆç»Ÿè®¡ï¼š\n\n';
                const teamNames = { 'villagers': 'æ‘æ°‘é˜µè¥', 'werewolves': 'ç‹¼äººé˜µè¥' };
                
                Object.entries(this.gameStats).forEach(([team, wins]) => {
                    statsText += `${teamNames[team] || team}ï¼š${wins}æ¬¡è·èƒœ\n`;
                });
                
                if (Object.keys(this.gameStats).length === 0) {
                    statsText += 'æš‚æ— ç»Ÿè®¡æ•°æ®';
                }
                
                alert(statsText);
            }

            updateDisplay() {
                const phaseNames = {
                    'waiting': 'ç­‰å¾…å¼€å§‹',
                    'night': 'å¤œæ™š',
                    'day': 'ç™½å¤©',
                    'voting': 'æŠ•ç¥¨',
                    'end': 'æ¸¸æˆç»“æŸ'
                };
                
                document.getElementById('currentPhase').textContent = phaseNames[this.currentPhase] || 'æœªçŸ¥';
                document.getElementById('dayCount').textContent = this.dayCount;
                
                const aliveCount = this.players.filter(p => p.alive).length;
                const werewolfCount = this.players.filter(p => p.alive && p.role === 'werewolf').length;
                const villagerCount = this.players.filter(p => p.alive && p.role !== 'werewolf').length;
                
                document.getElementById('aliveCount').textContent = aliveCount;
                document.getElementById('werewolfCount').textContent = werewolfCount;
                document.getElementById('villagerCount').textContent = villagerCount;
                
                // æ›´æ–°é˜¶æ®µæŒ‡ç¤ºå™¨
                const phaseIndicator = document.getElementById('phaseIndicator');
                if (this.currentPhase === 'night') {
                    phaseIndicator.className = 'phase-indicator phase-night';
                    phaseIndicator.textContent = `ç¬¬${this.dayCount}å¤œ - å¤œæ™šé™ä¸´`;
                } else if (this.currentPhase === 'day') {
                    phaseIndicator.className = 'phase-indicator phase-day';
                    phaseIndicator.textContent = `ç¬¬${this.dayCount}å¤© - ç™½å¤©è®¨è®º`;
                } else {
                    phaseIndicator.className = 'phase-indicator';
                    phaseIndicator.textContent = 'å‡†å¤‡å¼€å§‹æ¸¸æˆ';
                }
                
                // æ›´æ–°ç©å®¶åˆ—è¡¨
                this.updatePlayersDisplay();
                
                // æ›´æ–°æŒ‰é’®çŠ¶æ€
                document.getElementById('nextPhaseBtn').disabled = !this.gameStarted;
            }

            updatePlayersDisplay() {
                const container = document.getElementById('playersContainer');
                container.innerHTML = '';
                
                this.players.forEach((player, index) => {
                    const playerCard = document.createElement('div');
                    let cardClass = 'player-card';
                    
                    if (!player.alive) {
                        cardClass += ' dead';
                    }
                    
                    // åªæœ‰ç©å®¶è‡ªå·±æ‰èƒ½çœ‹åˆ°èº«ä»½
                    if (player.isPlayer && player.role) {
                        cardClass += ` ${player.role}`;
                    }
                    
                    playerCard.className = cardClass;
                    
                    let roleDisplay = 'æœªçŸ¥èº«ä»½';
                    if (player.isPlayer && player.role) {
                        const roleConfig = this.roles.find(r => r.name === player.role);
                        roleDisplay = roleConfig.displayName;
                    }
                    
                    playerCard.innerHTML = `
                        <div class="player-name">${player.name}</div>
                        <div class="player-role role-${player.role || 'unknown'}">${player.isPlayer ? roleDisplay : 'æœªçŸ¥èº«ä»½'}</div>
                        <div class="player-status">${player.alive ? 'å­˜æ´»' : 'æ­»äº¡'}</div>
                    `;
                    
                    container.appendChild(playerCard);
                });
            }

            addLogEntry(message, type = 'normal') {
                const logContainer = document.getElementById('gameLog');
                const logEntry = document.createElement('div');
                logEntry.className = `log-entry ${type}`;
                logEntry.textContent = `${new Date().toLocaleTimeString()}: ${message}`;
                
                logContainer.appendChild(logEntry);
                logContainer.scrollTop = logContainer.scrollHeight;
                
                // é™åˆ¶æ—¥å¿—æ¡ç›®æ•°é‡
                while (logContainer.children.length > 50) {
                    logContainer.removeChild(logContainer.firstChild);
                }
            }

            shuffleArray(array) {
                const shuffled = [...array];
                for (let i = shuffled.length - 1; i > 0; i--) {
                    const j = Math.floor(Math.random() * (i + 1));
                    [shuffled[i], shuffled[j]] = [shuffled[j], shuffled[i]];
                }
                return shuffled;
            }
        }

        // åˆå§‹åŒ–æ¸¸æˆ
        const werewolfGame = new WerewolfGame();
    </script>
</body>
</html>